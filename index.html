<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlashLearn - GCSE Revision</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f172a; font-family: system-ui, -apple-system, sans-serif; }
    input, textarea, select, button { font-family: inherit; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef, createContext, useContext } = React;

// Supabase
const SUPABASE_URL = 'https://bqtqmbyxdvinjbheykcc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_wH-eykJr8kFDMinN29bQyg_rrhqoqlP';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Auth Context
const AuthContext = createContext(null);
function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user ?? null); setLoading(false); });
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_e, session) => setUser(session?.user ?? null));
    return () => subscription.unsubscribe();
  }, []);
  const signUp = async (email, password) => { const { error } = await supabase.auth.signUp({ email, password }); return { error }; };
  const signIn = async (email, password) => { const { error } = await supabase.auth.signInWithPassword({ email, password }); return { error }; };
  const signOut = async () => { await supabase.auth.signOut(); };
  return <AuthContext.Provider value={{ user, loading, signUp, signIn, signOut }}>{children}</AuthContext.Provider>;
}
const useAuth = () => useContext(AuthContext);

// Helpers
const saveLocal = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} };
const loadLocal = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch(e) { return d; } };

// FOLDER STRUCTURE
const FOLDERS = [
  {
    id: 'gcse', name: 'GCSE', icon: 'ğŸ“', description: 'Complete GCSE revision',
    children: [
      { id: 'gcse-maths', name: 'Mathematics', icon: 'ğŸ“', deckIds: ['maths-number', 'maths-algebra', 'maths-geometry', 'maths-stats'] },
      { id: 'gcse-sciences', name: 'Sciences', icon: 'ğŸ”¬', children: [
        { id: 'gcse-biology', name: 'Biology', icon: 'ğŸ§¬', deckIds: ['bio-cells', 'bio-organisation', 'bio-infection', 'bio-bioenergetics', 'bio-homeostasis', 'bio-inheritance', 'bio-ecology'] },
        { id: 'gcse-chemistry', name: 'Chemistry', icon: 'âš—ï¸', deckIds: ['chem-atomic', 'chem-bonding', 'chem-quantitative', 'chem-changes', 'chem-energy', 'chem-rates', 'chem-organic', 'chem-analysis', 'chem-atmosphere'] },
        { id: 'gcse-physics', name: 'Physics', icon: 'âš¡', deckIds: ['phys-energy', 'phys-electricity', 'phys-particles', 'phys-atomic', 'phys-forces', 'phys-waves', 'phys-magnetism', 'phys-space'] }
      ]},
      { id: 'gcse-english', name: 'English', icon: 'ğŸ“š', children: [
        { id: 'gcse-eng-lit', name: 'Literature', icon: 'ğŸ“–', deckIds: ['lit-macbeth', 'lit-inspector', 'lit-christmas', 'lit-romeo', 'lit-poetry'] },
        { id: 'gcse-eng-lang', name: 'Language', icon: 'âœï¸', deckIds: ['lang-reading', 'lang-writing', 'lang-grammar', 'lang-devices'] }
      ]},
      { id: 'gcse-history', name: 'History', icon: 'ğŸ“œ', deckIds: ['hist-elizabethan', 'hist-nazi', 'hist-medicine', 'hist-coldwar'] },
      { id: 'gcse-dt', name: 'Design & Technology', icon: 'ğŸ”§', deckIds: ['dt-materials', 'dt-processes', 'dt-systems'] }
    ]
  },
  {
    id: 'finance', name: 'Finance', icon: 'ğŸ’°', description: 'Interview prep',
    deckIds: ['lbo', 'dcf', 'accounting']
  }
];

// DECK DATA - Starting with sample cards (will expand)
const DECKS = {
  // MATHS
  'maths-number': { id: 'maths-number', name: 'Number', icon: 'ğŸ”¢', cards: [
    { category: "Fractions", front: "How do you add fractions with different denominators?", back: "Find the lowest common denominator (LCD), convert each fraction to have this denominator, then add the numerators. Example: 1/4 + 1/3 = 3/12 + 4/12 = 7/12", source: "AQA GCSE Maths" },
    { category: "Percentages", front: "How do you find a percentage of an amount?", back: "Divide the percentage by 100 and multiply by the amount. Example: 15% of 80 = 0.15 Ã— 80 = 12. Alternatively, find 10% and 5% then add them.", source: "AQA GCSE Maths" },
    { category: "Ratios", front: "How do you share an amount in a given ratio?", back: "Add the ratio parts to find total parts. Divide the amount by total parts to find one part. Multiply by each ratio number. Example: Share Â£60 in ratio 2:3 â†’ 5 parts total, one part = Â£12, answer = Â£24:Â£36", source: "AQA GCSE Maths" },
    { category: "Standard Form", front: "What is standard form and when is it used?", back: "Standard form writes numbers as A Ã— 10â¿ where 1 â‰¤ A < 10. Used for very large or small numbers. Example: 45,000,000 = 4.5 Ã— 10â·, 0.00032 = 3.2 Ã— 10â»â´", source: "AQA GCSE Maths" },
    { category: "Surds", front: "How do you simplify surds?", back: "Find the largest square factor and take its root outside. âˆš50 = âˆš(25Ã—2) = 5âˆš2. To rationalise a denominator, multiply top and bottom by the surd: 1/âˆš3 = âˆš3/3", source: "AQA GCSE Maths" },
    { category: "HCF & LCM", front: "How do you find the HCF and LCM of two numbers?", back: "HCF: Find prime factors, multiply common factors. LCM: Multiply all prime factors at highest powers. Example: 12=2Â²Ã—3, 18=2Ã—3Â². HCF=2Ã—3=6, LCM=2Â²Ã—3Â²=36", source: "AQA GCSE Maths" },
    { category: "Indices", front: "What are the laws of indices?", back: "aáµ Ã— aâ¿ = aáµâºâ¿, aáµ Ã· aâ¿ = aáµâ»â¿, (aáµ)â¿ = aáµâ¿, aâ° = 1, aâ»â¿ = 1/aâ¿, a^(1/n) = â¿âˆša", source: "AQA GCSE Maths" },
    { category: "Bounds", front: "What are upper and lower bounds?", back: "For a measurement rounded to a given degree, lower bound is 0.5 units below, upper bound is 0.5 units above. Example: 3.4m to 1dp has bounds 3.35m â‰¤ x < 3.45m", source: "AQA GCSE Maths" }
  ]},
  'maths-algebra': { id: 'maths-algebra', name: 'Algebra', icon: 'ğŸ“Š', cards: [
    { category: "Equations", front: "How do you solve a linear equation?", back: "Isolate the variable by performing inverse operations on both sides. Example: 3x + 7 = 22 â†’ 3x = 15 â†’ x = 5. Always check by substituting back.", source: "AQA GCSE Maths" },
    { category: "Quadratics", front: "What are the three methods for solving quadratic equations?", back: "1) Factorising: xÂ² + 5x + 6 = 0 â†’ (x+2)(x+3) = 0 â†’ x = -2 or -3. 2) Quadratic formula: x = (-b Â± âˆš(bÂ²-4ac))/2a. 3) Completing the square.", source: "AQA GCSE Maths" },
    { category: "Quadratics", front: "What is the quadratic formula?", back: "For axÂ² + bx + c = 0, x = (-b Â± âˆš(bÂ²-4ac)) / 2a. The discriminant bÂ²-4ac tells us: >0 means 2 real roots, =0 means 1 repeated root, <0 means no real roots.", source: "AQA GCSE Maths" },
    { category: "Sequences", front: "How do you find the nth term of an arithmetic sequence?", back: "nth term = a + (n-1)d where a is the first term and d is the common difference. Example: 3, 7, 11, 15... has a=3, d=4, so nth term = 3 + 4(n-1) = 4n - 1", source: "AQA GCSE Maths" },
    { category: "Graphs", front: "What is the equation of a straight line?", back: "y = mx + c where m is the gradient and c is the y-intercept. Gradient = rise/run = (yâ‚‚-yâ‚)/(xâ‚‚-xâ‚). Parallel lines have equal gradients. Perpendicular lines have gradients that multiply to -1.", source: "AQA GCSE Maths" },
    { category: "Inequalities", front: "How do you solve and represent inequalities?", back: "Solve like equations but flip the sign when multiplying/dividing by negative. On a number line: open circle for < or >, filled circle for â‰¤ or â‰¥. Example: 2x - 3 > 5 â†’ x > 4", source: "AQA GCSE Maths" },
    { category: "Simultaneous", front: "How do you solve simultaneous equations?", back: "Elimination: Make coefficients equal, add/subtract to eliminate one variable. Substitution: Rearrange one equation, substitute into other. Example: x + y = 7, 2x - y = 2 â†’ add to get 3x = 9, x = 3, y = 4", source: "AQA GCSE Maths" },
    { category: "Functions", front: "What does fâ»Â¹(x) mean and how do you find it?", back: "fâ»Â¹(x) is the inverse function - it reverses what f(x) does. To find it: replace f(x) with y, swap x and y, rearrange for y. Example: f(x) = 2x + 3 â†’ y = 2x + 3 â†’ x = 2y + 3 â†’ fâ»Â¹(x) = (x-3)/2", source: "AQA GCSE Maths" }
  ]},
  'maths-geometry': { id: 'maths-geometry', name: 'Geometry', icon: 'ğŸ“', cards: [
    { category: "Angles", front: "What are the angle rules for parallel lines?", back: "Corresponding angles are equal (F-shape). Alternate angles are equal (Z-shape). Co-interior/allied angles sum to 180Â° (C-shape).", source: "AQA GCSE Maths" },
    { category: "Pythagoras", front: "State Pythagoras' theorem and when to use it.", back: "aÂ² + bÂ² = cÂ² where c is the hypotenuse. Use in right-angled triangles to find a missing side. To find hypotenuse: c = âˆš(aÂ² + bÂ²). To find shorter side: a = âˆš(cÂ² - bÂ²)", source: "AQA GCSE Maths" },
    { category: "Trigonometry", front: "What are SOHCAHTOA and when do you use each ratio?", back: "Sin = Opposite/Hypotenuse, Cos = Adjacent/Hypotenuse, Tan = Opposite/Adjacent. Use when you have a right-angled triangle with an angle. Label sides relative to the angle you're using.", source: "AQA GCSE Maths" },
    { category: "Circle Theorems", front: "State three key circle theorems.", back: "1) Angle at centre is twice angle at circumference. 2) Angle in a semicircle is 90Â°. 3) Angles in the same segment are equal. 4) Opposite angles in cyclic quadrilateral sum to 180Â°.", source: "AQA GCSE Maths" },
    { category: "Transformations", front: "Describe the four types of transformation.", back: "Rotation: needs centre, angle, direction. Reflection: needs mirror line equation. Translation: needs column vector. Enlargement: needs centre and scale factor (negative = invert through centre).", source: "AQA GCSE Maths" },
    { category: "Area", front: "What are the area formulas for common shapes?", back: "Triangle: Â½bh or Â½ab sinC. Parallelogram: bh. Trapezium: Â½(a+b)h. Circle: Ï€rÂ². Sector: (Î¸/360)Ï€rÂ². For composite shapes, split into known shapes.", source: "AQA GCSE Maths" },
    { category: "Volume", front: "What are the volume formulas for 3D shapes?", back: "Prism: cross-section area Ã— length. Cylinder: Ï€rÂ²h. Cone: â…“Ï€rÂ²h. Sphere: (4/3)Ï€rÂ³. Pyramid: â…“ Ã— base area Ã— height.", source: "AQA GCSE Maths" },
    { category: "Vectors", front: "How do you add and subtract vectors?", back: "Add/subtract corresponding components. If a = (2,3) and b = (4,1), then a + b = (6,4). The vector from A to B is b - a. Parallel vectors are scalar multiples of each other.", source: "AQA GCSE Maths" }
  ]},
  'maths-stats': { id: 'maths-stats', name: 'Statistics & Probability', icon: 'ğŸ“ˆ', cards: [
    { category: "Averages", front: "Define mean, median, mode and range.", back: "Mean: sum of values Ã· number of values. Median: middle value when ordered. Mode: most common value. Range: highest - lowest. For grouped data, use midpoints for mean.", source: "AQA GCSE Maths" },
    { category: "Probability", front: "How do you calculate probability?", back: "P(event) = favourable outcomes Ã· total outcomes. Probability is between 0 and 1. P(not A) = 1 - P(A). For independent events: P(A and B) = P(A) Ã— P(B).", source: "AQA GCSE Maths" },
    { category: "Tree Diagrams", front: "When and how do you use a tree diagram?", back: "Use for multi-stage probability problems. Each branch shows an outcome and its probability. Multiply along branches for 'and'. Add final probabilities for 'or'. Branches from same point sum to 1.", source: "AQA GCSE Maths" },
    { category: "Sampling", front: "What is the difference between random and stratified sampling?", back: "Random: every item has equal chance of selection. Stratified: sample proportionally from each group. Stratified formula: (group size Ã· population) Ã— sample size.", source: "AQA GCSE Maths" },
    { category: "Cumulative Frequency", front: "How do you draw and use a cumulative frequency graph?", back: "Plot cumulative totals against upper class boundaries. Join with smooth curve. Read median at n/2, LQ at n/4, UQ at 3n/4. IQR = UQ - LQ.", source: "AQA GCSE Maths" },
    { category: "Histograms", front: "How are histograms different from bar charts?", back: "Histograms have continuous data with no gaps. Frequency density = frequency Ã· class width. Area of bar represents frequency, not height. Bars can have different widths.", source: "AQA GCSE Maths" }
  ]},
  // BIOLOGY
  'bio-cells': { id: 'bio-cells', name: 'Cell Biology', icon: 'ğŸ”¬', cards: [
    { category: "Cell Structure", front: "What are the parts of an animal cell and their functions?", back: "Nucleus: contains DNA, controls cell. Cytoplasm: where reactions occur. Cell membrane: controls what enters/leaves. Mitochondria: aerobic respiration. Ribosomes: protein synthesis.", source: "AQA GCSE Biology" },
    { category: "Cell Structure", front: "What extra structures do plant cells have?", back: "Cell wall: made of cellulose, provides support. Vacuole: contains cell sap, maintains turgor. Chloroplasts: contain chlorophyll for photosynthesis. These are in addition to all animal cell parts.", source: "AQA GCSE Biology" },
    { category: "Microscopy", front: "How do you calculate magnification?", back: "Magnification = Image size Ã· Actual size. Rearrange to find any value. Convert units to be the same (usually Î¼m). 1mm = 1000Î¼m. Remember to use the formula triangle.", source: "AQA GCSE Biology" },
    { category: "Cell Division", front: "What happens during mitosis?", back: "Produces two identical diploid cells. Stages: DNA replicates, chromosomes line up, spindle fibres pull them apart, two nuclei form, cytoplasm divides. Used for growth, repair, and asexual reproduction.", source: "AQA GCSE Biology" },
    { category: "Cell Division", front: "What is the difference between mitosis and meiosis?", back: "Mitosis: 1 division, 2 identical diploid cells, for growth/repair. Meiosis: 2 divisions, 4 different haploid cells (gametes), introduces variation through crossing over and independent assortment.", source: "AQA GCSE Biology" },
    { category: "Transport", front: "Define diffusion, osmosis and active transport.", back: "Diffusion: net movement from high to low concentration. Osmosis: diffusion of water across partially permeable membrane. Active transport: movement against concentration gradient using energy from respiration.", source: "AQA GCSE Biology" },
    { category: "Specialised Cells", front: "How are sperm cells adapted for their function?", back: "Tail for swimming. Mitochondria for energy. Acrosome with enzymes to penetrate egg. Streamlined head. Haploid nucleus to combine with egg. Minimal cytoplasm to reduce weight.", source: "AQA GCSE Biology" },
    { category: "Stem Cells", front: "What are stem cells and why are they useful?", back: "Undifferentiated cells that can become specialised. Embryonic stem cells can become any cell type. Adult stem cells are more limited. Used to treat diseases like leukaemia. Ethical concerns about embryo use.", source: "AQA GCSE Biology" }
  ]},
  'bio-organisation': { id: 'bio-organisation', name: 'Organisation', icon: 'ğŸ«€', cards: [
    { category: "Organisation", front: "What is the hierarchy of organisation in organisms?", back: "Cells â†’ Tissues â†’ Organs â†’ Organ systems â†’ Organism. Cells are the basic unit. Tissues are groups of similar cells. Organs contain different tissues. Organ systems work together.", source: "AQA GCSE Biology" },
    { category: "Digestive System", front: "What are the functions of digestive enzymes?", back: "Amylase: starch â†’ maltose (mouth, pancreas). Protease: proteins â†’ amino acids (stomach, pancreas). Lipase: fats â†’ fatty acids + glycerol (pancreas). Bile emulsifies fats, neutralises stomach acid.", source: "AQA GCSE Biology" },
    { category: "Heart", front: "Describe the structure of the heart.", back: "4 chambers: right/left atria and ventricles. Right side pumps deoxygenated blood to lungs. Left side pumps oxygenated blood to body. Left ventricle has thicker wall. Valves prevent backflow.", source: "AQA GCSE Biology" },
    { category: "Blood", front: "What are the components of blood and their functions?", back: "Red blood cells: carry oxygen using haemoglobin, no nucleus, biconcave shape. White blood cells: fight infection. Platelets: blood clotting. Plasma: carries dissolved substances, heat, hormones.", source: "AQA GCSE Biology" },
    { category: "Blood Vessels", front: "Compare arteries, veins and capillaries.", back: "Arteries: thick muscular walls, small lumen, carry blood away from heart. Veins: thinner walls, larger lumen, have valves. Capillaries: one cell thick, allow diffusion, connect arteries to veins.", source: "AQA GCSE Biology" },
    { category: "Plants", front: "What is transpiration and what affects its rate?", back: "Loss of water vapour from leaves through stomata. Increased by: light, heat, wind, low humidity. Stomata controlled by guard cells. Water moves up xylem by transpiration stream.", source: "AQA GCSE Biology" },
    { category: "Plants", front: "Describe translocation in plants.", back: "Movement of dissolved sugars in phloem. From source (leaves) to sink (roots, growing tips). Requires energy. Phloem has sieve plates and companion cells. Can move up or down plant.", source: "AQA GCSE Biology" }
  ]},
  'bio-infection': { id: 'bio-infection', name: 'Infection & Response', icon: 'ğŸ¦ ', cards: [
    { category: "Pathogens", front: "What are the four types of pathogen?", back: "Bacteria: very small cells, produce toxins. Viruses: not alive, replicate inside cells, cause cell damage. Fungi: cause skin conditions. Protists: often spread by vectors like mosquitoes.", source: "AQA GCSE Biology" },
    { category: "Defence", front: "How does the body prevent pathogens entering?", back: "Skin: physical barrier. Nose: hairs and mucus trap particles. Trachea: cilia and mucus move pathogens up. Stomach: acid kills microorganisms. Eyes: tears contain lysozyme.", source: "AQA GCSE Biology" },
    { category: "Immune System", front: "How do white blood cells fight infection?", back: "Phagocytes: engulf and digest pathogens (phagocytosis). Lymphocytes: produce antibodies specific to antigens, produce antitoxins, memory cells give immunity.", source: "AQA GCSE Biology" },
    { category: "Vaccination", front: "How do vaccines work?", back: "Inject dead/inactive pathogens. White blood cells produce antibodies. Memory cells remain in blood. If real pathogen enters, rapid secondary response produces antibodies quickly. Provides immunity.", source: "AQA GCSE Biology" },
    { category: "Antibiotics", front: "Why can't antibiotics treat viral infections?", back: "Antibiotics kill bacteria by interfering with their processes. Viruses live inside host cells and use host machinery. Antibiotics cannot target viruses without damaging host cells. Antivirals needed for viruses.", source: "AQA GCSE Biology" },
    { category: "Drug Development", front: "What are the stages of drug testing?", back: "1) Lab testing on cells/tissues. 2) Animal testing for safety and efficacy. 3) Clinical trials: Phase 1 (healthy volunteers, safety), Phase 2 (small patient group), Phase 3 (large trials). Double-blind with placebo.", source: "AQA GCSE Biology" },
    { category: "Diseases", front: "Describe how HIV leads to AIDS.", back: "HIV is a virus spread through body fluids. Attacks immune system, destroying lymphocytes. AIDS is late-stage HIV where immune system fails. Opportunistic infections then become dangerous. Controlled with antiretroviral drugs.", source: "AQA GCSE Biology" }
  ]},
  'bio-bioenergetics': { id: 'bio-bioenergetics', name: 'Bioenergetics', icon: 'ğŸŒ¿', cards: [
    { category: "Photosynthesis", front: "What is the equation for photosynthesis?", back: "Carbon dioxide + water â†’ glucose + oxygen. 6COâ‚‚ + 6Hâ‚‚O â†’ Câ‚†Hâ‚â‚‚Oâ‚† + 6Oâ‚‚. Requires light energy absorbed by chlorophyll. Occurs in chloroplasts.", source: "AQA GCSE Biology" },
    { category: "Photosynthesis", front: "What are the limiting factors of photosynthesis?", back: "Light intensity: rate increases until plateau. COâ‚‚ concentration: rate increases until plateau. Temperature: increases rate to optimum then decreases (enzymes denature). Any factor can limit rate.", source: "AQA GCSE Biology" },
    { category: "Photosynthesis", front: "How is glucose used by plants?", back: "Respiration: releases energy. Stored as starch: insoluble, for later use. Cellulose: for cell walls. Proteins: combined with nitrates for growth. Lipids: stored in seeds.", source: "AQA GCSE Biology" },
    { category: "Respiration", front: "What are the equations for aerobic and anaerobic respiration?", back: "Aerobic: glucose + oxygen â†’ COâ‚‚ + water (+ energy). Câ‚†Hâ‚â‚‚Oâ‚† + 6Oâ‚‚ â†’ 6COâ‚‚ + 6Hâ‚‚O. Anaerobic in animals: glucose â†’ lactic acid. In plants/yeast: glucose â†’ ethanol + COâ‚‚.", source: "AQA GCSE Biology" },
    { category: "Respiration", front: "Why is aerobic respiration more efficient than anaerobic?", back: "Aerobic completely breaks down glucose, releasing more ATP (around 38). Anaerobic only partially breaks down glucose, producing less ATP (2) and waste products. Anaerobic is faster but less efficient.", source: "AQA GCSE Biology" },
    { category: "Exercise", front: "What happens during exercise and recovery?", back: "During: increased heart rate, breathing rate, anaerobic respiration produces lactic acid. After: oxygen debt repaid, lactic acid broken down, heart rate gradually returns to normal.", source: "AQA GCSE Biology" }
  ]},
  'bio-homeostasis': { id: 'bio-homeostasis', name: 'Homeostasis', icon: 'ğŸŒ¡ï¸', cards: [
    { category: "Homeostasis", front: "What is homeostasis and why is it important?", back: "Maintaining a constant internal environment. Important because cells need optimal conditions for enzyme activity. Involves receptors detecting change, coordination centre, effectors (muscles/glands) responding.", source: "AQA GCSE Biology" },
    { category: "Nervous System", front: "Describe the reflex arc.", back: "Stimulus â†’ receptor â†’ sensory neurone â†’ relay neurone (in CNS) â†’ motor neurone â†’ effector â†’ response. Reflexes are rapid, automatic, protective. Synapses transmit signals using neurotransmitters.", source: "AQA GCSE Biology" },
    { category: "Hormones", front: "How is blood glucose controlled?", back: "Pancreas monitors blood glucose. High glucose: pancreas releases insulin, liver converts glucose to glycogen. Low glucose: pancreas releases glucagon, liver converts glycogen to glucose. Diabetes: Type 1 (no insulin), Type 2 (insulin resistance).", source: "AQA GCSE Biology" },
    { category: "Hormones", front: "What hormones control the menstrual cycle?", back: "FSH: stimulates egg development and oestrogen production. Oestrogen: repairs uterus lining, stimulates LH. LH: triggers ovulation. Progesterone: maintains uterus lining. If no pregnancy, progesterone drops and period starts.", source: "AQA GCSE Biology" },
    { category: "Hormones", front: "How do hormonal and barrier contraceptives work?", back: "Hormonal: contain hormones to prevent ovulation (pill, implant, injection). Barrier: physically prevent sperm reaching egg (condom, diaphragm). Only condoms prevent STIs.", source: "AQA GCSE Biology" },
    { category: "Kidneys", front: "What are the three main functions of the kidney?", back: "1) Filter blood: removes urea, excess water, excess ions. 2) Reabsorb useful substances: glucose, some water, some ions. 3) Form urine: contains urea, excess water and ions.", source: "AQA GCSE Biology" },
    { category: "Temperature", front: "How does the body regulate temperature?", back: "Too hot: vasodilation (blood vessels widen), sweating, hairs lie flat. Too cold: vasoconstriction (vessels narrow), shivering, hairs stand up. Thermoregulatory centre in brain monitors blood temperature.", source: "AQA GCSE Biology" }
  ]},
  'bio-inheritance': { id: 'bio-inheritance', name: 'Inheritance & Evolution', icon: 'ğŸ§¬', cards: [
    { category: "Genetics", front: "Define these key genetic terms: gene, allele, genotype, phenotype.", back: "Gene: section of DNA coding for a protein. Allele: different version of a gene. Genotype: the alleles an organism has. Phenotype: observable characteristics. Dominant alleles are expressed when present, recessive only when homozygous.", source: "AQA GCSE Biology" },
    { category: "Genetics", front: "How do you complete a Punnett square?", back: "Write parent alleles on edges (one parent top, one side). Combine alleles in each box. Count offspring genotypes and phenotypes. Calculate ratios. For monohybrid cross, expect 3:1 phenotype ratio.", source: "AQA GCSE Biology" },
    { category: "DNA", front: "Describe the structure of DNA.", back: "Double helix made of two strands. Backbone of sugar-phosphate. Bases in middle: A-T, C-G pairs (complementary). Sequence of bases codes for amino acids. Three bases = one triplet codon = one amino acid.", source: "AQA GCSE Biology" },
    { category: "Inheritance", front: "What is sex determination in humans?", back: "XX = female, XY = male. Sex chromosomes determine gender. Father determines sex of offspring (sperm carries X or Y). 50% chance of each sex. Use Punnett square to show.", source: "AQA GCSE Biology" },
    { category: "Evolution", front: "Explain Darwin's theory of natural selection.", back: "Variation exists within species. Individuals compete for resources. Better adapted individuals more likely to survive and reproduce. Advantageous alleles passed to offspring. Over generations, species evolve.", source: "AQA GCSE Biology" },
    { category: "Evolution", front: "What evidence supports evolution?", back: "Fossils: show gradual changes over time. Antibiotic resistance: observed evolution. DNA analysis: similarities between species show common ancestors. Comparative anatomy: homologous structures.", source: "AQA GCSE Biology" },
    { category: "Classification", front: "What is the Linnaean classification system?", back: "Kingdom â†’ Phylum â†’ Class â†’ Order â†’ Family â†’ Genus â†’ Species. Based on structure and characteristics. Species defined as organisms that can produce fertile offspring. Binomial naming: Genus species.", source: "AQA GCSE Biology" }
  ]},
  'bio-ecology': { id: 'bio-ecology', name: 'Ecology', icon: 'ğŸŒ', cards: [
    { category: "Ecosystems", front: "Define community, ecosystem, and interdependence.", back: "Community: all organisms in an area. Ecosystem: community plus abiotic (non-living) factors. Interdependence: species depend on each other for food, shelter, pollination, seed dispersal, etc.", source: "AQA GCSE Biology" },
    { category: "Sampling", front: "How do you use quadrats to estimate population size?", back: "Place quadrats randomly. Count organisms in each quadrat. Calculate mean per quadrat. Multiply by total area Ã· quadrat area. Use transects for distribution across an area.", source: "AQA GCSE Biology" },
    { category: "Food Chains", front: "What do pyramids of biomass show?", back: "Mass of living material at each trophic level. Generally pyramid shaped as energy lost between levels. Only about 10% of biomass passed on. Energy lost through respiration, waste, uneaten parts.", source: "AQA GCSE Biology" },
    { category: "Cycles", front: "Describe the carbon cycle.", back: "COâ‚‚ absorbed by photosynthesis. Carbon passed through food chain. Returned to air by respiration, combustion, decomposition. Decomposers break down dead matter. Carbon stored in fossil fuels.", source: "AQA GCSE Biology" },
    { category: "Human Impact", front: "How do humans affect biodiversity?", back: "Habitat destruction: deforestation, development. Pollution: water, air, land. Global warming: climate change affects habitats. Overexploitation: overfishing, hunting. Introduction of invasive species.", source: "AQA GCSE Biology" },
    { category: "Conservation", front: "What methods help maintain biodiversity?", back: "Breeding programmes for endangered species. Seed banks preserve plant genes. Wildlife reserves protect habitats. Hedgerow and field margin restoration. Reducing deforestation and pollution.", source: "AQA GCSE Biology" }
  ]},
  // Continue with more decks...
  'lbo': { id: 'lbo', name: 'LBO Modeling', icon: 'ğŸ¦', cards: [
    { category: "LBO Basics", front: "What is a leveraged buyout?", back: "An acquisition of a company using a significant amount of borrowed money, typically 60 to 70 percent debt. Assets of the acquired company often serve as collateral. Goal is returns through debt paydown, EBITDA growth, and multiple expansion.", source: "Wall Street Prep" },
    { category: "LBO Basics", front: "What are the primary sources of returns in an LBO?", back: "Three main drivers: 1) Debt paydown using free cash flow. 2) EBITDA growth through revenue increases and margin expansion. 3) Multiple expansion if exit multiple exceeds entry. Debt paydown is most reliable.", source: "Wall Street Oasis" },
    { category: "Returns", front: "What is MOIC and how does it relate to IRR?", back: "MOIC = total value received Ã· total equity invested. A 2.0x means doubling your money. MOIC doesn't account for timing, IRR does. 2.5x over 3 years â‰ˆ 36% IRR, over 5 years â‰ˆ 20% IRR.", source: "Bain & Company" }
  ]},
  'dcf': { id: 'dcf', name: 'DCF Valuation', icon: 'ğŸ’°', cards: [
    { category: "DCF Basics", front: "Walk through the steps of a DCF.", back: "1) Project unlevered FCF for 5-10 years. 2) Calculate terminal value. 3) Discount all cash flows to present using WACC. 4) Sum PVs for enterprise value. 5) Subtract net debt for equity value. 6) Divide by shares.", source: "Wall Street Prep" },
    { category: "WACC", front: "How do you calculate WACC?", back: "WACC = (E/V Ã— Re) + (D/V Ã— Rd Ã— (1-T)). E = equity value, D = debt value, V = total. Re from CAPM. Rd is cost of debt. Tax shield makes debt cheaper.", source: "Brealey Myers" }
  ]},
  'accounting': { id: 'accounting', name: 'Accounting', icon: 'ğŸ“’', cards: [
    { category: "Statements", front: "What are the three main financial statements?", back: "Income statement: profitability over period. Balance sheet: assets, liabilities, equity at a point. Cash flow: cash movements. Net income flows to retained earnings and starts cash from operations.", source: "ASC" },
    { category: "Ratios", front: "What are key profitability ratios?", back: "Gross margin = GP/Revenue. Operating margin = EBIT/Revenue. Net margin = NI/Revenue. ROE = NI/Equity. ROA = NI/Assets. ROIC = NOPAT/Invested Capital.", source: "CFA Institute" }
  ]},
  // CHEMISTRY - Sample
  'chem-atomic': { id: 'chem-atomic', name: 'Atomic Structure', icon: 'âš›ï¸', cards: [
    { category: "Atoms", front: "What are the subatomic particles and their properties?", back: "Protons: mass 1, charge +1, in nucleus. Neutrons: mass 1, charge 0, in nucleus. Electrons: mass ~0, charge -1, in shells. Atomic number = protons. Mass number = protons + neutrons.", source: "AQA GCSE Chemistry" },
    { category: "Periodic Table", front: "How is the periodic table arranged?", back: "Rows = periods (electron shells). Columns = groups (outer electrons). Group 1 = alkali metals (1 outer eâ»). Group 7 = halogens (7 outer eâ»). Group 0 = noble gases (full outer shell).", source: "AQA GCSE Chemistry" },
    { category: "Electron Config", front: "How do you work out electron configuration?", back: "Fill shells from inside out. 1st shell: max 2. 2nd shell: max 8. 3rd shell: max 8 (for GCSE). Example: Sodium (11): 2,8,1. This determines chemical properties.", source: "AQA GCSE Chemistry" }
  ]},
  'chem-bonding': { id: 'chem-bonding', name: 'Bonding', icon: 'ğŸ”—', cards: [
    { category: "Ionic", front: "What is ionic bonding?", back: "Transfer of electrons between metal and non-metal. Metal loses electrons â†’ positive ion (cation). Non-metal gains electrons â†’ negative ion (anion). Strong electrostatic attraction between oppositely charged ions.", source: "AQA GCSE Chemistry" },
    { category: "Covalent", front: "What is covalent bonding?", back: "Sharing of electron pairs between non-metals. Each atom contributes electrons to shared pair. Single bond = 1 pair, double = 2 pairs. Can form simple molecules or giant covalent structures.", source: "AQA GCSE Chemistry" },
    { category: "Properties", front: "Compare properties of ionic and covalent compounds.", back: "Ionic: high MP/BP, conduct when molten/dissolved, form crystals. Simple covalent: low MP/BP, don't conduct, often gases/liquids. Giant covalent (diamond, graphite): very high MP, hard.", source: "AQA GCSE Chemistry" }
  ]},
  // PHYSICS - Sample
  'phys-energy': { id: 'phys-energy', name: 'Energy', icon: 'âš¡', cards: [
    { category: "Energy Stores", front: "What are the main energy stores?", back: "Kinetic: moving objects. Gravitational potential: raised objects. Elastic potential: stretched/compressed. Chemical: fuels, food, batteries. Thermal: hot objects. Nuclear: atoms. Magnetic. Electrostatic.", source: "AQA GCSE Physics" },
    { category: "Transfers", front: "How is energy transferred between stores?", back: "Mechanically (by forces). Electrically (by current). By heating. By radiation (light, sound). Energy is conserved - total stays same but spreads out. Dissipated energy is 'wasted' to surroundings.", source: "AQA GCSE Physics" },
    { category: "Efficiency", front: "How do you calculate efficiency?", back: "Efficiency = useful output Ã· total input Ã— 100%. Always less than 100% due to waste. Can reduce waste with lubrication, insulation, streamlining. Sankey diagrams show energy transfers.", source: "AQA GCSE Physics" }
  ]},
  'phys-electricity': { id: 'phys-electricity', name: 'Electricity', icon: 'ğŸ”Œ', cards: [
    { category: "Current", front: "What is electric current and how is it related to charge?", back: "Current is flow of charge (electrons in metals). I = Q/t (current = charge Ã· time). Measured in amps (A). Charge in coulombs (C). Conventional current flows from + to -.", source: "AQA GCSE Physics" },
    { category: "Circuits", front: "Compare series and parallel circuits.", back: "Series: one path, current same throughout, voltages add up. Parallel: multiple paths, current splits, voltage same across each branch. Total resistance: series add, parallel 1/R = 1/Râ‚ + 1/Râ‚‚.", source: "AQA GCSE Physics" },
    { category: "Ohm's Law", front: "State Ohm's Law and how to use it.", back: "V = IR (voltage = current Ã— resistance). Applies to ohmic conductors (constant temperature). Resistance in ohms (Î©). Rearrange to find any value. I-V graphs show relationship.", source: "AQA GCSE Physics" }
  ]},
  // ENGLISH LIT - Sample
  'lit-macbeth': { id: 'lit-macbeth', name: 'Macbeth', icon: 'ğŸ—¡ï¸', cards: [
    { category: "Context", front: "What historical context is important for Macbeth?", back: "Written 1606, shortly after Gunpowder Plot. James I was Scottish, believed in witches, wrote about them. Divine Right of Kings meant regicide was against God. Play flatters James - shows dangers of killing a king.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How is Macbeth presented as a tragic hero?", back: "Starts noble ('brave Macbeth'). Hamartia (fatal flaw) is ambition. Influenced by witches and Lady Macbeth. Makes choice to kill Duncan. Descends into tyranny. Dies fighting - some honour restored.", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How is the theme of ambition explored in Macbeth?", back: "Macbeth's 'vaulting ambition' leads to his downfall. Lady Macbeth's ambition makes her 'unsex' herself. Ambition corrupts - shown through imagery of disease and blood. Contrasted with Banquo who resists temptation.", source: "AQA GCSE English Lit" },
    { category: "Quotes", front: "Analyse: 'Look like th'innocent flower, But be the serpent under't'", back: "Lady Macbeth tells Macbeth to deceive Duncan. Flower = innocence, beauty. Serpent = evil, Biblical reference to Satan. Shows her manipulation and the theme of appearance vs reality. Imperative verbs show her control.", source: "AQA GCSE English Lit" }
  ]},
  'lit-inspector': { id: 'lit-inspector', name: 'An Inspector Calls', icon: 'ğŸ”', cards: [
    { category: "Context", front: "Why did Priestley set the play in 1912 but write it in 1945?", back: "1912: before WWI, Titanic sinking - audience knows characters' confidence is misplaced. 1945: after WWII, people wanted social change. Priestley wanted socialism, welfare state. Dramatic irony throughout.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How is Mr Birling presented and what does he represent?", back: "Capitalist businessman, pompous, wrong about everything. Represents older generation, selfishness, capitalism. 'A man has to mind his own business.' His predictions are dramatically ironic. Doesn't learn from Inspector.", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How does Priestley present social responsibility?", back: "Inspector's message: 'We are members of one body. We are responsible for each other.' Younger generation (Sheila, Eric) accept this. Older generation reject it. Priestley wants audience to agree with Inspector.", source: "AQA GCSE English Lit" }
  ]},
  // HISTORY - Sample
  'hist-elizabethan': { id: 'hist-elizabethan', name: 'Elizabethan England', icon: 'ğŸ‘‘', cards: [
    { category: "Challenges", front: "What challenges did Elizabeth face when she became queen?", back: "Gender: women seen as weak. Legitimacy: some thought she was illegitimate. Religion: Catholic vs Protestant divide. Marriage: pressure to marry and produce heir. Foreign threats: France, Spain. Succession: no named heir.", source: "AQA GCSE History" },
    { category: "Religion", front: "What was the Religious Settlement of 1559?", back: "Middle way between Catholics and Protestants. Act of Supremacy: Elizabeth = Supreme Governor. Act of Uniformity: new Book of Common Prayer. Clergy had to take oath of allegiance. Some Catholic elements kept (vestments).", source: "AQA GCSE History" },
    { category: "Mary Queen of Scots", front: "Why was Mary Queen of Scots a threat to Elizabeth?", back: "Catholic heir to English throne. Legitimate in Catholic eyes (Elizabeth was illegitimate). Fled to England 1568. Focus of Catholic plots (Ridolfi, Throckmorton, Babington). Executed 1587 after Babington Plot.", source: "AQA GCSE History" }
  ]},
  'hist-nazi': { id: 'hist-nazi', name: 'Nazi Germany', icon: 'ğŸ“œ', cards: [
    { category: "Rise", front: "How did Hitler become Chancellor in 1933?", back: "Depression created unemployment, discontent. Nazi vote rose: 37% July 1932. Hindenburg refused Hitler but couldn't find stable government. Von Papen convinced Hindenburg Nazis could be controlled. Hitler appointed 30 Jan 1933.", source: "AQA GCSE History" },
    { category: "Control", front: "How did the Nazis consolidate power in 1933-34?", back: "Reichstag Fire: blamed Communists, emergency decree. Enabling Act: Hitler could pass laws without Reichstag. Trade unions banned. Political parties banned. Night of Long Knives: SA leaders killed. Hindenburg died: Hitler became FÃ¼hrer.", source: "AQA GCSE History" },
    { category: "Terror", front: "How did the Nazis use terror to control Germany?", back: "SS: elite, ran concentration camps. Gestapo: secret police, encouraged informers. Concentration camps for 'enemies'. Block wardens spied on neighbourhoods. Fear of arrest kept people silent.", source: "AQA GCSE History" }
  ]},
  'hist-medicine': { id: 'hist-medicine', name: 'Medicine Through Time', icon: 'ğŸ¥', cards: [
    { category: "Medieval", front: "What did people believe caused disease in medieval times?", back: "Four humours (blood, phlegm, yellow bile, black bile) - needed balance. Miasma (bad air). God's punishment for sin. Astrology and alignment of planets. Some believed in supernatural causes.", source: "AQA GCSE History" },
    { category: "19th Century", front: "Why was Pasteur's Germ Theory (1861) so significant?", back: "Proved microorganisms cause decay (not spontaneous generation). Led to understanding germs cause disease. Koch identified specific bacteria. Allowed development of vaccines, antiseptics. Changed approach from symptoms to causes.", source: "AQA GCSE History" }
  ]},
  'hist-coldwar': { id: 'hist-coldwar', name: 'Cold War', icon: 'ğŸŒ', cards: [
    { category: "Origins", front: "Why did the Cold War begin after WWII?", back: "Ideological differences: capitalism vs communism. Soviet expansion in Eastern Europe. Atomic bomb ended cooperation. Truman Doctrine and Marshall Plan seen as aggressive. Iron Curtain divided Europe.", source: "AQA GCSE History" }
  ]},
  // D&T - Sample
  'dt-materials': { id: 'dt-materials', name: 'Materials', icon: 'ğŸªµ', cards: [
    { category: "Woods", front: "Compare hardwoods and softwoods.", back: "Hardwoods: from deciduous trees (oak, mahogany), slower growing, more expensive, often harder. Softwoods: from coniferous trees (pine, spruce), faster growing, cheaper, often softer. Names refer to tree type, not hardness.", source: "AQA GCSE DT" },
    { category: "Metals", front: "What are ferrous and non-ferrous metals?", back: "Ferrous: contain iron, magnetic, can rust. Examples: steel, cast iron. Non-ferrous: no iron, don't rust. Examples: aluminium, copper, brass, zinc. Alloys combine properties of different metals.", source: "AQA GCSE DT" },
    { category: "Polymers", front: "What is the difference between thermoplastics and thermosetting plastics?", back: "Thermoplastics: can be reheated and reshaped, recyclable. Examples: acrylic, PVC, polythene. Thermosetting: cannot be reshaped once set, heat resistant. Examples: epoxy resin, melamine.", source: "AQA GCSE DT" }
  ]},
  'dt-processes': { id: 'dt-processes', name: 'Processes', icon: 'âš™ï¸', cards: [
    { category: "Cutting", front: "What are the main cutting processes?", back: "Sawing: for wood and metal. Shearing: cutting sheet metal. Laser cutting: precise, computer controlled. Drilling: making holes. Milling: removing material with rotating cutter. Turning: on a lathe.", source: "AQA GCSE DT" }
  ]},
  'dt-systems': { id: 'dt-systems', name: 'Systems', icon: 'ğŸ”Œ', cards: [
    { category: "Electronics", front: "What are the parts of an electronic system?", back: "Input: sensors (LDR, thermistor, switch). Process: microcontroller, logic gates, comparators. Output: LED, motor, buzzer, speaker. Power supply provides energy. Signals can be analogue or digital.", source: "AQA GCSE DT" }
  ]},
  // Placeholders for remaining decks
  'chem-quantitative': { id: 'chem-quantitative', name: 'Quantitative Chemistry', icon: 'âš–ï¸', cards: [] },
  'chem-changes': { id: 'chem-changes', name: 'Chemical Changes', icon: 'ğŸ§ª', cards: [] },
  'chem-energy': { id: 'chem-energy', name: 'Energy Changes', icon: 'ğŸ”¥', cards: [] },
  'chem-rates': { id: 'chem-rates', name: 'Rates & Equilibrium', icon: 'â±ï¸', cards: [] },
  'chem-organic': { id: 'chem-organic', name: 'Organic Chemistry', icon: 'ğŸ›¢ï¸', cards: [] },
  'chem-analysis': { id: 'chem-analysis', name: 'Chemical Analysis', icon: 'ğŸ”¬', cards: [] },
  'chem-atmosphere': { id: 'chem-atmosphere', name: 'Atmosphere', icon: 'ğŸŒ«ï¸', cards: [] },
  'phys-particles': { id: 'phys-particles', name: 'Particle Model', icon: 'ğŸ’¨', cards: [] },
  'phys-atomic': { id: 'phys-atomic', name: 'Atomic Structure', icon: 'â˜¢ï¸', cards: [] },
  'phys-forces': { id: 'phys-forces', name: 'Forces', icon: 'â¡ï¸', cards: [] },
  'phys-waves': { id: 'phys-waves', name: 'Waves', icon: 'ğŸŒŠ', cards: [] },
  'phys-magnetism': { id: 'phys-magnetism', name: 'Magnetism', icon: 'ğŸ§²', cards: [] },
  'phys-space': { id: 'phys-space', name: 'Space', icon: 'ğŸš€', cards: [] },
  'lit-christmas': { id: 'lit-christmas', name: 'A Christmas Carol', icon: 'ğŸ‘»', cards: [] },
  'lit-romeo': { id: 'lit-romeo', name: 'Romeo & Juliet', icon: 'ğŸ’”', cards: [] },
  'lit-poetry': { id: 'lit-poetry', name: 'Poetry Anthology', icon: 'ğŸ“', cards: [] },
  'lang-reading': { id: 'lang-reading', name: 'Reading Skills', icon: 'ğŸ“–', cards: [] },
  'lang-writing': { id: 'lang-writing', name: 'Writing Techniques', icon: 'âœï¸', cards: [] },
  'lang-grammar': { id: 'lang-grammar', name: 'Grammar', icon: 'ğŸ“š', cards: [] },
  'lang-devices': { id: 'lang-devices', name: 'Literary Devices', icon: 'ğŸ­', cards: [] },
};

// Get all decks for a folder recursively
const getDecksForFolder = (folder) => {
  let decks = [];
  if (folder.deckIds) {
    decks = folder.deckIds.map(id => DECKS[id]).filter(d => d);
  }
  if (folder.children) {
    folder.children.forEach(child => {
      decks = [...decks, ...getDecksForFolder(child)];
    });
  }
  return decks;
};

// Calculate folder progress
const getFolderProgress = (folder) => {
  const decks = getDecksForFolder(folder);
  let totalCards = 0, knownCards = 0;
  decks.forEach(deck => {
    if (deck.cards && deck.cards.length > 0) {
      totalCards += deck.cards.length;
      const progress = loadLocal(`progress_${deck.id}`, {});
      knownCards += Object.values(progress).filter(v => v === 'known').length;
    }
  });
  return { known: knownCards, total: totalCards, percent: totalCards > 0 ? Math.round((knownCards / totalCards) * 100) : 0 };
};

// STREAK SYSTEM
const getStreakData = () => loadLocal('streakData', { current: 0, lastStudy: null, dailyGoal: 20, todayCards: 0 });
const saveStreakData = (data) => saveLocal('streakData', data);

// EXAM COUNTDOWN
const getExams = () => loadLocal('exams', []);
const saveExams = (exams) => saveLocal('exams', exams);

// APP
function App() {
  const { user, loading } = useAuth();
  const [view, setView] = useState('home');
  const [path, setPath] = useState([]);
  const [activeDeck, setActiveDeck] = useState(null);
  const [openaiKey, setOpenaiKey] = useState(() => loadLocal('openai_api_key', ''));
  const [streakData, setStreakData] = useState(getStreakData);

  if (loading) {
    return <div style={{ minHeight: '100vh', background: '#0f172a', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><div style={{ color: '#60a5fa', fontSize: '18px' }}>Loading...</div></div>;
  }

  if (view === 'auth') return <AuthScreen setView={setView} />;
  if (view === 'study') return <Study deck={activeDeck} setView={setView} streakData={streakData} setStreakData={setStreakData} />;
  if (view === 'quiz') return <QuizMode deck={activeDeck} setView={setView} />;
  if (view === 'create') return <CreateDeck setView={setView} openaiKey={openaiKey} user={user} />;
  if (view === 'exams') return <ExamCountdown setView={setView} />;

  return <Home path={path} setPath={setPath} setActiveDeck={setActiveDeck} setView={setView} user={user} openaiKey={openaiKey} streakData={streakData} />;
}

// HOME WITH FOLDERS
function Home({ path, setPath, setActiveDeck, setView, user, openaiKey, streakData }) {
  const { signOut } = useAuth();
  const [showApiModal, setShowApiModal] = useState(false);

  // Get current folder based on path
  const getCurrentFolder = () => {
    if (path.length === 0) return null;
    let folder = FOLDERS.find(f => f.id === path[0]);
    for (let i = 1; i < path.length; i++) {
      if (folder && folder.children) {
        folder = folder.children.find(f => f.id === path[i]);
      }
    }
    return folder;
  };

  const currentFolder = getCurrentFolder();
  const items = currentFolder
    ? [...(currentFolder.children || []), ...(currentFolder.deckIds || []).map(id => ({ ...DECKS[id], type: 'deck' }))]
    : FOLDERS;

  const navigateToFolder = (folder) => {
    setPath([...path, folder.id]);
  };

  const navigateUp = () => {
    setPath(path.slice(0, -1));
  };

  const openDeck = (deck) => {
    setActiveDeck(deck);
    setView('study');
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px', fontFamily: 'system-ui' }}>
      {showApiModal && <ApiKeyModal openaiKey={openaiKey} onClose={() => setShowApiModal(false)} />}

      <div style={{ maxWidth: '600px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
          <div>
            <h1 style={{ fontSize: '24px', fontWeight: 700, color: '#60a5fa', marginBottom: '4px' }}>FlashLearn</h1>
            <p style={{ color: '#64748b', fontSize: '13px' }}>{user ? `Welcome back` : 'GCSE Revision Made Easy'}</p>
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            {user ? (
              <button onClick={signOut} style={{ padding: '8px 12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '12px', cursor: 'pointer' }}>Sign Out</button>
            ) : (
              <button onClick={() => setView('auth')} style={{ padding: '8px 12px', borderRadius: '8px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '12px', fontWeight: 600, cursor: 'pointer' }}>Sign In</button>
            )}
          </div>
        </div>

        {/* Streak Banner */}
        <div style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', borderRadius: '12px', padding: '16px', marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div>
            <div style={{ fontSize: '24px', marginBottom: '4px' }}>ğŸ”¥ {streakData.current} day streak</div>
            <div style={{ color: 'rgba(255,255,255,0.8)', fontSize: '13px' }}>{streakData.todayCards}/{streakData.dailyGoal} cards today</div>
          </div>
          <button onClick={() => setView('exams')} style={{ padding: '10px 16px', borderRadius: '8px', background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white', fontSize: '13px', cursor: 'pointer' }}>ğŸ“… Exams</button>
        </div>

        {/* Breadcrumb */}
        {path.length > 0 && (
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '16px', flexWrap: 'wrap' }}>
            <button onClick={() => setPath([])} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer', fontSize: '14px' }}>Home</button>
            {path.map((id, i) => {
              const folder = i === 0 ? FOLDERS.find(f => f.id === id) : null; // Simplified
              return (
                <span key={id} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ color: '#64748b' }}>â€º</span>
                  <button onClick={() => setPath(path.slice(0, i + 1))} style={{ background: 'none', border: 'none', color: i === path.length - 1 ? '#f1f5f9' : '#60a5fa', cursor: 'pointer', fontSize: '14px' }}>{id.split('-').pop()}</button>
                </span>
              );
            })}
          </div>
        )}

        {/* Back button */}
        {path.length > 0 && (
          <button onClick={navigateUp} style={{ display: 'flex', alignItems: 'center', gap: '8px', background: 'rgba(255,255,255,0.05)', border: 'none', borderRadius: '10px', padding: '12px 16px', color: '#94a3b8', fontSize: '14px', cursor: 'pointer', marginBottom: '16px' }}>
            â† Back
          </button>
        )}

        {/* Quick Actions */}
        {path.length === 0 && (
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '20px' }}>
            <button onClick={() => user ? setView('create') : setShowApiModal(true)} style={{ padding: '16px', borderRadius: '12px', border: '2px dashed rgba(96,165,250,0.5)', background: 'rgba(59,130,246,0.1)', color: '#60a5fa', fontSize: '14px', fontWeight: 600, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              âœ¨ Create with AI
            </button>
            <button onClick={() => setView('exams')} style={{ padding: '16px', borderRadius: '12px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(30,41,59,0.5)', color: '#94a3b8', fontSize: '14px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              ğŸ“… Exam Countdown
            </button>
          </div>
        )}

        {/* Folder/Deck Grid */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {items.map(item => {
            const isDeck = item.type === 'deck' || item.cards;
            if (isDeck) {
              const deck = item;
              if (!deck.cards || deck.cards.length === 0) return null; // Hide empty decks
              const progress = loadLocal(`progress_${deck.id}`, {});
              const known = Object.values(progress).filter(v => v === 'known').length;
              const percent = Math.round((known / deck.cards.length) * 100);
              return (
                <div key={deck.id} onClick={() => openDeck(deck)} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '16px', cursor: 'pointer', border: '1px solid rgba(100,116,139,0.2)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '28px' }}>{deck.icon}</span>
                    <div style={{ flex: 1 }}>
                      <div style={{ color: '#f1f5f9', fontSize: '16px', fontWeight: 500 }}>{deck.name}</div>
                      <div style={{ color: '#64748b', fontSize: '12px' }}>{deck.cards.length} cards</div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ color: percent === 100 ? '#10b981' : '#60a5fa', fontSize: '14px', fontWeight: 600 }}>{percent}%</div>
                    </div>
                  </div>
                  <div style={{ marginTop: '8px', height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px' }}>
                    <div style={{ width: `${percent}%`, height: '100%', background: percent === 100 ? '#10b981' : '#3b82f6', borderRadius: '2px' }}></div>
                  </div>
                </div>
              );
            } else {
              const folder = item;
              const prog = getFolderProgress(folder);
              return (
                <div key={folder.id} onClick={() => navigateToFolder(folder)} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '16px', cursor: 'pointer', border: '1px solid rgba(100,116,139,0.2)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '32px' }}>{folder.icon}</span>
                    <div style={{ flex: 1 }}>
                      <div style={{ color: '#f1f5f9', fontSize: '16px', fontWeight: 500 }}>{folder.name}</div>
                      <div style={{ color: '#64748b', fontSize: '12px' }}>{folder.description || `${folder.children?.length || 0} folders, ${folder.deckIds?.length || 0} decks`}</div>
                    </div>
                    {prog.total > 0 && (
                      <div style={{ textAlign: 'right' }}>
                        <div style={{ color: prog.percent === 100 ? '#10b981' : '#60a5fa', fontSize: '14px', fontWeight: 600 }}>{prog.percent}%</div>
                        <div style={{ color: '#64748b', fontSize: '11px' }}>{prog.known}/{prog.total}</div>
                      </div>
                    )}
                    <span style={{ color: '#64748b' }}>â€º</span>
                  </div>
                </div>
              );
            }
          })}
        </div>

        <p style={{ textAlign: 'center', color: '#4b5563', fontSize: '11px', marginTop: '24px' }}>ğŸ§ All decks support hands-free learning with TTS</p>
      </div>
    </div>
  );
}

// AUTH SCREEN (compact)
function AuthScreen({ setView }) {
  const { signIn, signUp } = useAuth();
  const [isSignUp, setIsSignUp] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    const { error } = isSignUp ? await signUp(email, password) : await signIn(email, password);
    setLoading(false);
    if (error) setError(error.message);
    else setView('home');
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
      <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '16px', padding: '32px', maxWidth: '360px', width: '100%' }}>
        <h1 style={{ color: '#60a5fa', fontSize: '24px', textAlign: 'center', marginBottom: '24px' }}>FlashLearn</h1>
        <form onSubmit={handleSubmit}>
          <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} required />
          <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} required minLength={6} />
          {error && <p style={{ color: '#ef4444', fontSize: '13px', marginBottom: '12px' }}>{error}</p>}
          <button type="submit" disabled={loading} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: 600, cursor: 'pointer' }}>{loading ? '...' : (isSignUp ? 'Sign Up' : 'Sign In')}</button>
        </form>
        <p style={{ color: '#94a3b8', textAlign: 'center', marginTop: '16px', fontSize: '13px' }}>
          <button onClick={() => setIsSignUp(!isSignUp)} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer' }}>{isSignUp ? 'Have an account? Sign In' : 'Need an account? Sign Up'}</button>
        </p>
        <button onClick={() => setView('home')} style={{ width: '100%', marginTop: '12px', padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#64748b', fontSize: '13px', cursor: 'pointer' }}>Continue without account</button>
      </div>
    </div>
  );
}

// API KEY MODAL (compact)
function ApiKeyModal({ openaiKey, onClose }) {
  const [key, setKey] = useState(openaiKey);
  const handleSave = () => { saveLocal('openai_api_key', key); onClose(); window.location.reload(); };
  return (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', zIndex: 1000 }}>
      <div style={{ background: '#1e293b', borderRadius: '16px', padding: '24px', maxWidth: '400px', width: '100%' }}>
        <h2 style={{ color: '#f1f5f9', fontSize: '18px', marginBottom: '12px' }}>ğŸ”‘ OpenAI API Key</h2>
        <p style={{ color: '#94a3b8', fontSize: '13px', marginBottom: '16px' }}>Enter your key to generate flashcards with AI. Get one at <a href="https://platform.openai.com/api-keys" target="_blank" style={{ color: '#60a5fa' }}>platform.openai.com</a></p>
        <input type="password" placeholder="sk-..." value={key} onChange={e => setKey(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '16px', fontFamily: 'monospace' }} />
        <div style={{ display: 'flex', gap: '12px' }}>
          <button onClick={onClose} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', cursor: 'pointer' }}>Cancel</button>
          <button onClick={handleSave} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: 600, cursor: 'pointer' }}>Save</button>
        </div>
      </div>
    </div>
  );
}

// STUDY MODE (with spaced repetition)
function Study({ deck, setView, streakData, setStreakData }) {
  const [cardIndex, setCardIndex] = useState(0);
  const [showAnswer, setShowAnswer] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const [progress, setProgress] = useState(() => loadLocal(`progress_${deck.id}`, {}));
  const [favorites, setFavorites] = useState(() => loadLocal(`favorites_${deck.id}`, {}));
  const [shuffled, setShuffled] = useState(false);
  const [filter, setFilter] = useState('all');
  const [order, setOrder] = useState(() => deck.cards.map((_, i) => i));
  const [voice, setVoice] = useState(null);
  const [voices, setVoices] = useState([]);
  const [speed, setSpeed] = useState(0.9);
  const [phase, setPhase] = useState('idle');
  const timerRef = useRef(null);
  const isPlayingRef = useRef(false);

  const card = deck.cards[order[cardIndex]];
  const knownCount = Object.values(progress).filter(v => v === 'known').length;

  useEffect(() => {
    const loadVoices = () => {
      const allVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
      setVoices(allVoices);
      if (allVoices.length && !voice) setVoice(allVoices[0]);
    };
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
  }, []);

  useEffect(() => {
    let indices = deck.cards.map((_, i) => i);
    if (filter === 'favorites') indices = indices.filter(i => favorites[deck.cards[i].front]);
    if (shuffled && indices.length > 0) {
      for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
    }
    setOrder(indices.length > 0 ? indices : deck.cards.map((_, i) => i));
    setCardIndex(0);
    setShowAnswer(false);
  }, [shuffled, filter, favorites]);

  useEffect(() => { saveLocal(`progress_${deck.id}`, progress); }, [progress]);
  useEffect(() => { saveLocal(`favorites_${deck.id}`, favorites); }, [favorites]);
  useEffect(() => { isPlayingRef.current = isPlaying; }, [isPlaying]);
  useEffect(() => { return () => { speechSynthesis.cancel(); if (timerRef.current) clearTimeout(timerRef.current); }; }, []);

  const speak = (text) => new Promise(resolve => {
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text.replace(/\. /g, '... '));
    u.rate = speed; u.pitch = 1.05; if (voice) u.voice = voice;
    u.onend = resolve; u.onerror = resolve;
    speechSynthesis.speak(u);
  });

  const runAutoPlay = async (idx, doQ = true) => {
    while (isPlayingRef.current) {
      const c = deck.cards[order[idx]];
      if (doQ) { setCardIndex(idx); setShowAnswer(false); setPhase('speaking-q'); await speak("Question. " + c.front); if (!isPlayingRef.current) break; setPhase('pause'); await new Promise(r => timerRef.current = setTimeout(r, 1500)); if (!isPlayingRef.current) break; }
      setShowAnswer(true); setPhase('speaking-a'); await speak("Answer. " + c.back); if (!isPlayingRef.current) break; setPhase('pause'); await new Promise(r => timerRef.current = setTimeout(r, 2500)); if (!isPlayingRef.current) break;
      idx = (idx + 1) % order.length; doQ = true;
    }
    setPhase('idle');
  };

  const handlePlay = () => { setIsPlaying(true); isPlayingRef.current = true; runAutoPlay(cardIndex, !showAnswer); };
  const handleStop = () => { isPlayingRef.current = false; setIsPlaying(false); speechSynthesis.cancel(); if (timerRef.current) clearTimeout(timerRef.current); setPhase('idle'); };
  const handleNext = () => { handleStop(); setCardIndex((cardIndex + 1) % order.length); setShowAnswer(false); };
  const handlePrev = () => { handleStop(); setCardIndex((cardIndex - 1 + order.length) % order.length); setShowAnswer(false); };
  const handleFlip = () => { if (!isPlaying) setShowAnswer(!showAnswer); };

  const markCard = (status) => {
    setProgress(p => ({ ...p, [card.front]: status }));
    // Update streak
    const today = new Date().toDateString();
    const newStreak = { ...streakData, todayCards: streakData.todayCards + 1 };
    if (streakData.lastStudy !== today) {
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      newStreak.current = streakData.lastStudy === yesterday ? streakData.current + 1 : 1;
      newStreak.lastStudy = today;
      newStreak.todayCards = 1;
    }
    setStreakData(newStreak);
    saveStreakData(newStreak);
  };

  const toggleFavorite = () => { setFavorites(f => { const n = { ...f }; if (n[card.front]) delete n[card.front]; else n[card.front] = true; return n; }); };
  const favCount = Object.keys(favorites).length;

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '16px', fontFamily: 'system-ui', color: '#e2e8f0' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
          <button onClick={() => { handleStop(); setView('home'); }} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', padding: '10px 16px', color: '#94a3b8', cursor: 'pointer' }}>â† Back</button>
          <div style={{ textAlign: 'center' }}>
            <div style={{ color: '#f1f5f9', fontWeight: 600 }}>{deck.name}</div>
            <div style={{ color: '#64748b', fontSize: '12px' }}>Card {cardIndex + 1}/{order.length} â€¢ {knownCount} mastered</div>
          </div>
          <button onClick={() => setView('quiz')} style={{ background: 'rgba(139,92,246,0.2)', border: 'none', borderRadius: '10px', padding: '10px 16px', color: '#a78bfa', cursor: 'pointer' }}>Quiz</button>
        </div>

        {/* Filters */}
        <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
          <button onClick={() => setFilter('all')} style={{ flex: 1, padding: '8px', borderRadius: '8px', border: 'none', fontSize: '12px', cursor: 'pointer', background: filter === 'all' ? 'rgba(59,130,246,0.3)' : 'rgba(255,255,255,0.05)', color: filter === 'all' ? '#60a5fa' : '#64748b' }}>All ({deck.cards.length})</button>
          <button onClick={() => setFilter('favorites')} style={{ flex: 1, padding: '8px', borderRadius: '8px', border: 'none', fontSize: '12px', cursor: 'pointer', background: filter === 'favorites' ? 'rgba(251,191,36,0.3)' : 'rgba(255,255,255,0.05)', color: filter === 'favorites' ? '#fbbf24' : '#64748b' }}>â˜… ({favCount})</button>
        </div>

        {/* Status bar */}
        {isPlaying && (
          <div style={{ background: 'rgba(16,185,129,0.2)', borderRadius: '10px', padding: '10px 14px', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
            <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#10b981', animation: 'pulse 1.5s infinite' }}></div>
            <span style={{ color: '#10b981', fontSize: '13px' }}>{phase === 'speaking-q' ? 'Reading question...' : phase === 'speaking-a' ? 'Reading answer...' : 'Next card...'}</span>
          </div>
        )}

        {/* Card */}
        <div onClick={handleFlip} style={{ position: 'relative', background: showAnswer ? 'linear-gradient(135deg, #064e3b, #065f46)' : 'linear-gradient(135deg, #1e3a5f, #1e40af)', borderRadius: '16px', padding: '20px', minHeight: '220px', display: 'flex', flexDirection: 'column', cursor: 'pointer', border: showAnswer ? '2px solid #10b981' : '2px solid #3b82f6' }}>
          <button onClick={e => { e.stopPropagation(); toggleFavorite(); }} style={{ position: 'absolute', top: '12px', right: '12px', background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', opacity: favorites[card?.front] ? 1 : 0.3 }}>â˜…</button>
          <div style={{ fontSize: '10px', fontWeight: 700, color: showAnswer ? '#6ee7b7' : '#93c5fd', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '12px' }}>{card?.category} â€¢ {showAnswer ? 'ANSWER' : 'QUESTION'}</div>
          <div style={{ flex: 1, fontSize: showAnswer ? '14px' : '17px', lineHeight: 1.6 }}>{showAnswer ? card?.back : card?.front}</div>
          {card?.source && <div style={{ marginTop: '10px', paddingTop: '8px', borderTop: '1px solid rgba(255,255,255,0.1)', fontSize: '10px', color: '#64748b' }}>Source: {card.source}</div>}
          {!isPlaying && <div style={{ marginTop: '8px', color: showAnswer ? '#6ee7b7' : '#93c5fd', fontSize: '12px' }}>Tap to {showAnswer ? 'see question' : 'reveal answer'}</div>}
        </div>

        {/* Mark buttons */}
        {!isPlaying && (
          <div style={{ display: 'flex', gap: '10px', marginTop: '12px' }}>
            <button onClick={() => markCard('learning')} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', fontWeight: 600, fontSize: '13px', cursor: 'pointer', background: progress[card?.front] === 'learning' ? '#f59e0b' : 'rgba(255,255,255,0.1)', color: progress[card?.front] === 'learning' ? 'white' : '#94a3b8' }}>Still Learning</button>
            <button onClick={() => markCard('known')} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', fontWeight: 600, fontSize: '13px', cursor: 'pointer', background: progress[card?.front] === 'known' ? '#10b981' : 'rgba(255,255,255,0.1)', color: progress[card?.front] === 'known' ? 'white' : '#94a3b8' }}>Got It âœ“</button>
          </div>
        )}

        {/* Controls */}
        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '12px', marginTop: '20px' }}>
          <button onClick={handlePrev} style={{ width: '44px', height: '44px', borderRadius: '50%', background: 'rgba(255,255,255,0.1)', border: 'none', color: '#e2e8f0', fontSize: '20px', cursor: 'pointer' }}>â€¹</button>
          <button onClick={isPlaying ? handleStop : handlePlay} style={{ width: '64px', height: '64px', borderRadius: '50%', background: isPlaying ? '#ef4444' : '#10b981', border: 'none', color: 'white', fontSize: '24px', cursor: 'pointer' }}>{isPlaying ? 'â¹' : 'â–¶'}</button>
          <button onClick={handleNext} style={{ width: '44px', height: '44px', borderRadius: '50%', background: 'rgba(255,255,255,0.1)', border: 'none', color: '#e2e8f0', fontSize: '20px', cursor: 'pointer' }}>â€º</button>
        </div>

        {/* Settings */}
        <div style={{ marginTop: '20px', background: 'rgba(30,41,59,0.8)', borderRadius: '12px', padding: '16px' }}>
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px', justifyContent: 'center', alignItems: 'center' }}>
            <select value={voice?.name || ''} onChange={e => setVoice(voices.find(v => v.name === e.target.value))} style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', padding: '6px 10px', color: '#e2e8f0', fontSize: '12px', maxWidth: '120px' }}>
              {voices.map(v => <option key={v.name} value={v.name}>{v.name.slice(0, 15)}</option>)}
            </select>
            <select value={speed} onChange={e => setSpeed(parseFloat(e.target.value))} style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', padding: '6px 10px', color: '#e2e8f0', fontSize: '12px' }}>
              <option value={0.8}>Slow</option>
              <option value={0.9}>Normal</option>
              <option value={1.1}>Fast</option>
            </select>
            <button onClick={() => setShuffled(!shuffled)} style={{ padding: '6px 12px', borderRadius: '6px', border: 'none', background: shuffled ? '#3b82f6' : 'rgba(255,255,255,0.1)', color: shuffled ? 'white' : '#94a3b8', fontSize: '12px', cursor: 'pointer' }}>ğŸ”€ {shuffled ? 'On' : 'Off'}</button>
          </div>
        </div>
      </div>
      <style>{`@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }`}</style>
    </div>
  );
}

// QUIZ MODE
function QuizMode({ deck, setView }) {
  const [questions, setQuestions] = useState([]);
  const [currentQ, setCurrentQ] = useState(0);
  const [score, setScore] = useState(0);
  const [showResult, setShowResult] = useState(false);
  const [answered, setAnswered] = useState(false);
  const [timeLeft, setTimeLeft] = useState(30);
  const [quizComplete, setQuizComplete] = useState(false);
  const timerRef = useRef(null);

  useEffect(() => {
    // Shuffle and pick 10 questions
    const shuffled = [...deck.cards].sort(() => Math.random() - 0.5).slice(0, 10);
    setQuestions(shuffled);
  }, []);

  useEffect(() => {
    if (!quizComplete && questions.length > 0 && !answered) {
      timerRef.current = setInterval(() => {
        setTimeLeft(t => {
          if (t <= 1) { handleAnswer(false); return 30; }
          return t - 1;
        });
      }, 1000);
    }
    return () => clearInterval(timerRef.current);
  }, [currentQ, answered, quizComplete]);

  const handleAnswer = (correct) => {
    clearInterval(timerRef.current);
    setAnswered(true);
    setShowResult(true);
    if (correct) setScore(s => s + 1);
  };

  const nextQuestion = () => {
    if (currentQ + 1 >= questions.length) {
      setQuizComplete(true);
    } else {
      setCurrentQ(c => c + 1);
      setAnswered(false);
      setShowResult(false);
      setTimeLeft(30);
    }
  };

  if (questions.length === 0) return null;

  if (quizComplete) {
    const percent = Math.round((score / questions.length) * 100);
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
        <div style={{ textAlign: 'center', color: '#f1f5f9' }}>
          <div style={{ fontSize: '64px', marginBottom: '16px' }}>{percent >= 80 ? 'ğŸ†' : percent >= 50 ? 'ğŸ‘' : 'ğŸ“š'}</div>
          <h2 style={{ fontSize: '28px', marginBottom: '8px' }}>Quiz Complete!</h2>
          <p style={{ fontSize: '20px', color: '#60a5fa', marginBottom: '24px' }}>{score}/{questions.length} correct ({percent}%)</p>
          <button onClick={() => setView('home')} style={{ padding: '14px 32px', borderRadius: '10px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '16px', fontWeight: 600, cursor: 'pointer' }}>Back to Home</button>
        </div>
      </div>
    );
  }

  const q = questions[currentQ];
  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
          <button onClick={() => setView('study')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px 14px', color: '#94a3b8', cursor: 'pointer' }}>â† Exit</button>
          <div style={{ color: '#f1f5f9', fontWeight: 600 }}>Question {currentQ + 1}/{questions.length}</div>
          <div style={{ color: timeLeft <= 10 ? '#ef4444' : '#10b981', fontWeight: 600 }}>{timeLeft}s</div>
        </div>

        {/* Timer bar */}
        <div style={{ height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px', marginBottom: '20px' }}>
          <div style={{ width: `${(timeLeft / 30) * 100}%`, height: '100%', background: timeLeft <= 10 ? '#ef4444' : '#10b981', borderRadius: '2px', transition: 'width 1s linear' }}></div>
        </div>

        {/* Question */}
        <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '16px', padding: '24px', marginBottom: '20px' }}>
          <div style={{ color: '#60a5fa', fontSize: '11px', fontWeight: 600, textTransform: 'uppercase', marginBottom: '12px' }}>{q.category}</div>
          <div style={{ color: '#f1f5f9', fontSize: '18px', lineHeight: 1.6 }}>{q.front}</div>
        </div>

        {showResult ? (
          <div>
            <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '20px', marginBottom: '16px' }}>
              <div style={{ color: '#10b981', fontSize: '12px', fontWeight: 600, marginBottom: '8px' }}>ANSWER</div>
              <div style={{ color: '#f1f5f9', fontSize: '14px', lineHeight: 1.5 }}>{q.back}</div>
            </div>
            <button onClick={nextQuestion} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '15px', fontWeight: 600, cursor: 'pointer' }}>
              {currentQ + 1 >= questions.length ? 'See Results' : 'Next Question â†’'}
            </button>
          </div>
        ) : (
          <div style={{ display: 'flex', gap: '12px' }}>
            <button onClick={() => handleAnswer(false)} style={{ flex: 1, padding: '16px', borderRadius: '10px', border: 'none', background: 'rgba(239,68,68,0.2)', color: '#f87171', fontSize: '15px', fontWeight: 600, cursor: 'pointer' }}>Don't Know</button>
            <button onClick={() => { setShowResult(true); clearInterval(timerRef.current); }} style={{ flex: 1, padding: '16px', borderRadius: '10px', border: 'none', background: 'rgba(16,185,129,0.2)', color: '#34d399', fontSize: '15px', fontWeight: 600, cursor: 'pointer' }}>Show Answer</button>
          </div>
        )}

        {showResult && !answered && (
          <div style={{ display: 'flex', gap: '12px', marginTop: '12px' }}>
            <button onClick={() => handleAnswer(false)} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', background: '#ef4444', color: 'white', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}>Got it Wrong</button>
            <button onClick={() => handleAnswer(true)} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', background: '#10b981', color: 'white', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}>Got it Right âœ“</button>
          </div>
        )}
      </div>
    </div>
  );
}

// EXAM COUNTDOWN
function ExamCountdown({ setView }) {
  const [exams, setExamsState] = useState(getExams);
  const [showAdd, setShowAdd] = useState(false);
  const [newExam, setNewExam] = useState({ subject: '', date: '', icon: 'ğŸ“' });

  const addExam = () => {
    if (!newExam.subject || !newExam.date) return;
    const updated = [...exams, { ...newExam, id: Date.now() }];
    setExamsState(updated);
    saveExams(updated);
    setNewExam({ subject: '', date: '', icon: 'ğŸ“' });
    setShowAdd(false);
  };

  const deleteExam = (id) => {
    const updated = exams.filter(e => e.id !== id);
    setExamsState(updated);
    saveExams(updated);
  };

  const getDaysUntil = (date) => {
    const diff = new Date(date) - new Date();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
          <button onClick={() => setView('home')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 16px', color: '#94a3b8', cursor: 'pointer' }}>â† Back</button>
          <h1 style={{ color: '#f1f5f9', fontSize: '20px' }}>ğŸ“… Exam Countdown</h1>
          <button onClick={() => setShowAdd(true)} style={{ background: '#3b82f6', border: 'none', borderRadius: '8px', padding: '10px 16px', color: 'white', cursor: 'pointer' }}>+ Add</button>
        </div>

        {showAdd && (
          <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '20px', marginBottom: '16px' }}>
            <input placeholder="Subject (e.g., GCSE Biology Paper 1)" value={newExam.subject} onChange={e => setNewExam({ ...newExam, subject: e.target.value })} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <input type="date" value={newExam.date} onChange={e => setNewExam({ ...newExam, date: e.target.value })} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <div style={{ display: 'flex', gap: '8px' }}>
              <button onClick={() => setShowAdd(false)} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', cursor: 'pointer' }}>Cancel</button>
              <button onClick={addExam} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: '#10b981', color: 'white', fontWeight: 600, cursor: 'pointer' }}>Add Exam</button>
            </div>
          </div>
        )}

        {exams.length === 0 ? (
          <div style={{ textAlign: 'center', color: '#64748b', marginTop: '60px' }}>
            <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸ“…</div>
            <p>No exams added yet. Click "+ Add" to add your first exam.</p>
          </div>
        ) : (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
            {exams.sort((a, b) => new Date(a.date) - new Date(b.date)).map(exam => {
              const days = getDaysUntil(exam.date);
              const color = days <= 7 ? '#ef4444' : days <= 30 ? '#f59e0b' : '#10b981';
              return (
                <div key={exam.id} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '16px', border: `2px solid ${color}30` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <div style={{ color: '#f1f5f9', fontSize: '16px', fontWeight: 500 }}>{exam.subject}</div>
                      <div style={{ color: '#64748b', fontSize: '13px' }}>{new Date(exam.date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ color, fontSize: '24px', fontWeight: 700 }}>{days}</div>
                      <div style={{ color: '#64748b', fontSize: '11px' }}>days</div>
                    </div>
                  </div>
                  <button onClick={() => deleteExam(exam.id)} style={{ marginTop: '12px', padding: '6px 12px', borderRadius: '6px', border: '1px solid rgba(239,68,68,0.3)', background: 'transparent', color: '#f87171', fontSize: '12px', cursor: 'pointer' }}>Remove</button>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

// CREATE DECK (simplified)
function CreateDeck({ setView, openaiKey, user }) {
  const [topic, setTopic] = useState('');
  const [loading, setLoading] = useState(false);
  const [cards, setCards] = useState([]);
  const [deckName, setDeckName] = useState('');

  const generate = async () => {
    if (!topic.trim() || !openaiKey) return;
    setLoading(true);
    try {
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: 'Generate flashcards. Return ONLY JSON array: [{"category":"...", "front":"question", "back":"answer", "source":"reference"}]' },
            { role: 'user', content: `Create 10 flashcards about: ${topic}` }
          ]
        })
      });
      const data = await res.json();
      let content = data.choices[0].message.content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      setCards(JSON.parse(content));
      setDeckName(topic);
    } catch (e) { alert('Error: ' + e.message); }
    setLoading(false);
  };

  const save = async () => {
    if (!user || !cards.length) return;
    const { data: deck } = await supabase.from('decks').insert({ user_id: user.id, name: deckName, icon: 'ğŸ“š', description: `AI deck: ${topic}` }).select().single();
    if (deck) {
      await supabase.from('cards').insert(cards.map(c => ({ deck_id: deck.id, ...c })));
      setView('home');
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        <button onClick={() => setView('home')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 16px', color: '#94a3b8', cursor: 'pointer', marginBottom: '20px' }}>â† Back</button>

        {cards.length === 0 ? (
          <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '16px', padding: '24px' }}>
            <h2 style={{ color: '#f1f5f9', marginBottom: '16px' }}>âœ¨ Create with AI</h2>
            <input placeholder="Enter a topic..." value={topic} onChange={e => setTopic(e.target.value)} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <button onClick={generate} disabled={loading} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: 'none', background: loading ? '#64748b' : '#3b82f6', color: 'white', fontWeight: 600, cursor: 'pointer' }}>{loading ? 'Generating...' : 'Generate Cards'}</button>
          </div>
        ) : (
          <div>
            <input value={deckName} onChange={e => setDeckName(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <button onClick={save} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: 'none', background: '#10b981', color: 'white', fontWeight: 600, cursor: 'pointer', marginBottom: '16px' }}>Save Deck ({cards.length} cards)</button>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '400px', overflowY: 'auto' }}>
              {cards.map((c, i) => (
                <div key={i} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '10px', padding: '12px' }}>
                  <div style={{ color: '#60a5fa', fontSize: '11px', marginBottom: '6px' }}>{c.category}</div>
                  <div style={{ color: '#f1f5f9', fontSize: '14px', marginBottom: '6px' }}>{c.front}</div>
                  <div style={{ color: '#94a3b8', fontSize: '12px' }}>{c.back}</div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// RENDER
ReactDOM.createRoot(document.getElementById('root')).render(<AuthProvider><App /></AuthProvider>);
  </script>
</body>
</html>
