<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlashLearn - AI-Powered Flashcards</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f172a; font-family: system-ui, -apple-system, sans-serif; }
    input, textarea, select, button { font-family: inherit; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef, createContext, useContext } = React;

// ============================================================
// SUPABASE CONFIG
// ============================================================
const SUPABASE_URL = 'https://bqtqmbyxdvinjbheykcc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_wH-eykJr8kFDMinN29bQyg_rrhqoqlP';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ============================================================
// AUTH CONTEXT
// ============================================================
const AuthContext = createContext(null);

function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user ?? null);
    });

    return () => subscription.unsubscribe();
  }, []);

  const signUp = async (email, password) => {
    const { error } = await supabase.auth.signUp({ email, password });
    return { error };
  };

  const signIn = async (email, password) => {
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    return { error };
  };

  const signOut = async () => {
    await supabase.auth.signOut();
  };

  return (
    <AuthContext.Provider value={{ user, loading, signUp, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

const useAuth = () => useContext(AuthContext);

// ============================================================
// PRESET DECKS (for users without account or as templates)
// ============================================================
const PRESET_DECKS = [
  {
    id: 'lbo',
    name: 'LBO Modeling',
    icon: 'üè¶',
    description: 'Leveraged Buyout fundamentals: deal structure, returns analysis, and modeling mechanics',
    cards: [
      { category: "LBO Basics", front: "What is a leveraged buyout?", back: "An acquisition of a company using a significant amount of borrowed money, typically 60 to 70 percent debt, to meet the cost of acquisition. The assets of the acquired company often serve as collateral. The goal is to generate returns through debt paydown, EBITDA growth, and multiple expansion.", source: "Wall Street Prep" },
      { category: "LBO Basics", front: "What are the key characteristics of a good LBO candidate?", back: "Strong and predictable cash flows. Leading market position with defensible business. Low capex requirements relative to cash flow. Opportunities for operational improvement. Strong management team. Clear exit opportunities. Limited cyclicality. Asset base that can support debt.", source: "Macabacus" },
      { category: "LBO Basics", front: "What are the primary sources of returns in an LBO?", back: "Three main drivers. First, debt paydown using free cash flow reduces net debt over the hold period. Second, EBITDA growth through revenue increases and margin expansion. Third, multiple expansion if exit multiple exceeds entry multiple. Debt paydown is the most reliable source.", source: "Wall Street Oasis" },
      { category: "Deal Structure", front: "What is a typical LBO capital structure?", back: "Senior secured debt at 3 to 4 times EBITDA, often a Term Loan B. Subordinated or mezzanine debt at 1 to 2 times. Equity contribution of 30 to 40 percent of total enterprise value. Total leverage of 5 to 6 times EBITDA is common. Senior debt is cheapest but most restrictive.", source: "Leveraged Commentary & Data" },
      { category: "Deal Structure", front: "What is the difference between a Term Loan A and Term Loan B?", back: "Term Loan A amortizes over the life of the loan, typically 5 to 7 years, with mandatory quarterly payments. Term Loan B has minimal amortization of 1 percent per year with a bullet payment at maturity, typically 7 years. TLB is more common in LBOs because it preserves cash flow.", source: "LSTA" },
      { category: "Deal Structure", front: "What is mezzanine debt?", back: "Subordinated debt sitting between senior debt and equity in the capital structure. Typically unsecured. Higher interest rate of 12 to 20 percent, often with PIK interest component. May include equity warrants. Used to bridge the gap between senior debt capacity and equity contribution.", source: "Investopedia" },
      { category: "Returns", front: "How do you calculate IRR in an LBO?", back: "IRR is the discount rate that makes the net present value of all cash flows equal to zero. In an LBO context, the initial equity investment is the outflow, and the exit equity value plus any dividends received are the inflows. A typical PE fund targets a 20 to 25 percent gross IRR over a 3 to 5 year hold.", source: "Wall Street Prep" },
      { category: "Returns", front: "What is MOIC and how does it relate to IRR?", back: "Multiple of Invested Capital equals total value received divided by total equity invested. A 2.0x MOIC means doubling your money. MOIC does not account for timing, while IRR does. A 2.5x MOIC over 3 years is roughly a 36 percent IRR, but over 5 years is roughly 20 percent IRR. Both metrics are used together.", source: "Bain & Company" },
      { category: "Returns", front: "What is a dividend recapitalization?", back: "A transaction where a PE-owned company raises additional debt to pay a special dividend to its equity holders. It allows sponsors to realize partial returns without selling the company. Reduces equity at risk but increases leverage. Can be controversial if it weakens the company financially.", source: "Pitchbook" },
      { category: "Modeling", front: "Walk through the key steps of building an LBO model.", back: "Step 1, build operating model with revenue and EBITDA projections. Step 2, determine purchase price and sources and uses. Step 3, build the debt schedule with mandatory and optional repayments. Step 4, project free cash flow and debt paydown. Step 5, calculate exit value using an exit multiple. Step 6, compute equity returns including IRR and MOIC.", source: "Wall Street Prep" },
      { category: "Modeling", front: "What are sources and uses in an LBO?", back: "Sources are where the money comes from: senior debt, subordinated debt, equity contribution, and rollover equity. Uses are where the money goes: purchase equity value, repay existing debt, transaction fees, and financing fees. Sources must equal uses. This table determines the equity check.", source: "Macabacus" },
      { category: "Modeling", front: "How do you determine the maximum leverage in an LBO?", back: "Consider the company's ability to service debt through cash flow coverage ratios. Minimum interest coverage of 2.0x. Minimum fixed charge coverage of 1.2x. Maximum total leverage based on industry norms. Lender appetite and credit market conditions. Covenant headroom requirements.", source: "S&P Global" },
      { category: "Exit", front: "What are common LBO exit strategies?", back: "Strategic sale to a corporate buyer, often achieving the highest multiple. Secondary buyout or sale to another PE firm. Initial public offering for large, well-performing companies. Dividend recapitalization for partial liquidity. Management buyout in select situations. Average hold period is 4 to 6 years.", source: "Bain & Company" },
      { category: "Exit", front: "What is a secondary buyout?", back: "When one private equity firm sells a portfolio company to another private equity firm. Now represents over 50 percent of PE exits. Can be controversial as critics question value creation. Works when the new sponsor has a different operational playbook or growth thesis.", source: "Pitchbook" },
    ]
  },
  {
    id: 'dcf',
    name: 'DCF Valuation',
    icon: 'üí∞',
    description: 'Discounted Cash Flow analysis: WACC, terminal value, and valuation mechanics',
    cards: [
      { category: "DCF Basics", front: "What is a DCF and when would you use it?", back: "A Discounted Cash Flow analysis values a company by projecting its future free cash flows and discounting them back to present value using an appropriate discount rate. Best used for companies with predictable cash flows. Less appropriate for early-stage companies, banks, or highly cyclical businesses.", source: "Damodaran" },
      { category: "DCF Basics", front: "Walk through the steps of a DCF.", back: "Step 1, project unlevered free cash flows for 5 to 10 years. Step 2, calculate the terminal value. Step 3, discount all cash flows to present value using WACC. Step 4, sum the present values to get enterprise value. Step 5, subtract net debt and add cash to get equity value. Step 6, divide by shares outstanding for per-share value.", source: "Wall Street Prep" },
      { category: "Free Cash Flow", front: "How do you calculate unlevered free cash flow?", back: "Start with EBIT. Subtract taxes at the marginal rate to get NOPAT. Add back depreciation and amortization. Subtract capital expenditures. Subtract increases in net working capital. The result is cash flow available to all capital providers, both debt and equity holders.", source: "Damodaran" },
      { category: "Free Cash Flow", front: "Why do we use unlevered free cash flow in a DCF?", back: "Unlevered free cash flow represents cash available to all investors, both debt and equity. This allows us to value the entire enterprise independent of capital structure. We then discount at WACC, which reflects returns required by all capital providers. This separates operating performance from financing decisions.", source: "McKinsey Valuation" },
      { category: "WACC", front: "How do you calculate WACC?", back: "WACC equals the weight of equity times cost of equity, plus the weight of debt times cost of debt times one minus the tax rate. Use market values for weights, not book values. Cost of equity is calculated using CAPM. Cost of debt is the yield on the company's existing debt or comparable debt.", source: "Brealey Myers" },
      { category: "WACC", front: "How do you calculate cost of equity using CAPM?", back: "Cost of equity equals the risk-free rate plus beta times the equity risk premium. Risk-free rate is the 10-year Treasury yield. Beta measures systematic risk relative to the market. Equity risk premium is the expected market return minus the risk-free rate, typically 5 to 7 percent. Can add a size premium for small companies.", source: "Damodaran" },
      { category: "WACC", front: "What is beta and how do you estimate it?", back: "Beta measures a stock's sensitivity to market movements. A beta of 1.0 means it moves with the market. Higher beta means more volatile. Estimated by regressing stock returns against market returns over 2 to 5 years. For private companies, use comparable company betas, unlevered and re-levered for the target capital structure.", source: "Brealey Myers" },
      { category: "Terminal Value", front: "What are the two methods for calculating terminal value?", back: "The Gordon Growth Model applies a perpetuity growth rate to the final year cash flow. Formula is final year FCF times one plus growth rate, divided by WACC minus growth rate. The Exit Multiple Method applies an EV to EBITDA multiple to terminal year EBITDA. Both should yield similar results if assumptions are consistent.", source: "McKinsey Valuation" },
      { category: "Terminal Value", front: "What is a reasonable perpetuity growth rate?", back: "Typically 2 to 3 percent, in line with long-term GDP growth and inflation. Should not exceed long-term economic growth as no company grows faster than the economy forever. Higher rates dramatically increase terminal value and can distort the DCF. The terminal value often represents 60 to 80 percent of total enterprise value.", source: "Damodaran" },
      { category: "Sensitivity", front: "What are the key sensitivities in a DCF?", back: "The most impactful assumptions are the discount rate or WACC, the terminal growth rate, revenue growth rates, operating margins, and capital expenditure assumptions. Small changes in WACC or terminal growth can significantly shift the valuation. Always present results as a range using sensitivity tables.", source: "Wall Street Prep" },
      { category: "Practical", front: "What are the main limitations of a DCF?", back: "Highly sensitive to assumptions, especially terminal value. Garbage in, garbage out. Difficult for companies without predictable cash flows. Does not reflect market sentiment or relative valuation. Requires accurate cost of capital estimation. Terminal value often dominates, making near-term projections less impactful.", source: "Damodaran" },
      { category: "Practical", front: "How does a DCF differ from comparable company analysis?", back: "DCF is an intrinsic valuation based on a company's own fundamentals. Comps is a relative valuation based on how similar companies are priced. DCF captures company-specific growth and risk. Comps reflect current market conditions. Both approaches should be used together to triangulate value.", source: "McKinsey Valuation" },
    ]
  },
  {
    id: 'accounting',
    name: 'Accounting Fundamentals',
    icon: 'üìí',
    description: 'Financial statements, key ratios, and accounting principles for interviews',
    cards: [
      { category: "Financial Statements", front: "What are the three main financial statements and how are they linked?", back: "Income statement shows profitability over a period. Balance sheet shows assets, liabilities, and equity at a point in time. Cash flow statement shows cash movements. Net income from the income statement flows to retained earnings on the balance sheet and is the starting point for cash flow from operations.", source: "Accounting Standards Codification" },
      { category: "Financial Statements", front: "Walk through the income statement.", back: "Revenue minus cost of goods sold equals gross profit. Minus operating expenses like SGA and R&D equals operating income or EBIT. Minus interest expense plus interest income equals pre-tax income. Minus taxes equals net income. Key margins are gross margin, operating margin, and net margin.", source: "Wall Street Prep" },
      { category: "Financial Statements", front: "Walk through the balance sheet.", back: "Assets equal liabilities plus shareholders equity. Current assets include cash, receivables, and inventory. Long-term assets include PP&E, goodwill, and intangibles. Current liabilities include payables and short-term debt. Long-term liabilities include long-term debt. Equity includes common stock, APIC, and retained earnings.", source: "Accounting Standards Codification" },
      { category: "Financial Statements", front: "Walk through the cash flow statement.", back: "Three sections. Operating starts with net income, adds back non-cash charges like D&A, adjusts for working capital changes. Investing includes capital expenditures, acquisitions, and asset sales. Financing includes debt issuance and repayment, equity issuance and buybacks, and dividends. The sum equals the change in cash.", source: "Wall Street Prep" },
      { category: "Key Concepts", front: "What is the difference between cash and accrual accounting?", back: "Cash accounting recognizes revenue when cash is received and expenses when cash is paid. Accrual accounting recognizes revenue when earned and expenses when incurred, regardless of cash timing. GAAP requires accrual accounting. The difference between them is captured in working capital changes on the cash flow statement.", source: "FASB" },
      { category: "Key Concepts", front: "What is working capital and why does it matter?", back: "Working capital equals current assets minus current liabilities. Operating working capital excludes cash and debt. Increases in working capital use cash. Decreases in working capital generate cash. Companies with negative working capital cycles like Amazon generate cash as they grow. It is a key driver of free cash flow.", source: "McKinsey Valuation" },
      { category: "Key Concepts", front: "What is depreciation and how does it affect the statements?", back: "Depreciation allocates the cost of a tangible asset over its useful life. On the income statement, it reduces operating income and net income. On the balance sheet, accumulated depreciation reduces net PP&E. On the cash flow statement, it is added back as a non-cash charge. It creates a tax shield equal to depreciation times the tax rate.", source: "Accounting Standards Codification" },
      { category: "Key Concepts", front: "What is goodwill?", back: "Goodwill equals the purchase price minus the fair market value of net identifiable assets acquired. It arises only from acquisitions, never organically. It is not amortized but is tested annually for impairment. If fair value drops below carrying value, goodwill is written down, creating a non-cash charge on the income statement.", source: "FASB ASC 350" },
      { category: "Key Concepts", front: "What is deferred revenue?", back: "Cash received for goods or services not yet delivered. It is a liability on the balance sheet because the company owes future performance. When the service is delivered, deferred revenue decreases and revenue is recognized on the income statement. Common in SaaS, subscriptions, and prepaid contracts.", source: "FASB ASC 606" },
      { category: "Ratios", front: "What are the key profitability ratios?", back: "Gross margin equals gross profit divided by revenue. Operating margin equals EBIT divided by revenue. Net margin equals net income divided by revenue. ROE equals net income divided by shareholders equity. ROA equals net income divided by total assets. ROIC equals NOPAT divided by invested capital.", source: "CFA Institute" },
      { category: "Ratios", front: "What are the key leverage ratios?", back: "Debt to equity equals total debt divided by equity. Debt to EBITDA equals total debt divided by EBITDA. Interest coverage equals EBIT divided by interest expense. Net debt equals total debt minus cash. Fixed charge coverage equals EBIT plus fixed charges divided by fixed charges plus interest.", source: "S&P Global" },
      { category: "Ratios", front: "What are the key liquidity ratios?", back: "Current ratio equals current assets divided by current liabilities. Target is above 1.5. Quick ratio excludes inventory from current assets. Target is above 1.0. Cash ratio equals cash divided by current liabilities. Most conservative. Days sales outstanding, days inventory outstanding, and days payable outstanding measure the cash conversion cycle.", source: "CFA Institute" },
    ]
  }
];

// ============================================================
// HELPERS
// ============================================================
const saveLocal = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} };
const loadLocal = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch(e) { return d; } };

// ============================================================
// MAIN APP
// ============================================================
function App() {
  const { user, loading } = useAuth();
  const [view, setView] = useState('home');
  const [activeDeck, setActiveDeck] = useState(null);
  const [decks, setDecks] = useState([]);
  const [openaiKey, setOpenaiKey] = useState(() => loadLocal('openai_api_key', ''));
  const [showApiKeyModal, setShowApiKeyModal] = useState(false);

  // Load decks when user changes
  useEffect(() => {
    if (user) {
      loadUserDecks();
    } else {
      // Use preset decks for non-logged-in users
      setDecks(PRESET_DECKS.map(d => ({ ...d, isPreset: true })));
    }
  }, [user]);

  const loadUserDecks = async () => {
    // Load user's custom decks
    const { data: userDecks } = await supabase
      .from('decks')
      .select('*, cards(*)')
      .eq('user_id', user.id);

    // Combine with presets
    const allDecks = [
      ...PRESET_DECKS.map(d => ({ ...d, isPreset: true })),
      ...(userDecks || []).map(d => ({
        id: d.id,
        name: d.name,
        icon: d.icon,
        description: d.description,
        cards: d.cards || [],
        isPreset: false
      }))
    ];
    setDecks(allDecks);
  };

  if (loading) {
    return (
      <div style={{ minHeight: '100vh', background: '#0f172a', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <div style={{ color: '#60a5fa', fontSize: '18px' }}>Loading...</div>
      </div>
    );
  }

  if (view === 'auth') return <AuthScreen setView={setView} />;
  if (view === 'home') return (
    <Home
      decks={decks}
      setActiveDeck={setActiveDeck}
      setView={setView}
      user={user}
      openaiKey={openaiKey}
      setShowApiKeyModal={setShowApiKeyModal}
      reloadDecks={loadUserDecks}
    />
  );
  if (view === 'study') return <Study deck={activeDeck} setView={setView} user={user} />;
  if (view === 'create') return (
    <CreateDeck
      setView={setView}
      openaiKey={openaiKey}
      setShowApiKeyModal={setShowApiKeyModal}
      user={user}
      reloadDecks={loadUserDecks}
    />
  );

  return null;
}

// ============================================================
// AUTH SCREEN
// ============================================================
function AuthScreen({ setView }) {
  const { signIn, signUp } = useAuth();
  const [isSignUp, setIsSignUp] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setSuccess('');
    setLoading(true);

    const { error } = isSignUp
      ? await signUp(email, password)
      : await signIn(email, password);

    setLoading(false);

    if (error) {
      setError(error.message);
    } else if (isSignUp) {
      setSuccess('Check your email to confirm your account!');
    } else {
      setView('home');
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
      <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '20px', padding: '40px', maxWidth: '400px', width: '100%', border: '1px solid rgba(100,116,139,0.2)' }}>
        <h1 style={{ color: '#60a5fa', fontSize: '28px', textAlign: 'center', marginBottom: '8px' }}>FlashLearn</h1>
        <p style={{ color: '#94a3b8', textAlign: 'center', marginBottom: '32px' }}>
          {isSignUp ? 'Create your account' : 'Welcome back'}
        </p>

        <form onSubmit={handleSubmit}>
          <input
            type="email"
            placeholder="Email"
            value={email}
            onChange={e => setEmail(e.target.value)}
            style={{ width: '100%', padding: '14px 16px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '16px', marginBottom: '12px', outline: 'none' }}
            required
          />
          <input
            type="password"
            placeholder="Password"
            value={password}
            onChange={e => setPassword(e.target.value)}
            style={{ width: '100%', padding: '14px 16px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '16px', marginBottom: '16px', outline: 'none' }}
            required
            minLength={6}
          />

          {error && <p style={{ color: '#ef4444', fontSize: '14px', marginBottom: '16px', textAlign: 'center' }}>{error}</p>}
          {success && <p style={{ color: '#10b981', fontSize: '14px', marginBottom: '16px', textAlign: 'center' }}>{success}</p>}

          <button
            type="submit"
            disabled={loading}
            style={{ width: '100%', padding: '14px', borderRadius: '10px', border: 'none', background: 'linear-gradient(135deg, #3b82f6, #2563eb)', color: 'white', fontSize: '16px', fontWeight: 600, cursor: loading ? 'wait' : 'pointer', opacity: loading ? 0.7 : 1 }}
          >
            {loading ? 'Please wait...' : (isSignUp ? 'Sign Up' : 'Sign In')}
          </button>
        </form>

        <p style={{ color: '#94a3b8', textAlign: 'center', marginTop: '24px', fontSize: '14px' }}>
          {isSignUp ? 'Already have an account?' : "Don't have an account?"}{' '}
          <button
            onClick={() => { setIsSignUp(!isSignUp); setError(''); setSuccess(''); }}
            style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer', fontSize: '14px', textDecoration: 'underline' }}
          >
            {isSignUp ? 'Sign In' : 'Sign Up'}
          </button>
        </p>

        <button
          onClick={() => setView('home')}
          style={{ width: '100%', marginTop: '16px', padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#64748b', fontSize: '14px', cursor: 'pointer' }}
        >
          Continue without account
        </button>
      </div>
    </div>
  );
}

// ============================================================
// API KEY MODAL
// ============================================================
function ApiKeyModal({ openaiKey, setOpenaiKey, onClose }) {
  const [key, setKey] = useState(openaiKey);

  const handleSave = () => {
    setOpenaiKey(key);
    saveLocal('openai_api_key', key);
    onClose();
  };

  return (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', zIndex: 1000 }}>
      <div style={{ background: '#1e293b', borderRadius: '20px', padding: '32px', maxWidth: '450px', width: '100%', border: '1px solid rgba(100,116,139,0.3)' }}>
        <h2 style={{ color: '#f1f5f9', fontSize: '20px', marginBottom: '8px' }}>üîë OpenAI API Key</h2>
        <p style={{ color: '#94a3b8', fontSize: '14px', marginBottom: '20px', lineHeight: 1.5 }}>
          Enter your OpenAI API key to generate flashcards with AI. Your key is stored locally in your browser and never sent to our servers.
        </p>
        <p style={{ color: '#64748b', fontSize: '13px', marginBottom: '16px' }}>
          Get your key at: <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" style={{ color: '#60a5fa' }}>platform.openai.com/api-keys</a>
        </p>
        <input
          type="password"
          placeholder="sk-..."
          value={key}
          onChange={e => setKey(e.target.value)}
          style={{ width: '100%', padding: '14px 16px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '14px', marginBottom: '20px', outline: 'none', fontFamily: 'monospace' }}
        />
        <div style={{ display: 'flex', gap: '12px' }}>
          <button onClick={onClose} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '14px', cursor: 'pointer' }}>
            Cancel
          </button>
          <button onClick={handleSave} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}>
            Save Key
          </button>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// HOME
// ============================================================
function Home({ decks, setActiveDeck, setView, user, openaiKey, setShowApiKeyModal, reloadDecks }) {
  const { signOut } = useAuth();
  const [showApiModal, setShowApiModal] = useState(false);
  const [deletingDeck, setDeletingDeck] = useState(null);

  const getDeckProgress = (deck) => {
    const progressKey = `progress_${deck.id}`;
    const progress = loadLocal(progressKey, {});
    const known = Object.values(progress).filter(v => v === 'known').length;
    return { known, total: deck.cards.length, percent: deck.cards.length > 0 ? Math.round((known / deck.cards.length) * 100) : 0 };
  };

  const handleDeleteDeck = async (deck) => {
    if (deck.isPreset) return;

    const { error } = await supabase.from('decks').delete().eq('id', deck.id);
    if (!error) {
      reloadDecks();
      setDeletingDeck(null);
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '40px 20px', fontFamily: 'system-ui' }}>
      {showApiModal && (
        <ApiKeyModal
          openaiKey={openaiKey}
          setOpenaiKey={(key) => { saveLocal('openai_api_key', key); window.location.reload(); }}
          onClose={() => setShowApiModal(false)}
        />
      )}

      {deletingDeck && (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', zIndex: 1000 }}>
          <div style={{ background: '#1e293b', borderRadius: '20px', padding: '32px', maxWidth: '400px', width: '100%', textAlign: 'center' }}>
            <h3 style={{ color: '#f1f5f9', marginBottom: '12px' }}>Delete "{deletingDeck.name}"?</h3>
            <p style={{ color: '#94a3b8', marginBottom: '24px' }}>This will permanently delete this deck and all its cards.</p>
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={() => setDeletingDeck(null)} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', cursor: 'pointer' }}>Cancel</button>
              <button onClick={() => handleDeleteDeck(deletingDeck)} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', background: '#ef4444', color: 'white', fontWeight: 600, cursor: 'pointer' }}>Delete</button>
            </div>
          </div>
        </div>
      )}

      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
          <div>
            <h1 style={{ fontSize: '28px', fontWeight: 700, color: '#60a5fa', marginBottom: '4px' }}>FlashLearn</h1>
            <p style={{ color: '#64748b', fontSize: '14px' }}>
              {user ? `Welcome, ${user.email.split('@')[0]}` : 'AI-powered flashcards'}
            </p>
          </div>
          {user ? (
            <button onClick={signOut} style={{ padding: '10px 16px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '13px', cursor: 'pointer' }}>
              Sign Out
            </button>
          ) : (
            <button onClick={() => setView('auth')} style={{ padding: '10px 16px', borderRadius: '10px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '13px', fontWeight: 600, cursor: 'pointer' }}>
              Sign In
            </button>
          )}
        </div>

        {/* Create with AI button */}
        <button
          onClick={() => {
            if (!openaiKey) {
              setShowApiModal(true);
            } else if (!user) {
              setView('auth');
            } else {
              setView('create');
            }
          }}
          style={{
            width: '100%', padding: '20px', borderRadius: '16px', border: '2px dashed rgba(96,165,250,0.5)',
            background: 'rgba(59,130,246,0.1)', color: '#60a5fa', fontSize: '16px', fontWeight: 600,
            cursor: 'pointer', marginBottom: '24px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px'
          }}
        >
          <span style={{ fontSize: '24px' }}>‚ú®</span>
          Create Deck with AI
        </button>

        {/* API Key status */}
        <button
          onClick={() => setShowApiModal(true)}
          style={{
            width: '100%', padding: '12px', borderRadius: '10px', border: 'none',
            background: openaiKey ? 'rgba(16,185,129,0.1)' : 'rgba(251,191,36,0.1)',
            color: openaiKey ? '#10b981' : '#fbbf24', fontSize: '13px', cursor: 'pointer', marginBottom: '24px'
          }}
        >
          {openaiKey ? '‚úì OpenAI API Key configured' : '‚ö† Set up OpenAI API Key to create decks'}
        </button>

        {/* Deck list */}
        <h2 style={{ color: '#94a3b8', fontSize: '13px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '16px' }}>
          Your Decks
        </h2>

        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {decks.map(deck => {
            const prog = getDeckProgress(deck);
            return (
              <div
                key={deck.id}
                style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '16px', padding: '20px', border: '1px solid rgba(100,116,139,0.2)', position: 'relative' }}
              >
                <div
                  onClick={() => { setActiveDeck(deck); setView('study'); }}
                  style={{ cursor: 'pointer' }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <span style={{ fontSize: '36px' }}>{deck.icon}</span>
                    <div style={{ flex: 1 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <h3 style={{ color: '#f1f5f9', fontSize: '18px', margin: 0 }}>{deck.name}</h3>
                        {deck.isPreset && <span style={{ background: 'rgba(100,116,139,0.3)', color: '#94a3b8', fontSize: '10px', padding: '2px 8px', borderRadius: '10px' }}>PRESET</span>}
                      </div>
                      <p style={{ color: '#64748b', margin: '4px 0 0', fontSize: '13px' }}>{deck.description}</p>
                    </div>
                  </div>
                  <div style={{ marginTop: '12px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{ flex: 1, height: '6px', background: 'rgba(255,255,255,0.1)', borderRadius: '3px', overflow: 'hidden' }}>
                      <div style={{ width: `${prog.percent}%`, height: '100%', background: prog.percent === 100 ? '#10b981' : '#3b82f6', borderRadius: '3px', transition: 'width 0.3s' }}></div>
                    </div>
                    <span style={{ color: '#64748b', fontSize: '12px', whiteSpace: 'nowrap' }}>{prog.known}/{prog.total} mastered</span>
                  </div>
                </div>

                {/* Delete button for custom decks */}
                {!deck.isPreset && (
                  <button
                    onClick={(e) => { e.stopPropagation(); setDeletingDeck(deck); }}
                    style={{ position: 'absolute', top: '16px', right: '16px', background: 'none', border: 'none', color: '#64748b', cursor: 'pointer', fontSize: '18px', padding: '4px' }}
                  >
                    üóë
                  </button>
                )}
              </div>
            );
          })}
        </div>

        {/* Footer */}
        <p style={{ textAlign: 'center', color: '#4b5563', fontSize: '12px', marginTop: '32px' }}>
          üéß All decks support headphone controls for hands-free learning
        </p>
      </div>
    </div>
  );
}

// ============================================================
// CREATE DECK WITH AI
// ============================================================
function CreateDeck({ setView, openaiKey, setShowApiKeyModal, user, reloadDecks }) {
  const [topic, setTopic] = useState('');
  const [numCards, setNumCards] = useState(10);
  const [messages, setMessages] = useState([]);
  const [loading, setLoading] = useState(false);
  const [generatedCards, setGeneratedCards] = useState([]);
  const [deckName, setDeckName] = useState('');
  const [saving, setSaving] = useState(false);
  const messagesEndRef = useRef(null);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const generateCards = async () => {
    if (!topic.trim()) return;

    setLoading(true);
    setMessages(prev => [...prev, { role: 'user', content: `Create ${numCards} flashcards about: ${topic}` }]);

    try {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${openaiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: `You are a flashcard generator. Create educational flashcards for studying.
              Return ONLY a valid JSON array with no markdown formatting, no code blocks, just raw JSON.
              Each card should have: category, front (question), back (detailed answer), source (credible reference).
              Make questions clear and answers comprehensive but concise.`
            },
            {
              role: 'user',
              content: `Create exactly ${numCards} flashcards about: ${topic}

              Return as JSON array: [{"category": "Topic Area", "front": "Question?", "back": "Detailed answer", "source": "Reference"}]`
            }
          ],
          temperature: 0.7
        })
      });

      const data = await response.json();

      if (data.error) {
        throw new Error(data.error.message);
      }

      let content = data.choices[0].message.content;

      // Clean up the response - remove markdown code blocks if present
      content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

      const cards = JSON.parse(content);

      setGeneratedCards(cards);
      setDeckName(topic);
      setMessages(prev => [...prev, {
        role: 'assistant',
        content: `I've generated ${cards.length} flashcards about "${topic}". Review them below and save when ready!`
      }]);

    } catch (err) {
      setMessages(prev => [...prev, {
        role: 'assistant',
        content: `Error: ${err.message}. Please check your API key and try again.`
      }]);
    }

    setLoading(false);
  };

  const saveDeck = async () => {
    if (!deckName.trim() || generatedCards.length === 0) return;

    setSaving(true);

    try {
      // Create deck
      const { data: deck, error: deckError } = await supabase
        .from('decks')
        .insert({
          user_id: user.id,
          name: deckName,
          icon: 'üìö',
          description: `AI-generated deck about ${topic}`
        })
        .select()
        .single();

      if (deckError) throw deckError;

      // Create cards
      const cardsToInsert = generatedCards.map(card => ({
        deck_id: deck.id,
        category: card.category,
        front: card.front,
        back: card.back,
        source: card.source
      }));

      const { error: cardsError } = await supabase
        .from('cards')
        .insert(cardsToInsert);

      if (cardsError) throw cardsError;

      await reloadDecks();
      setView('home');

    } catch (err) {
      alert('Error saving deck: ' + err.message);
    }

    setSaving(false);
  };

  const updateCard = (index, field, value) => {
    setGeneratedCards(prev => {
      const updated = [...prev];
      updated[index] = { ...updated[index], [field]: value };
      return updated;
    });
  };

  const deleteCard = (index) => {
    setGeneratedCards(prev => prev.filter((_, i) => i !== index));
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px', fontFamily: 'system-ui' }}>
      <div style={{ maxWidth: '600px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '24px' }}>
          <button onClick={() => setView('home')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', padding: '10px 16px', color: '#94a3b8', fontSize: '14px', cursor: 'pointer' }}>
            ‚Üê Back
          </button>
          <h1 style={{ color: '#f1f5f9', fontSize: '20px', margin: 0 }}>‚ú® Create with AI</h1>
        </div>

        {/* Chat messages */}
        <div style={{ background: 'rgba(30,41,59,0.8)', borderRadius: '16px', padding: '20px', marginBottom: '20px', minHeight: '150px', maxHeight: '300px', overflowY: 'auto' }}>
          {messages.length === 0 ? (
            <p style={{ color: '#64748b', textAlign: 'center', marginTop: '40px' }}>
              Tell me what topic you want to study, and I'll create flashcards for you!
            </p>
          ) : (
            messages.map((msg, i) => (
              <div key={i} style={{ marginBottom: '16px', textAlign: msg.role === 'user' ? 'right' : 'left' }}>
                <div style={{
                  display: 'inline-block', padding: '12px 16px', borderRadius: '12px', maxWidth: '85%',
                  background: msg.role === 'user' ? '#3b82f6' : 'rgba(255,255,255,0.1)',
                  color: '#f1f5f9', fontSize: '14px', lineHeight: 1.5
                }}>
                  {msg.content}
                </div>
              </div>
            ))
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Input area */}
        {generatedCards.length === 0 && (
          <div style={{ background: 'rgba(30,41,59,0.8)', borderRadius: '16px', padding: '20px', marginBottom: '20px' }}>
            <input
              type="text"
              placeholder="Enter a topic (e.g., Python data structures, World War 2, Organic Chemistry)"
              value={topic}
              onChange={e => setTopic(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && !loading && generateCards()}
              style={{ width: '100%', padding: '14px 16px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '15px', marginBottom: '12px', outline: 'none' }}
            />
            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
              <select
                value={numCards}
                onChange={e => setNumCards(parseInt(e.target.value))}
                style={{ padding: '12px 16px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '14px', outline: 'none' }}
              >
                <option value={5}>5 cards</option>
                <option value={10}>10 cards</option>
                <option value={15}>15 cards</option>
                <option value={20}>20 cards</option>
              </select>
              <button
                onClick={generateCards}
                disabled={loading || !topic.trim()}
                style={{ flex: 1, padding: '14px', borderRadius: '10px', border: 'none', background: loading ? '#64748b' : '#3b82f6', color: 'white', fontSize: '15px', fontWeight: 600, cursor: loading ? 'wait' : 'pointer' }}
              >
                {loading ? 'Generating...' : 'Generate Cards'}
              </button>
            </div>
          </div>
        )}

        {/* Generated cards preview */}
        {generatedCards.length > 0 && (
          <div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' }}>
              <input
                type="text"
                value={deckName}
                onChange={e => setDeckName(e.target.value)}
                placeholder="Deck name"
                style={{ flex: 1, padding: '12px 16px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '15px', outline: 'none' }}
              />
              <button
                onClick={saveDeck}
                disabled={saving}
                style={{ padding: '12px 24px', borderRadius: '10px', border: 'none', background: '#10b981', color: 'white', fontSize: '15px', fontWeight: 600, cursor: saving ? 'wait' : 'pointer' }}
              >
                {saving ? 'Saving...' : 'Save Deck'}
              </button>
            </div>

            <p style={{ color: '#94a3b8', fontSize: '13px', marginBottom: '16px' }}>
              {generatedCards.length} cards ‚Ä¢ Click any card to edit
            </p>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', maxHeight: '400px', overflowY: 'auto', paddingRight: '8px' }}>
              {generatedCards.map((card, i) => (
                <div key={i} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '16px', border: '1px solid rgba(100,116,139,0.2)' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px' }}>
                    <span style={{ color: '#60a5fa', fontSize: '11px', fontWeight: 600 }}>{card.category}</span>
                    <button onClick={() => deleteCard(i)} style={{ background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', fontSize: '14px' }}>‚úï</button>
                  </div>
                  <textarea
                    value={card.front}
                    onChange={e => updateCard(i, 'front', e.target.value)}
                    style={{ width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid rgba(100,116,139,0.2)', background: 'rgba(0,0,0,0.2)', color: '#f1f5f9', fontSize: '14px', marginBottom: '8px', resize: 'vertical', minHeight: '50px', outline: 'none' }}
                  />
                  <textarea
                    value={card.back}
                    onChange={e => updateCard(i, 'back', e.target.value)}
                    style={{ width: '100%', padding: '8px', borderRadius: '6px', border: '1px solid rgba(100,116,139,0.2)', background: 'rgba(0,0,0,0.2)', color: '#94a3b8', fontSize: '13px', resize: 'vertical', minHeight: '80px', outline: 'none' }}
                  />
                  <input
                    type="text"
                    value={card.source}
                    onChange={e => updateCard(i, 'source', e.target.value)}
                    placeholder="Source"
                    style={{ width: '100%', padding: '6px 8px', borderRadius: '6px', border: '1px solid rgba(100,116,139,0.2)', background: 'rgba(0,0,0,0.2)', color: '#64748b', fontSize: '12px', marginTop: '8px', outline: 'none' }}
                  />
                </div>
              ))}
            </div>

            <button
              onClick={() => { setGeneratedCards([]); setMessages([]); setTopic(''); }}
              style={{ width: '100%', marginTop: '16px', padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '14px', cursor: 'pointer' }}
            >
              Start Over
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================================
// STUDY
// ============================================================
function Study({ deck, setView, user }) {
  const [cardIndex, setCardIndex] = useState(0);
  const [showAnswer, setShowAnswer] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const [progress, setProgress] = useState(() => loadLocal(`progress_${deck.id}`, {}));
  const [favorites, setFavorites] = useState(() => loadLocal(`favorites_${deck.id}`, {}));
  const [shuffled, setShuffled] = useState(false);
  const [filter, setFilter] = useState('all');
  const [order, setOrder] = useState(() => deck.cards.map((_, i) => i));
  const [voice, setVoice] = useState(null);
  const [voices, setVoices] = useState([]);
  const [speed, setSpeed] = useState(0.9);
  const [phase, setPhase] = useState('idle');
  const [editingCard, setEditingCard] = useState(null);

  const timerRef = useRef(null);
  const utteranceRef = useRef(null);
  const isPlayingRef = useRef(false);

  const card = deck.cards[order[cardIndex]];
  const knownCount = Object.values(progress).filter(v => v === 'known').length;

  useEffect(() => {
    const loadVoices = () => {
      const allVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
      const premiumOrder = ['Samantha', 'Karen', 'Daniel', 'Moira', 'Google UK English Female', 'Google US English'];
      const sorted = [...allVoices].sort((a, b) => {
        const aIdx = premiumOrder.findIndex(p => a.name.includes(p));
        const bIdx = premiumOrder.findIndex(p => b.name.includes(p));
        return (bIdx >= 0 ? bIdx : -1) - (aIdx >= 0 ? aIdx : -1);
      });
      setVoices(sorted);
      if (sorted.length && !voice) setVoice(sorted[0]);
    };
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
  }, []);

  useEffect(() => {
    let indices = deck.cards.map((_, i) => i);
    if (filter === 'favorites') {
      indices = indices.filter(i => favorites[deck.cards[i].front]);
    }
    if (shuffled && indices.length > 0) {
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
    }
    setOrder(indices.length > 0 ? indices : deck.cards.map((_, i) => i));
    setCardIndex(0);
    setShowAnswer(false);
  }, [shuffled, filter, favorites]);

  useEffect(() => { saveLocal(`progress_${deck.id}`, progress); }, [progress]);
  useEffect(() => { saveLocal(`favorites_${deck.id}`, favorites); }, [favorites]);
  useEffect(() => { isPlayingRef.current = isPlaying; }, [isPlaying]);

  useEffect(() => {
    return () => {
      speechSynthesis.cancel();
      if (timerRef.current) clearTimeout(timerRef.current);
    };
  }, []);

  useEffect(() => {
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: card?.front?.slice(0, 60) || 'FlashLearn',
        artist: deck.name,
        album: `Card ${cardIndex + 1} of ${order.length}`,
      });
      navigator.mediaSession.setActionHandler('play', handlePlay);
      navigator.mediaSession.setActionHandler('pause', handleStop);
      navigator.mediaSession.setActionHandler('nexttrack', handleNext);
      navigator.mediaSession.setActionHandler('previoustrack', handlePrev);
      navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
    }
  }, [card, cardIndex, isPlaying]);

  const speak = (text) => {
    return new Promise((resolve) => {
      speechSynthesis.cancel();
      const processed = text.replace(/\. /g, '... ').replace(/\? /g, '?... ');
      const utterance = new SpeechSynthesisUtterance(processed);
      utterance.rate = speed;
      utterance.pitch = 1.05;
      if (voice) utterance.voice = voice;
      utterance.onend = () => resolve();
      utterance.onerror = () => resolve();
      utteranceRef.current = utterance;
      speechSynthesis.speak(utterance);
    });
  };

  const runAutoPlay = async (startIndex, startWithQuestion = true) => {
    let idx = startIndex;
    let doQuestion = startWithQuestion;
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      osc.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.01);
    } catch(e) {}

    while (true) {
      if (!isPlayingRef.current) break;
      const currentCard = deck.cards[order[idx]];
      if (doQuestion) {
        setCardIndex(idx);
        setShowAnswer(false);
        setPhase('speaking-q');
        await speak("Question... " + currentCard.front);
        if (!isPlayingRef.current) break;
        setPhase('pause-after-q');
        await new Promise(r => timerRef.current = setTimeout(r, 1500));
        if (!isPlayingRef.current) break;
      }
      setShowAnswer(true);
      setPhase('speaking-a');
      await speak("Answer... " + currentCard.back);
      if (!isPlayingRef.current) break;
      setPhase('pause-after-a');
      await new Promise(r => timerRef.current = setTimeout(r, 2500));
      if (!isPlayingRef.current) break;
      idx = (idx + 1) % order.length;
      doQuestion = true;
    }
    setPhase('idle');
  };

  const handlePlay = () => {
    setIsPlaying(true);
    isPlayingRef.current = true;
    runAutoPlay(cardIndex, !showAnswer);
  };

  const handleStop = () => {
    isPlayingRef.current = false;
    setIsPlaying(false);
    speechSynthesis.cancel();
    if (timerRef.current) clearTimeout(timerRef.current);
    setPhase('idle');
  };

  const handleNext = () => {
    const wasPlaying = isPlayingRef.current;
    handleStop();
    const nextIdx = (cardIndex + 1) % order.length;
    setCardIndex(nextIdx);
    setShowAnswer(false);
    if (wasPlaying) {
      setTimeout(() => {
        setIsPlaying(true);
        isPlayingRef.current = true;
        runAutoPlay(nextIdx, true);
      }, 100);
    }
  };

  const handlePrev = () => {
    const wasPlaying = isPlayingRef.current;
    handleStop();
    const prevIdx = (cardIndex - 1 + order.length) % order.length;
    setCardIndex(prevIdx);
    setShowAnswer(false);
    if (wasPlaying) {
      setTimeout(() => {
        setIsPlaying(true);
        isPlayingRef.current = true;
        runAutoPlay(prevIdx, true);
      }, 100);
    }
  };

  const handleReplay = () => {
    const wasPlaying = isPlayingRef.current;
    handleStop();
    setShowAnswer(false);
    setTimeout(() => {
      if (wasPlaying) {
        setIsPlaying(true);
        isPlayingRef.current = true;
        runAutoPlay(cardIndex, true);
      } else {
        speak("Question... " + card.front);
      }
    }, 100);
  };

  const handleFlip = () => {
    if (!isPlaying) setShowAnswer(!showAnswer);
  };

  const markCard = (status) => {
    setProgress(p => ({ ...p, [card.front]: status }));
  };

  const toggleFavorite = () => {
    setFavorites(f => {
      const newFavs = { ...f };
      if (newFavs[card.front]) delete newFavs[card.front];
      else newFavs[card.front] = true;
      return newFavs;
    });
  };

  const isFavorite = () => favorites[card?.front];
  const getStatus = () => progress[card?.front];
  const favCount = Object.keys(favorites).length;

  const renderSource = (source) => {
    if (!source) return null;
    const isUrl = source.startsWith('http');
    return (
      <div style={{ marginTop: '12px', paddingTop: '8px', borderTop: '1px solid rgba(255,255,255,0.1)', fontSize: '11px', color: '#64748b' }}>
        Source: {isUrl ? <a href={source} target="_blank" rel="noopener noreferrer" style={{ color: '#64748b', textDecoration: 'underline' }} onClick={e => e.stopPropagation()}>{source}</a> : source}
      </div>
    );
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '16px', fontFamily: 'system-ui', color: '#e2e8f0' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
          <button onClick={() => { handleStop(); setView('home'); }}
            style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '12px', padding: '12px 20px', color: '#94a3b8', fontSize: '16px', cursor: 'pointer' }}>
            ‚Üê Back
          </button>
          <div style={{ textAlign: 'center' }}>
            <div style={{ color: '#f1f5f9', fontWeight: 600 }}>Card {cardIndex + 1} / {order.length}</div>
            <div style={{ color: '#64748b', fontSize: '13px' }}>{knownCount} mastered ‚Ä¢ {favCount} favorited</div>
          </div>
          <div style={{ width: '80px' }}></div>
        </div>

        {/* Filters */}
        <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
          <button onClick={() => setFilter('all')}
            style={{ flex: 1, padding: '10px', borderRadius: '10px', border: 'none', fontWeight: 600, fontSize: '13px', cursor: 'pointer',
              background: filter === 'all' ? 'rgba(59,130,246,0.3)' : 'rgba(255,255,255,0.05)',
              color: filter === 'all' ? '#60a5fa' : '#64748b' }}>
            All ({deck.cards.length})
          </button>
          <button onClick={() => setFilter('favorites')}
            style={{ flex: 1, padding: '10px', borderRadius: '10px', border: 'none', fontWeight: 600, fontSize: '13px', cursor: 'pointer',
              background: filter === 'favorites' ? 'rgba(251,191,36,0.3)' : 'rgba(255,255,255,0.05)',
              color: filter === 'favorites' ? '#fbbf24' : '#64748b' }}>
            ‚òÖ Favorites ({favCount})
          </button>
        </div>

        {filter === 'favorites' && favCount === 0 ? (
          <div style={{ background: 'rgba(30,41,59,0.8)', borderRadius: '16px', padding: '40px 24px', textAlign: 'center' }}>
            <div style={{ fontSize: '48px', marginBottom: '16px' }}>‚òÖ</div>
            <h3 style={{ color: '#f1f5f9', marginBottom: '8px' }}>No favorites yet</h3>
            <p style={{ color: '#64748b', fontSize: '14px' }}>Tap the star on any card to add it</p>
            <button onClick={() => setFilter('all')} style={{ marginTop: '16px', padding: '12px 24px', borderRadius: '10px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: 600, cursor: 'pointer' }}>
              View All Cards
            </button>
          </div>
        ) : (
          <>
            {/* Playing indicator */}
            {isPlaying && (
              <div style={{ background: 'rgba(16,185,129,0.2)', borderRadius: '12px', padding: '12px 16px', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#10b981', animation: 'pulse 1.5s infinite' }}></div>
                <span style={{ color: '#10b981', fontWeight: 500 }}>
                  {phase === 'speaking-q' && 'Reading question...'}
                  {phase === 'pause-after-q' && 'Get ready for answer...'}
                  {phase === 'speaking-a' && 'Reading answer...'}
                  {phase === 'pause-after-a' && 'Moving to next card...'}
                </span>
              </div>
            )}

            {/* Card */}
            <div onClick={handleFlip} style={{
              position: 'relative',
              background: showAnswer ? 'linear-gradient(135deg, #064e3b, #065f46)' : 'linear-gradient(135deg, #1e3a5f, #1e40af)',
              borderRadius: '20px', padding: '24px', minHeight: '260px', display: 'flex', flexDirection: 'column',
              cursor: isPlaying ? 'default' : 'pointer',
              border: showAnswer ? '2px solid #10b981' : '2px solid #3b82f6', transition: 'all 0.3s ease'
            }}>
              <button onClick={e => { e.stopPropagation(); toggleFavorite(); }}
                style={{ position: 'absolute', top: '16px', right: '16px', background: 'none', border: 'none', fontSize: '28px', cursor: 'pointer', opacity: isFavorite() ? 1 : 0.4 }}>
                ‚òÖ
              </button>

              <div style={{ fontSize: '11px', fontWeight: 700, color: showAnswer ? '#6ee7b7' : '#93c5fd', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '16px' }}>
                {card?.category} ‚Ä¢ {showAnswer ? 'ANSWER' : 'QUESTION'}
              </div>

              <div style={{ flex: 1, fontSize: showAnswer ? '16px' : '20px', lineHeight: 1.6, color: '#f1f5f9' }}>
                {showAnswer ? card?.back : card?.front}
              </div>

              {renderSource(card?.source)}

              {!isPlaying && (
                <div style={{ marginTop: '12px', color: showAnswer ? '#6ee7b7' : '#93c5fd', fontSize: '13px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  Tap to {showAnswer ? 'see question' : 'reveal answer'}
                  {getStatus() && (
                    <span style={{
                      padding: '4px 12px', borderRadius: '20px', fontSize: '11px', fontWeight: 700,
                      background: getStatus() === 'known' ? 'rgba(16,185,129,0.3)' : 'rgba(251,191,36,0.3)',
                      color: getStatus() === 'known' ? '#6ee7b7' : '#fbbf24'
                    }}>
                      {getStatus() === 'known' ? '‚úì Mastered' : '‚óã Learning'}
                    </span>
                  )}
                </div>
              )}
            </div>

            {/* Mark buttons */}
            {!isPlaying && (
              <div style={{ display: 'flex', gap: '12px', marginTop: '16px' }}>
                <button onClick={() => markCard('learning')}
                  style={{ flex: 1, padding: '14px', borderRadius: '12px', border: 'none', fontWeight: 600, fontSize: '14px', cursor: 'pointer',
                    background: getStatus() === 'learning' ? '#f59e0b' : 'rgba(255,255,255,0.1)',
                    color: getStatus() === 'learning' ? 'white' : '#94a3b8' }}>
                  Still Learning
                </button>
                <button onClick={() => markCard('known')}
                  style={{ flex: 1, padding: '14px', borderRadius: '12px', border: 'none', fontWeight: 600, fontSize: '14px', cursor: 'pointer',
                    background: getStatus() === 'known' ? '#10b981' : 'rgba(255,255,255,0.1)',
                    color: getStatus() === 'known' ? 'white' : '#94a3b8' }}>
                  Got It ‚úì
                </button>
              </div>
            )}

            {/* Controls */}
            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '16px', marginTop: '24px' }}>
              <button onClick={handlePrev}
                style={{ width: '50px', height: '50px', borderRadius: '50%', background: 'rgba(255,255,255,0.1)', border: '2px solid rgba(255,255,255,0.2)', color: '#e2e8f0', fontSize: '24px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                ‚Äπ
              </button>
              <button onClick={handleReplay}
                style={{ width: '50px', height: '50px', borderRadius: '50%', background: 'rgba(251,191,36,0.2)', border: '2px solid rgba(251,191,36,0.4)', color: '#fbbf24', fontSize: '20px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                ‚Üª
              </button>
              <button onClick={isPlaying ? handleStop : handlePlay}
                style={{
                  width: '80px', height: '80px', borderRadius: '50%',
                  background: isPlaying ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 'linear-gradient(135deg, #10b981, #059669)',
                  border: 'none', color: 'white', fontSize: '32px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center',
                  boxShadow: isPlaying ? '0 0 30px rgba(239,68,68,0.5)' : '0 0 30px rgba(16,185,129,0.5)'
                }}>
                {isPlaying ? '‚èπ' : '‚ñ∂'}
              </button>
              <button onClick={handleNext}
                style={{ width: '50px', height: '50px', borderRadius: '50%', background: 'rgba(255,255,255,0.1)', border: '2px solid rgba(255,255,255,0.2)', color: '#e2e8f0', fontSize: '24px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                ‚Ä∫
              </button>
            </div>

            {/* Settings */}
            <div style={{ marginTop: '24px', background: 'rgba(30,41,59,0.8)', borderRadius: '16px', padding: '20px' }}>
              <div style={{ display: 'flex', flexWrap: 'wrap', gap: '16px', justifyContent: 'center', alignItems: 'center' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ color: '#94a3b8', fontSize: '13px' }}>Voice</span>
                  <select value={voice?.name || ''} onChange={e => setVoice(voices.find(v => v.name === e.target.value))}
                    style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', padding: '8px 12px', color: '#e2e8f0', fontSize: '13px', maxWidth: '140px' }}>
                    {voices.map(v => <option key={v.name} value={v.name}>{v.name.replace('Microsoft ', '').replace('Google ', '').slice(0, 18)}</option>)}
                  </select>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ color: '#94a3b8', fontSize: '13px' }}>Speed</span>
                  <select value={speed} onChange={e => setSpeed(parseFloat(e.target.value))}
                    style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', padding: '8px 12px', color: '#e2e8f0', fontSize: '13px' }}>
                    <option value={0.8}>Slow</option>
                    <option value={0.9}>Natural</option>
                    <option value={1.0}>Normal</option>
                    <option value={1.1}>Fast</option>
                  </select>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ color: '#94a3b8', fontSize: '13px' }}>Shuffle</span>
                  <button onClick={() => setShuffled(!shuffled)}
                    style={{ width: '50px', height: '28px', borderRadius: '14px', border: 'none', background: shuffled ? '#3b82f6' : 'rgba(255,255,255,0.1)', cursor: 'pointer', position: 'relative' }}>
                    <div style={{ position: 'absolute', top: '2px', left: shuffled ? '24px' : '2px', width: '24px', height: '24px', borderRadius: '50%', background: 'white', transition: 'left 0.2s' }}></div>
                  </button>
                </div>
              </div>
              <p style={{ textAlign: 'center', color: '#64748b', fontSize: '12px', marginTop: '16px', marginBottom: 0 }}>
                üéß Headphone controls supported
              </p>
            </div>
          </>
        )}
      </div>

      <style>{`
        @keyframes pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.5; transform: scale(0.9); }
        }
      `}</style>
    </div>
  );
}

// ============================================================
// RENDER
// ============================================================
ReactDOM.createRoot(document.getElementById('root')).render(
  <AuthProvider>
    <App />
  </AuthProvider>
);
  </script>
</body>
</html>
