<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlashLearn - GCSE Revision</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0f172a; font-family: system-ui, -apple-system, sans-serif; }
    input, textarea, select, button { font-family: inherit; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef, createContext, useContext } = React;

// Supabase
const SUPABASE_URL = 'https://bqtqmbyxdvinjbheykcc.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_wH-eykJr8kFDMinN29bQyg_rrhqoqlP';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Auth Context
const AuthContext = createContext(null);
function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user ?? null); setLoading(false); });
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_e, session) => setUser(session?.user ?? null));
    return () => subscription.unsubscribe();
  }, []);
  const signUp = async (email, password) => { const { error } = await supabase.auth.signUp({ email, password }); return { error }; };
  const signIn = async (email, password) => { const { error } = await supabase.auth.signInWithPassword({ email, password }); return { error }; };
  const signOut = async () => { await supabase.auth.signOut(); };
  return <AuthContext.Provider value={{ user, loading, signUp, signIn, signOut }}>{children}</AuthContext.Provider>;
}
const useAuth = () => useContext(AuthContext);

// Helpers
const saveLocal = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} };
const loadLocal = (k, d) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; } catch(e) { return d; } };

// FOLDER STRUCTURE
const FOLDERS = [
  {
    id: 'gcse', name: 'GCSE', icon: 'üéì', description: 'Complete GCSE revision',
    children: [
      { id: 'gcse-maths', name: 'Mathematics', icon: 'üìê', deckIds: ['maths-number', 'maths-algebra', 'maths-geometry', 'maths-stats'] },
      { id: 'gcse-sciences', name: 'Sciences', icon: 'üî¨', children: [
        { id: 'gcse-biology', name: 'Biology', icon: 'üß¨', deckIds: ['bio-cells', 'bio-organisation', 'bio-infection', 'bio-bioenergetics', 'bio-homeostasis', 'bio-inheritance', 'bio-ecology'] },
        { id: 'gcse-chemistry', name: 'Chemistry', icon: '‚öóÔ∏è', deckIds: ['chem-atomic', 'chem-bonding', 'chem-quantitative', 'chem-changes', 'chem-energy', 'chem-rates', 'chem-organic', 'chem-analysis', 'chem-atmosphere'] },
        { id: 'gcse-physics', name: 'Physics', icon: '‚ö°', deckIds: ['phys-energy', 'phys-electricity', 'phys-particles', 'phys-atomic', 'phys-forces', 'phys-waves', 'phys-magnetism', 'phys-space'] }
      ]},
      { id: 'gcse-english', name: 'English', icon: 'üìö', children: [
        { id: 'gcse-eng-lit', name: 'Literature', icon: 'üìñ', deckIds: ['lit-macbeth', 'lit-inspector', 'lit-christmas', 'lit-romeo', 'lit-poetry'] },
        { id: 'gcse-eng-lang', name: 'Language', icon: '‚úçÔ∏è', deckIds: ['lang-reading', 'lang-writing', 'lang-grammar', 'lang-devices'] }
      ]},
      { id: 'gcse-history', name: 'History', icon: 'üìú', deckIds: ['hist-elizabethan', 'hist-nazi', 'hist-medicine', 'hist-coldwar'] },
      { id: 'gcse-dt', name: 'Design & Technology', icon: 'üîß', deckIds: ['dt-materials', 'dt-processes', 'dt-systems'] }
    ]
  },
  {
    id: 'finance', name: 'Finance', icon: 'üí∞', description: 'Core financial concepts',
    deckIds: ['lbo', 'dcf', 'accounting']
  }
];

// DECK DATA - Starting with sample cards (will expand)
const DECKS = {
  // MATHS
  'maths-number': { id: 'maths-number', name: 'Number', icon: 'üî¢', cards: [
    { category: "Fractions", front: "How do you add fractions with different denominators?", back: "Find the lowest common denominator (LCD), convert each fraction to have this denominator, then add the numerators. Example: 1/4 + 1/3 = 3/12 + 4/12 = 7/12", source: "AQA GCSE Maths" },
    { category: "Percentages", front: "How do you find a percentage of an amount?", back: "Divide the percentage by 100 and multiply by the amount. Example: 15% of 80 = 0.15 √ó 80 = 12. Alternatively, find 10% and 5% then add them.", source: "AQA GCSE Maths" },
    { category: "Ratios", front: "How do you share an amount in a given ratio?", back: "Add the ratio parts to find total parts. Divide the amount by total parts to find one part. Multiply by each ratio number. Example: Share ¬£60 in ratio 2:3 ‚Üí 5 parts total, one part = ¬£12, answer = ¬£24:¬£36", source: "AQA GCSE Maths" },
    { category: "Standard Form", front: "What is standard form and when is it used?", back: "Standard form writes numbers as A √ó 10‚Åø where 1 ‚â§ A < 10. Used for very large or small numbers. Example: 45,000,000 = 4.5 √ó 10‚Å∑, 0.00032 = 3.2 √ó 10‚Åª‚Å¥", source: "AQA GCSE Maths" },
    { category: "Surds", front: "How do you simplify surds?", back: "Find the largest square factor and take its root outside. ‚àö50 = ‚àö(25√ó2) = 5‚àö2. To rationalise a denominator, multiply top and bottom by the surd: 1/‚àö3 = ‚àö3/3", source: "AQA GCSE Maths" },
    { category: "HCF & LCM", front: "How do you find the HCF and LCM of two numbers?", back: "HCF: Find prime factors, multiply common factors. LCM: Multiply all prime factors at highest powers. Example: 12=2¬≤√ó3, 18=2√ó3¬≤. HCF=2√ó3=6, LCM=2¬≤√ó3¬≤=36", source: "AQA GCSE Maths" },
    { category: "Indices", front: "What are the laws of indices?", back: "a·µê √ó a‚Åø = a·µê‚Å∫‚Åø, a·µê √∑ a‚Åø = a·µê‚Åª‚Åø, (a·µê)‚Åø = a·µê‚Åø, a‚Å∞ = 1, a‚Åª‚Åø = 1/a‚Åø, a^(1/n) = ‚Åø‚àöa", source: "AQA GCSE Maths" },
    { category: "Bounds", front: "What are upper and lower bounds?", back: "For a measurement rounded to a given degree, lower bound is 0.5 units below, upper bound is 0.5 units above. Example: 3.4m to 1dp has bounds 3.35m ‚â§ x < 3.45m", source: "AQA GCSE Maths" }
  ]},
  'maths-algebra': { id: 'maths-algebra', name: 'Algebra', icon: 'üìä', cards: [
    { category: "Equations", front: "How do you solve a linear equation?", back: "Isolate the variable by performing inverse operations on both sides. Example: 3x + 7 = 22 ‚Üí 3x = 15 ‚Üí x = 5. Always check by substituting back.", source: "AQA GCSE Maths" },
    { category: "Quadratics", front: "What are the three methods for solving quadratic equations?", back: "1) Factorising: x¬≤ + 5x + 6 = 0 ‚Üí (x+2)(x+3) = 0 ‚Üí x = -2 or -3. 2) Quadratic formula: x = (-b ¬± ‚àö(b¬≤-4ac))/2a. 3) Completing the square.", source: "AQA GCSE Maths" },
    { category: "Quadratics", front: "What is the quadratic formula?", back: "For ax¬≤ + bx + c = 0, x = (-b ¬± ‚àö(b¬≤-4ac)) / 2a. The discriminant b¬≤-4ac tells us: >0 means 2 real roots, =0 means 1 repeated root, <0 means no real roots.", source: "AQA GCSE Maths" },
    { category: "Sequences", front: "How do you find the nth term of an arithmetic sequence?", back: "nth term = a + (n-1)d where a is the first term and d is the common difference. Example: 3, 7, 11, 15... has a=3, d=4, so nth term = 3 + 4(n-1) = 4n - 1", source: "AQA GCSE Maths" },
    { category: "Graphs", front: "What is the equation of a straight line?", back: "y = mx + c where m is the gradient and c is the y-intercept. Gradient = rise/run = (y‚ÇÇ-y‚ÇÅ)/(x‚ÇÇ-x‚ÇÅ). Parallel lines have equal gradients. Perpendicular lines have gradients that multiply to -1.", source: "AQA GCSE Maths" },
    { category: "Inequalities", front: "How do you solve and represent inequalities?", back: "Solve like equations but flip the sign when multiplying/dividing by negative. On a number line: open circle for < or >, filled circle for ‚â§ or ‚â•. Example: 2x - 3 > 5 ‚Üí x > 4", source: "AQA GCSE Maths" },
    { category: "Simultaneous", front: "How do you solve simultaneous equations?", back: "Elimination: Make coefficients equal, add/subtract to eliminate one variable. Substitution: Rearrange one equation, substitute into other. Example: x + y = 7, 2x - y = 2 ‚Üí add to get 3x = 9, x = 3, y = 4", source: "AQA GCSE Maths" },
    { category: "Functions", front: "What does f‚Åª¬π(x) mean and how do you find it?", back: "f‚Åª¬π(x) is the inverse function - it reverses what f(x) does. To find it: replace f(x) with y, swap x and y, rearrange for y. Example: f(x) = 2x + 3 ‚Üí y = 2x + 3 ‚Üí x = 2y + 3 ‚Üí f‚Åª¬π(x) = (x-3)/2", source: "AQA GCSE Maths" }
  ]},
  'maths-geometry': { id: 'maths-geometry', name: 'Geometry', icon: 'üìê', cards: [
    { category: "Angles", front: "What are the angle rules for parallel lines?", back: "Corresponding angles are equal (F-shape). Alternate angles are equal (Z-shape). Co-interior/allied angles sum to 180¬∞ (C-shape).", source: "AQA GCSE Maths" },
    { category: "Pythagoras", front: "State Pythagoras' theorem and when to use it.", back: "a¬≤ + b¬≤ = c¬≤ where c is the hypotenuse. Use in right-angled triangles to find a missing side. To find hypotenuse: c = ‚àö(a¬≤ + b¬≤). To find shorter side: a = ‚àö(c¬≤ - b¬≤)", source: "AQA GCSE Maths" },
    { category: "Trigonometry", front: "What are SOHCAHTOA and when do you use each ratio?", back: "Sin = Opposite/Hypotenuse, Cos = Adjacent/Hypotenuse, Tan = Opposite/Adjacent. Use when you have a right-angled triangle with an angle. Label sides relative to the angle you're using.", source: "AQA GCSE Maths" },
    { category: "Circle Theorems", front: "State three key circle theorems.", back: "1) Angle at centre is twice angle at circumference. 2) Angle in a semicircle is 90¬∞. 3) Angles in the same segment are equal. 4) Opposite angles in cyclic quadrilateral sum to 180¬∞.", source: "AQA GCSE Maths" },
    { category: "Transformations", front: "Describe the four types of transformation.", back: "Rotation: needs centre, angle, direction. Reflection: needs mirror line equation. Translation: needs column vector. Enlargement: needs centre and scale factor (negative = invert through centre).", source: "AQA GCSE Maths" },
    { category: "Area", front: "What are the area formulas for common shapes?", back: "Triangle: ¬Ωbh or ¬Ωab sinC. Parallelogram: bh. Trapezium: ¬Ω(a+b)h. Circle: œÄr¬≤. Sector: (Œ∏/360)œÄr¬≤. For composite shapes, split into known shapes.", source: "AQA GCSE Maths" },
    { category: "Volume", front: "What are the volume formulas for 3D shapes?", back: "Prism: cross-section area √ó length. Cylinder: œÄr¬≤h. Cone: ‚ÖìœÄr¬≤h. Sphere: (4/3)œÄr¬≥. Pyramid: ‚Öì √ó base area √ó height.", source: "AQA GCSE Maths" },
    { category: "Vectors", front: "How do you add and subtract vectors?", back: "Add/subtract corresponding components. If a = (2,3) and b = (4,1), then a + b = (6,4). The vector from A to B is b - a. Parallel vectors are scalar multiples of each other.", source: "AQA GCSE Maths" }
  ]},
  'maths-stats': { id: 'maths-stats', name: 'Statistics & Probability', icon: 'üìà', cards: [
    { category: "Averages", front: "Define mean, median, mode and range.", back: "Mean: sum of values √∑ number of values. Median: middle value when ordered. Mode: most common value. Range: highest - lowest. For grouped data, use midpoints for mean.", source: "AQA GCSE Maths" },
    { category: "Probability", front: "How do you calculate probability?", back: "P(event) = favourable outcomes √∑ total outcomes. Probability is between 0 and 1. P(not A) = 1 - P(A). For independent events: P(A and B) = P(A) √ó P(B).", source: "AQA GCSE Maths" },
    { category: "Tree Diagrams", front: "When and how do you use a tree diagram?", back: "Use for multi-stage probability problems. Each branch shows an outcome and its probability. Multiply along branches for 'and'. Add final probabilities for 'or'. Branches from same point sum to 1.", source: "AQA GCSE Maths" },
    { category: "Sampling", front: "What is the difference between random and stratified sampling?", back: "Random: every item has equal chance of selection. Stratified: sample proportionally from each group. Stratified formula: (group size √∑ population) √ó sample size.", source: "AQA GCSE Maths" },
    { category: "Cumulative Frequency", front: "How do you draw and use a cumulative frequency graph?", back: "Plot cumulative totals against upper class boundaries. Join with smooth curve. Read median at n/2, LQ at n/4, UQ at 3n/4. IQR = UQ - LQ.", source: "AQA GCSE Maths" },
    { category: "Histograms", front: "How are histograms different from bar charts?", back: "Histograms have continuous data with no gaps. Frequency density = frequency √∑ class width. Area of bar represents frequency, not height. Bars can have different widths.", source: "AQA GCSE Maths" }
  ]},
  // BIOLOGY
  'bio-cells': { id: 'bio-cells', name: 'Cell Biology', icon: 'üî¨', cards: [
    { category: "Cell Structure", front: "What are the parts of an animal cell and their functions?", back: "Nucleus: contains DNA, controls cell. Cytoplasm: where reactions occur. Cell membrane: controls what enters/leaves. Mitochondria: aerobic respiration. Ribosomes: protein synthesis.", source: "AQA GCSE Biology" },
    { category: "Cell Structure", front: "What extra structures do plant cells have?", back: "Cell wall: made of cellulose, provides support. Vacuole: contains cell sap, maintains turgor. Chloroplasts: contain chlorophyll for photosynthesis. These are in addition to all animal cell parts.", source: "AQA GCSE Biology" },
    { category: "Microscopy", front: "How do you calculate magnification?", back: "Magnification = Image size √∑ Actual size. Rearrange to find any value. Convert units to be the same (usually Œºm). 1mm = 1000Œºm. Remember to use the formula triangle.", source: "AQA GCSE Biology" },
    { category: "Cell Division", front: "What happens during mitosis?", back: "Produces two identical diploid cells. Stages: DNA replicates, chromosomes line up, spindle fibres pull them apart, two nuclei form, cytoplasm divides. Used for growth, repair, and asexual reproduction.", source: "AQA GCSE Biology" },
    { category: "Cell Division", front: "What is the difference between mitosis and meiosis?", back: "Mitosis: 1 division, 2 identical diploid cells, for growth/repair. Meiosis: 2 divisions, 4 different haploid cells (gametes), introduces variation through crossing over and independent assortment.", source: "AQA GCSE Biology" },
    { category: "Transport", front: "Define diffusion, osmosis and active transport.", back: "Diffusion: net movement from high to low concentration. Osmosis: diffusion of water across partially permeable membrane. Active transport: movement against concentration gradient using energy from respiration.", source: "AQA GCSE Biology" },
    { category: "Specialised Cells", front: "How are sperm cells adapted for their function?", back: "Tail for swimming. Mitochondria for energy. Acrosome with enzymes to penetrate egg. Streamlined head. Haploid nucleus to combine with egg. Minimal cytoplasm to reduce weight.", source: "AQA GCSE Biology" },
    { category: "Stem Cells", front: "What are stem cells and why are they useful?", back: "Undifferentiated cells that can become specialised. Embryonic stem cells can become any cell type. Adult stem cells are more limited. Used to treat diseases like leukaemia. Ethical concerns about embryo use.", source: "AQA GCSE Biology" }
  ]},
  'bio-organisation': { id: 'bio-organisation', name: 'Organisation', icon: 'ü´Ä', cards: [
    { category: "Organisation", front: "What is the hierarchy of organisation in organisms?", back: "Cells ‚Üí Tissues ‚Üí Organs ‚Üí Organ systems ‚Üí Organism. Cells are the basic unit. Tissues are groups of similar cells. Organs contain different tissues. Organ systems work together.", source: "AQA GCSE Biology" },
    { category: "Digestive System", front: "What are the functions of digestive enzymes?", back: "Amylase: starch ‚Üí maltose (mouth, pancreas). Protease: proteins ‚Üí amino acids (stomach, pancreas). Lipase: fats ‚Üí fatty acids + glycerol (pancreas). Bile emulsifies fats, neutralises stomach acid.", source: "AQA GCSE Biology" },
    { category: "Heart", front: "Describe the structure of the heart.", back: "4 chambers: right/left atria and ventricles. Right side pumps deoxygenated blood to lungs. Left side pumps oxygenated blood to body. Left ventricle has thicker wall. Valves prevent backflow.", source: "AQA GCSE Biology" },
    { category: "Blood", front: "What are the components of blood and their functions?", back: "Red blood cells: carry oxygen using haemoglobin, no nucleus, biconcave shape. White blood cells: fight infection. Platelets: blood clotting. Plasma: carries dissolved substances, heat, hormones.", source: "AQA GCSE Biology" },
    { category: "Blood Vessels", front: "Compare arteries, veins and capillaries.", back: "Arteries: thick muscular walls, small lumen, carry blood away from heart. Veins: thinner walls, larger lumen, have valves. Capillaries: one cell thick, allow diffusion, connect arteries to veins.", source: "AQA GCSE Biology" },
    { category: "Plants", front: "What is transpiration and what affects its rate?", back: "Loss of water vapour from leaves through stomata. Increased by: light, heat, wind, low humidity. Stomata controlled by guard cells. Water moves up xylem by transpiration stream.", source: "AQA GCSE Biology" },
    { category: "Plants", front: "Describe translocation in plants.", back: "Movement of dissolved sugars in phloem. From source (leaves) to sink (roots, growing tips). Requires energy. Phloem has sieve plates and companion cells. Can move up or down plant.", source: "AQA GCSE Biology" }
  ]},
  'bio-infection': { id: 'bio-infection', name: 'Infection & Response', icon: 'ü¶†', cards: [
    { category: "Pathogens", front: "What are the four types of pathogen?", back: "Bacteria: very small cells, produce toxins. Viruses: not alive, replicate inside cells, cause cell damage. Fungi: cause skin conditions. Protists: often spread by vectors like mosquitoes.", source: "AQA GCSE Biology" },
    { category: "Defence", front: "How does the body prevent pathogens entering?", back: "Skin: physical barrier. Nose: hairs and mucus trap particles. Trachea: cilia and mucus move pathogens up. Stomach: acid kills microorganisms. Eyes: tears contain lysozyme.", source: "AQA GCSE Biology" },
    { category: "Immune System", front: "How do white blood cells fight infection?", back: "Phagocytes: engulf and digest pathogens (phagocytosis). Lymphocytes: produce antibodies specific to antigens, produce antitoxins, memory cells give immunity.", source: "AQA GCSE Biology" },
    { category: "Vaccination", front: "How do vaccines work?", back: "Inject dead/inactive pathogens. White blood cells produce antibodies. Memory cells remain in blood. If real pathogen enters, rapid secondary response produces antibodies quickly. Provides immunity.", source: "AQA GCSE Biology" },
    { category: "Antibiotics", front: "Why can't antibiotics treat viral infections?", back: "Antibiotics kill bacteria by interfering with their processes. Viruses live inside host cells and use host machinery. Antibiotics cannot target viruses without damaging host cells. Antivirals needed for viruses.", source: "AQA GCSE Biology" },
    { category: "Drug Development", front: "What are the stages of drug testing?", back: "1) Lab testing on cells/tissues. 2) Animal testing for safety and efficacy. 3) Clinical trials: Phase 1 (healthy volunteers, safety), Phase 2 (small patient group), Phase 3 (large trials). Double-blind with placebo.", source: "AQA GCSE Biology" },
    { category: "Diseases", front: "Describe how HIV leads to AIDS.", back: "HIV is a virus spread through body fluids. Attacks immune system, destroying lymphocytes. AIDS is late-stage HIV where immune system fails. Opportunistic infections then become dangerous. Controlled with antiretroviral drugs.", source: "AQA GCSE Biology" }
  ]},
  'bio-bioenergetics': { id: 'bio-bioenergetics', name: 'Bioenergetics', icon: 'üåø', cards: [
    { category: "Photosynthesis", front: "What is the equation for photosynthesis?", back: "Carbon dioxide + water ‚Üí glucose + oxygen. 6CO‚ÇÇ + 6H‚ÇÇO ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ. Requires light energy absorbed by chlorophyll. Occurs in chloroplasts.", source: "AQA GCSE Biology" },
    { category: "Photosynthesis", front: "What are the limiting factors of photosynthesis?", back: "Light intensity: rate increases until plateau. CO‚ÇÇ concentration: rate increases until plateau. Temperature: increases rate to optimum then decreases (enzymes denature). Any factor can limit rate.", source: "AQA GCSE Biology" },
    { category: "Photosynthesis", front: "How is glucose used by plants?", back: "Respiration: releases energy. Stored as starch: insoluble, for later use. Cellulose: for cell walls. Proteins: combined with nitrates for growth. Lipids: stored in seeds.", source: "AQA GCSE Biology" },
    { category: "Respiration", front: "What are the equations for aerobic and anaerobic respiration?", back: "Aerobic: glucose + oxygen ‚Üí CO‚ÇÇ + water (+ energy). C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ ‚Üí 6CO‚ÇÇ + 6H‚ÇÇO. Anaerobic in animals: glucose ‚Üí lactic acid. In plants/yeast: glucose ‚Üí ethanol + CO‚ÇÇ.", source: "AQA GCSE Biology" },
    { category: "Respiration", front: "Why is aerobic respiration more efficient than anaerobic?", back: "Aerobic completely breaks down glucose, releasing more ATP (around 38). Anaerobic only partially breaks down glucose, producing less ATP (2) and waste products. Anaerobic is faster but less efficient.", source: "AQA GCSE Biology" },
    { category: "Exercise", front: "What happens during exercise and recovery?", back: "During: increased heart rate, breathing rate, anaerobic respiration produces lactic acid. After: oxygen debt repaid, lactic acid broken down, heart rate gradually returns to normal.", source: "AQA GCSE Biology" }
  ]},
  'bio-homeostasis': { id: 'bio-homeostasis', name: 'Homeostasis', icon: 'üå°Ô∏è', cards: [
    { category: "Homeostasis", front: "What is homeostasis and why is it important?", back: "Maintaining a constant internal environment. Important because cells need optimal conditions for enzyme activity. Involves receptors detecting change, coordination centre, effectors (muscles/glands) responding.", source: "AQA GCSE Biology" },
    { category: "Nervous System", front: "Describe the reflex arc.", back: "Stimulus ‚Üí receptor ‚Üí sensory neurone ‚Üí relay neurone (in CNS) ‚Üí motor neurone ‚Üí effector ‚Üí response. Reflexes are rapid, automatic, protective. Synapses transmit signals using neurotransmitters.", source: "AQA GCSE Biology" },
    { category: "Hormones", front: "How is blood glucose controlled?", back: "Pancreas monitors blood glucose. High glucose: pancreas releases insulin, liver converts glucose to glycogen. Low glucose: pancreas releases glucagon, liver converts glycogen to glucose. Diabetes: Type 1 (no insulin), Type 2 (insulin resistance).", source: "AQA GCSE Biology" },
    { category: "Hormones", front: "What hormones control the menstrual cycle?", back: "FSH: stimulates egg development and oestrogen production. Oestrogen: repairs uterus lining, stimulates LH. LH: triggers ovulation. Progesterone: maintains uterus lining. If no pregnancy, progesterone drops and period starts.", source: "AQA GCSE Biology" },
    { category: "Hormones", front: "How do hormonal and barrier contraceptives work?", back: "Hormonal: contain hormones to prevent ovulation (pill, implant, injection). Barrier: physically prevent sperm reaching egg (condom, diaphragm). Only condoms prevent STIs.", source: "AQA GCSE Biology" },
    { category: "Kidneys", front: "What are the three main functions of the kidney?", back: "1) Filter blood: removes urea, excess water, excess ions. 2) Reabsorb useful substances: glucose, some water, some ions. 3) Form urine: contains urea, excess water and ions.", source: "AQA GCSE Biology" },
    { category: "Temperature", front: "How does the body regulate temperature?", back: "Too hot: vasodilation (blood vessels widen), sweating, hairs lie flat. Too cold: vasoconstriction (vessels narrow), shivering, hairs stand up. Thermoregulatory centre in brain monitors blood temperature.", source: "AQA GCSE Biology" }
  ]},
  'bio-inheritance': { id: 'bio-inheritance', name: 'Inheritance & Evolution', icon: 'üß¨', cards: [
    { category: "Genetics", front: "Define these key genetic terms: gene, allele, genotype, phenotype.", back: "Gene: section of DNA coding for a protein. Allele: different version of a gene. Genotype: the alleles an organism has. Phenotype: observable characteristics. Dominant alleles are expressed when present, recessive only when homozygous.", source: "AQA GCSE Biology" },
    { category: "Genetics", front: "How do you complete a Punnett square?", back: "Write parent alleles on edges (one parent top, one side). Combine alleles in each box. Count offspring genotypes and phenotypes. Calculate ratios. For monohybrid cross, expect 3:1 phenotype ratio.", source: "AQA GCSE Biology" },
    { category: "DNA", front: "Describe the structure of DNA.", back: "Double helix made of two strands. Backbone of sugar-phosphate. Bases in middle: A-T, C-G pairs (complementary). Sequence of bases codes for amino acids. Three bases = one triplet codon = one amino acid.", source: "AQA GCSE Biology" },
    { category: "Inheritance", front: "What is sex determination in humans?", back: "XX = female, XY = male. Sex chromosomes determine gender. Father determines sex of offspring (sperm carries X or Y). 50% chance of each sex. Use Punnett square to show.", source: "AQA GCSE Biology" },
    { category: "Evolution", front: "Explain Darwin's theory of natural selection.", back: "Variation exists within species. Individuals compete for resources. Better adapted individuals more likely to survive and reproduce. Advantageous alleles passed to offspring. Over generations, species evolve.", source: "AQA GCSE Biology" },
    { category: "Evolution", front: "What evidence supports evolution?", back: "Fossils: show gradual changes over time. Antibiotic resistance: observed evolution. DNA analysis: similarities between species show common ancestors. Comparative anatomy: homologous structures.", source: "AQA GCSE Biology" },
    { category: "Classification", front: "What is the Linnaean classification system?", back: "Kingdom ‚Üí Phylum ‚Üí Class ‚Üí Order ‚Üí Family ‚Üí Genus ‚Üí Species. Based on structure and characteristics. Species defined as organisms that can produce fertile offspring. Binomial naming: Genus species.", source: "AQA GCSE Biology" }
  ]},
  'bio-ecology': { id: 'bio-ecology', name: 'Ecology', icon: 'üåç', cards: [
    { category: "Ecosystems", front: "Define community, ecosystem, and interdependence.", back: "Community: all organisms in an area. Ecosystem: community plus abiotic (non-living) factors. Interdependence: species depend on each other for food, shelter, pollination, seed dispersal, etc.", source: "AQA GCSE Biology" },
    { category: "Sampling", front: "How do you use quadrats to estimate population size?", back: "Place quadrats randomly. Count organisms in each quadrat. Calculate mean per quadrat. Multiply by total area √∑ quadrat area. Use transects for distribution across an area.", source: "AQA GCSE Biology" },
    { category: "Food Chains", front: "What do pyramids of biomass show?", back: "Mass of living material at each trophic level. Generally pyramid shaped as energy lost between levels. Only about 10% of biomass passed on. Energy lost through respiration, waste, uneaten parts.", source: "AQA GCSE Biology" },
    { category: "Cycles", front: "Describe the carbon cycle.", back: "CO‚ÇÇ absorbed by photosynthesis. Carbon passed through food chain. Returned to air by respiration, combustion, decomposition. Decomposers break down dead matter. Carbon stored in fossil fuels.", source: "AQA GCSE Biology" },
    { category: "Human Impact", front: "How do humans affect biodiversity?", back: "Habitat destruction: deforestation, development. Pollution: water, air, land. Global warming: climate change affects habitats. Overexploitation: overfishing, hunting. Introduction of invasive species.", source: "AQA GCSE Biology" },
    { category: "Conservation", front: "What methods help maintain biodiversity?", back: "Breeding programmes for endangered species. Seed banks preserve plant genes. Wildlife reserves protect habitats. Hedgerow and field margin restoration. Reducing deforestation and pollution.", source: "AQA GCSE Biology" }
  ]},
  // Continue with more decks...
  'lbo': { id: 'lbo', name: 'LBO Modeling', icon: 'üè¶', cards: [
    { category: "LBO Basics", front: "What is a leveraged buyout?", back: "An acquisition of a company using a significant amount of borrowed money, typically 60 to 70 percent debt. Assets of the acquired company often serve as collateral. Goal is returns through debt paydown, EBITDA growth, and multiple expansion.", source: "Wall Street Prep" },
    { category: "LBO Basics", front: "What are the primary sources of returns in an LBO?", back: "Three main drivers: 1) Debt paydown using free cash flow. 2) EBITDA growth through revenue increases and margin expansion. 3) Multiple expansion if exit multiple exceeds entry. Debt paydown is most reliable.", source: "Wall Street Oasis" },
    { category: "Returns", front: "What is MOIC and how does it relate to IRR?", back: "MOIC = total value received √∑ total equity invested. A 2.0x means doubling your money. MOIC doesn't account for timing, IRR does. 2.5x over 3 years ‚âà 36% IRR, over 5 years ‚âà 20% IRR.", source: "Bain & Company" }
  ]},
  'dcf': { id: 'dcf', name: 'DCF Valuation', icon: 'üí∞', cards: [
    { category: "DCF Basics", front: "Walk through the steps of a DCF.", back: "1) Project unlevered FCF for 5-10 years. 2) Calculate terminal value. 3) Discount all cash flows to present using WACC. 4) Sum PVs for enterprise value. 5) Subtract net debt for equity value. 6) Divide by shares.", source: "Wall Street Prep" },
    { category: "WACC", front: "How do you calculate WACC?", back: "WACC = (E/V √ó Re) + (D/V √ó Rd √ó (1-T)). E = equity value, D = debt value, V = total. Re from CAPM. Rd is cost of debt. Tax shield makes debt cheaper.", source: "Brealey Myers" }
  ]},
  'accounting': { id: 'accounting', name: 'Accounting', icon: 'üìí', cards: [
    { category: "Statements", front: "What are the three main financial statements?", back: "Income statement: profitability over period. Balance sheet: assets, liabilities, equity at a point. Cash flow: cash movements. Net income flows to retained earnings and starts cash from operations.", source: "ASC" },
    { category: "Ratios", front: "What are key profitability ratios?", back: "Gross margin = GP/Revenue. Operating margin = EBIT/Revenue. Net margin = NI/Revenue. ROE = NI/Equity. ROA = NI/Assets. ROIC = NOPAT/Invested Capital.", source: "CFA Institute" }
  ]},
  // CHEMISTRY - Sample
  'chem-atomic': { id: 'chem-atomic', name: 'Atomic Structure', icon: '‚öõÔ∏è', cards: [
    { category: "Atoms", front: "What are the subatomic particles and their properties?", back: "Protons: mass 1, charge +1, in nucleus. Neutrons: mass 1, charge 0, in nucleus. Electrons: mass ~0, charge -1, in shells. Atomic number = protons. Mass number = protons + neutrons.", source: "AQA GCSE Chemistry" },
    { category: "Periodic Table", front: "How is the periodic table arranged?", back: "Rows = periods (electron shells). Columns = groups (outer electrons). Group 1 = alkali metals (1 outer e‚Åª). Group 7 = halogens (7 outer e‚Åª). Group 0 = noble gases (full outer shell).", source: "AQA GCSE Chemistry" },
    { category: "Electron Config", front: "How do you work out electron configuration?", back: "Fill shells from inside out. 1st shell: max 2. 2nd shell: max 8. 3rd shell: max 8 (for GCSE). Example: Sodium (11): 2,8,1. This determines chemical properties.", source: "AQA GCSE Chemistry" }
  ]},
  'chem-bonding': { id: 'chem-bonding', name: 'Bonding', icon: 'üîó', cards: [
    { category: "Ionic", front: "What is ionic bonding?", back: "Transfer of electrons between metal and non-metal. Metal loses electrons ‚Üí positive ion (cation). Non-metal gains electrons ‚Üí negative ion (anion). Strong electrostatic attraction between oppositely charged ions.", source: "AQA GCSE Chemistry" },
    { category: "Covalent", front: "What is covalent bonding?", back: "Sharing of electron pairs between non-metals. Each atom contributes electrons to shared pair. Single bond = 1 pair, double = 2 pairs. Can form simple molecules or giant covalent structures.", source: "AQA GCSE Chemistry" },
    { category: "Properties", front: "Compare properties of ionic and covalent compounds.", back: "Ionic: high MP/BP, conduct when molten/dissolved, form crystals. Simple covalent: low MP/BP, don't conduct, often gases/liquids. Giant covalent (diamond, graphite): very high MP, hard.", source: "AQA GCSE Chemistry" }
  ]},
  // PHYSICS - Sample
  'phys-energy': { id: 'phys-energy', name: 'Energy', icon: '‚ö°', cards: [
    { category: "Energy Stores", front: "What are the main energy stores?", back: "Kinetic: moving objects. Gravitational potential: raised objects. Elastic potential: stretched/compressed. Chemical: fuels, food, batteries. Thermal: hot objects. Nuclear: atoms. Magnetic. Electrostatic.", source: "AQA GCSE Physics" },
    { category: "Transfers", front: "How is energy transferred between stores?", back: "Mechanically (by forces). Electrically (by current). By heating. By radiation (light, sound). Energy is conserved - total stays same but spreads out. Dissipated energy is 'wasted' to surroundings.", source: "AQA GCSE Physics" },
    { category: "Efficiency", front: "How do you calculate efficiency?", back: "Efficiency = useful output √∑ total input √ó 100%. Always less than 100% due to waste. Can reduce waste with lubrication, insulation, streamlining. Sankey diagrams show energy transfers.", source: "AQA GCSE Physics" }
  ]},
  'phys-electricity': { id: 'phys-electricity', name: 'Electricity', icon: 'üîå', cards: [
    { category: "Current", front: "What is electric current and how is it related to charge?", back: "Current is flow of charge (electrons in metals). I = Q/t (current = charge √∑ time). Measured in amps (A). Charge in coulombs (C). Conventional current flows from + to -.", source: "AQA GCSE Physics" },
    { category: "Circuits", front: "Compare series and parallel circuits.", back: "Series: one path, current same throughout, voltages add up. Parallel: multiple paths, current splits, voltage same across each branch. Total resistance: series add, parallel 1/R = 1/R‚ÇÅ + 1/R‚ÇÇ.", source: "AQA GCSE Physics" },
    { category: "Ohm's Law", front: "State Ohm's Law and how to use it.", back: "V = IR (voltage = current √ó resistance). Applies to ohmic conductors (constant temperature). Resistance in ohms (Œ©). Rearrange to find any value. I-V graphs show relationship.", source: "AQA GCSE Physics" }
  ]},
  // ENGLISH LIT - Sample
  'lit-macbeth': { id: 'lit-macbeth', name: 'Macbeth', icon: 'üó°Ô∏è', cards: [
    { category: "Context", front: "What historical context is important for Macbeth?", back: "Written 1606, shortly after Gunpowder Plot. James I was Scottish, believed in witches, wrote about them. Divine Right of Kings meant regicide was against God. Play flatters James - shows dangers of killing a king.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How is Macbeth presented as a tragic hero?", back: "Starts noble ('brave Macbeth'). Hamartia (fatal flaw) is ambition. Influenced by witches and Lady Macbeth. Makes choice to kill Duncan. Descends into tyranny. Dies fighting - some honour restored.", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How is the theme of ambition explored in Macbeth?", back: "Macbeth's 'vaulting ambition' leads to his downfall. Lady Macbeth's ambition makes her 'unsex' herself. Ambition corrupts - shown through imagery of disease and blood. Contrasted with Banquo who resists temptation.", source: "AQA GCSE English Lit" },
    { category: "Quotes", front: "Analyse: 'Look like th'innocent flower, But be the serpent under't'", back: "Lady Macbeth tells Macbeth to deceive Duncan. Flower = innocence, beauty. Serpent = evil, Biblical reference to Satan. Shows her manipulation and the theme of appearance vs reality. Imperative verbs show her control.", source: "AQA GCSE English Lit" }
  ]},
  'lit-inspector': { id: 'lit-inspector', name: 'An Inspector Calls', icon: 'üîç', cards: [
    { category: "Context", front: "Why did Priestley set the play in 1912 but write it in 1945?", back: "1912: before WWI, Titanic sinking - audience knows characters' confidence is misplaced. 1945: after WWII, people wanted social change. Priestley wanted socialism, welfare state. Dramatic irony throughout.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How is Mr Birling presented and what does he represent?", back: "Capitalist businessman, pompous, wrong about everything. Represents older generation, selfishness, capitalism. 'A man has to mind his own business.' His predictions are dramatically ironic. Doesn't learn from Inspector.", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How does Priestley present social responsibility?", back: "Inspector's message: 'We are members of one body. We are responsible for each other.' Younger generation (Sheila, Eric) accept this. Older generation reject it. Priestley wants audience to agree with Inspector.", source: "AQA GCSE English Lit" }
  ]},
  // HISTORY - Sample
  'hist-elizabethan': { id: 'hist-elizabethan', name: 'Elizabethan England', icon: 'üëë', cards: [
    { category: "Challenges", front: "What challenges did Elizabeth face when she became queen?", back: "Gender: women seen as weak. Legitimacy: some thought she was illegitimate. Religion: Catholic vs Protestant divide. Marriage: pressure to marry and produce heir. Foreign threats: France, Spain. Succession: no named heir.", source: "AQA GCSE History" },
    { category: "Religion", front: "What was the Religious Settlement of 1559?", back: "Middle way between Catholics and Protestants. Act of Supremacy: Elizabeth = Supreme Governor. Act of Uniformity: new Book of Common Prayer. Clergy had to take oath of allegiance. Some Catholic elements kept (vestments).", source: "AQA GCSE History" },
    { category: "Mary Queen of Scots", front: "Why was Mary Queen of Scots a threat to Elizabeth?", back: "Catholic heir to English throne. Legitimate in Catholic eyes (Elizabeth was illegitimate). Fled to England 1568. Focus of Catholic plots (Ridolfi, Throckmorton, Babington). Executed 1587 after Babington Plot.", source: "AQA GCSE History" }
  ]},
  'hist-nazi': { id: 'hist-nazi', name: 'Nazi Germany', icon: 'üìú', cards: [
    { category: "Rise", front: "How did Hitler become Chancellor in 1933?", back: "Depression created unemployment, discontent. Nazi vote rose: 37% July 1932. Hindenburg refused Hitler but couldn't find stable government. Von Papen convinced Hindenburg Nazis could be controlled. Hitler appointed 30 Jan 1933.", source: "AQA GCSE History" },
    { category: "Control", front: "How did the Nazis consolidate power in 1933-34?", back: "Reichstag Fire: blamed Communists, emergency decree. Enabling Act: Hitler could pass laws without Reichstag. Trade unions banned. Political parties banned. Night of Long Knives: SA leaders killed. Hindenburg died: Hitler became F√ºhrer.", source: "AQA GCSE History" },
    { category: "Terror", front: "How did the Nazis use terror to control Germany?", back: "SS: elite, ran concentration camps. Gestapo: secret police, encouraged informers. Concentration camps for 'enemies'. Block wardens spied on neighbourhoods. Fear of arrest kept people silent.", source: "AQA GCSE History" }
  ]},
  'hist-medicine': { id: 'hist-medicine', name: 'Medicine Through Time', icon: 'üè•', cards: [
    { category: "Medieval", front: "What did people believe caused disease in medieval times?", back: "Four humours (blood, phlegm, yellow bile, black bile) - needed balance. Miasma (bad air). God's punishment for sin. Astrology and alignment of planets. Some believed in supernatural causes.", source: "AQA GCSE History" },
    { category: "19th Century", front: "Why was Pasteur's Germ Theory (1861) so significant?", back: "Proved microorganisms cause decay (not spontaneous generation). Led to understanding germs cause disease. Koch identified specific bacteria. Allowed development of vaccines, antiseptics. Changed approach from symptoms to causes.", source: "AQA GCSE History" }
  ]},
  'hist-coldwar': { id: 'hist-coldwar', name: 'Cold War', icon: 'üåç', cards: [
    { category: "Origins", front: "Why did the Cold War begin after WWII?", back: "Ideological differences: capitalism vs communism. Soviet expansion in Eastern Europe. Atomic bomb ended cooperation. Truman Doctrine and Marshall Plan seen as aggressive. Iron Curtain divided Europe.", source: "AQA GCSE History" }
  ]},
  // D&T - Sample
  'dt-materials': { id: 'dt-materials', name: 'Materials', icon: 'ü™µ', cards: [
    { category: "Woods", front: "Compare hardwoods and softwoods.", back: "Hardwoods: from deciduous trees (oak, mahogany), slower growing, more expensive, often harder. Softwoods: from coniferous trees (pine, spruce), faster growing, cheaper, often softer. Names refer to tree type, not hardness.", source: "AQA GCSE DT" },
    { category: "Metals", front: "What are ferrous and non-ferrous metals?", back: "Ferrous: contain iron, magnetic, can rust. Examples: steel, cast iron. Non-ferrous: no iron, don't rust. Examples: aluminium, copper, brass, zinc. Alloys combine properties of different metals.", source: "AQA GCSE DT" },
    { category: "Polymers", front: "What is the difference between thermoplastics and thermosetting plastics?", back: "Thermoplastics: can be reheated and reshaped, recyclable. Examples: acrylic, PVC, polythene. Thermosetting: cannot be reshaped once set, heat resistant. Examples: epoxy resin, melamine.", source: "AQA GCSE DT" }
  ]},
  'dt-processes': { id: 'dt-processes', name: 'Processes', icon: '‚öôÔ∏è', cards: [
    { category: "Cutting", front: "What are the main cutting processes?", back: "Sawing: for wood and metal. Shearing: cutting sheet metal. Laser cutting: precise, computer controlled. Drilling: making holes. Milling: removing material with rotating cutter. Turning: on a lathe.", source: "AQA GCSE DT" }
  ]},
  'dt-systems': { id: 'dt-systems', name: 'Systems', icon: 'üîå', cards: [
    { category: "Electronics", front: "What are the parts of an electronic system?", back: "Input: sensors (LDR, thermistor, switch). Process: microcontroller, logic gates, comparators. Output: LED, motor, buzzer, speaker. Power supply provides energy. Signals can be analogue or digital.", source: "AQA GCSE DT" }
  ]},
  // CHEMISTRY - Quantitative
  'chem-quantitative': { id: 'chem-quantitative', name: 'Quantitative Chemistry', icon: '‚öñÔ∏è', cards: [
    { category: "Moles", front: "What is the mole and Avogadro's number?", back: "A mole is 6.02 √ó 10¬≤¬≥ particles (atoms, molecules, or ions). This is Avogadro's number. One mole of any substance has this many particles. Molar mass (g/mol) equals relative formula mass.", source: "AQA GCSE Chemistry" },
    { category: "Moles", front: "How do you calculate moles from mass?", back: "Moles = mass (g) √∑ molar mass (g/mol). Example: 24g of carbon (Mr = 12): moles = 24 √∑ 12 = 2 mol. Rearrange to find mass: mass = moles √ó molar mass.", source: "AQA GCSE Chemistry" },
    { category: "Equations", front: "How do you balance a chemical equation?", back: "1) Write unbalanced equation with formulas. 2) Count atoms each side. 3) Add coefficients to balance (never change formulas). 4) Check all atoms balance. 5) State symbols: (s), (l), (g), (aq).", source: "AQA GCSE Chemistry" },
    { category: "Concentration", front: "How do you calculate concentration?", back: "Concentration (g/dm¬≥) = mass of solute (g) √∑ volume (dm¬≥). For mol/dm¬≥: concentration = moles √∑ volume. 1 dm¬≥ = 1000 cm¬≥. Convert by dividing cm¬≥ by 1000.", source: "AQA GCSE Chemistry" },
    { category: "Yield", front: "What is percentage yield and why is it less than 100%?", back: "Percentage yield = (actual yield √∑ theoretical yield) √ó 100%. Less than 100% because: reaction incomplete, product lost in transfer, side reactions occur, purification loses some product.", source: "AQA GCSE Chemistry" },
    { category: "Atom Economy", front: "What is atom economy and why does it matter?", back: "Atom economy = (Mr of desired product √∑ Mr of all products) √ó 100%. High atom economy means less waste. Important for sustainability and cost. Addition reactions have 100% atom economy.", source: "AQA GCSE Chemistry" }
  ]},
  // CHEMISTRY - Chemical Changes
  'chem-changes': { id: 'chem-changes', name: 'Chemical Changes', icon: 'üß™', cards: [
    { category: "Reactivity", front: "What is the reactivity series?", back: "Order (most to least reactive): Potassium, Sodium, Calcium, Magnesium, Aluminium, Carbon, Zinc, Iron, Hydrogen, Copper, Silver, Gold. Remember: Please Stop Calling Me A Cute Zebra I Hate Copper's Silly Games.", source: "AQA GCSE Chemistry" },
    { category: "Reactivity", front: "How do you use the reactivity series to predict reactions?", back: "More reactive metal displaces less reactive from compound. Example: Mg + CuSO‚ÇÑ ‚Üí MgSO‚ÇÑ + Cu (Mg more reactive). Carbon and hydrogen are reference points. Metals above carbon extracted by electrolysis.", source: "AQA GCSE Chemistry" },
    { category: "Acids", front: "What are the products of acids reacting with metals, bases, and carbonates?", back: "Metal + acid ‚Üí salt + hydrogen. Base + acid ‚Üí salt + water. Carbonate + acid ‚Üí salt + water + carbon dioxide. Salt name depends on acid: HCl = chloride, H‚ÇÇSO‚ÇÑ = sulfate, HNO‚ÇÉ = nitrate.", source: "AQA GCSE Chemistry" },
    { category: "Acids", front: "What is pH and how do strong and weak acids differ?", back: "pH measures acidity: <7 acidic, 7 neutral, >7 alkaline. Strong acids (HCl, H‚ÇÇSO‚ÇÑ, HNO‚ÇÉ) fully ionise. Weak acids (citric, ethanoic) partially ionise. Strong acids have lower pH at same concentration.", source: "AQA GCSE Chemistry" },
    { category: "Electrolysis", front: "What is electrolysis and what happens at each electrode?", back: "Breaking down ionic compound using electricity. Requires molten or dissolved compound (ions must move). Cathode (-): positive ions gain electrons (reduction). Anode (+): negative ions lose electrons (oxidation). OILRIG.", source: "AQA GCSE Chemistry" },
    { category: "Electrolysis", front: "What products form when electrolyzing aqueous solutions?", back: "At cathode: hydrogen unless metal is less reactive than hydrogen. At anode: oxygen unless halide present (then halogen). Example: NaCl(aq) gives H‚ÇÇ at cathode, Cl‚ÇÇ at anode.", source: "AQA GCSE Chemistry" }
  ]},
  // CHEMISTRY - Energy Changes
  'chem-energy': { id: 'chem-energy', name: 'Energy Changes', icon: 'üî•', cards: [
    { category: "Energy", front: "What is the difference between exothermic and endothermic reactions?", back: "Exothermic: releases energy, temperature rises, negative ŒîH. Examples: combustion, neutralisation. Endothermic: absorbs energy, temperature falls, positive ŒîH. Examples: thermal decomposition, photosynthesis.", source: "AQA GCSE Chemistry" },
    { category: "Energy", front: "How do reaction profiles show exothermic and endothermic reactions?", back: "Y-axis: energy, X-axis: progress. Exothermic: products lower than reactants. Endothermic: products higher. Activation energy is the 'hill' to climb. Catalysts lower activation energy peak.", source: "AQA GCSE Chemistry" },
    { category: "Bonds", front: "How do bond energies explain energy changes?", back: "Breaking bonds: endothermic (needs energy). Making bonds: exothermic (releases energy). Overall: if more energy released making bonds than breaking, reaction is exothermic. Calculate using bond energy values.", source: "AQA GCSE Chemistry" },
    { category: "Cells", front: "What is a simple electrochemical cell?", back: "Two different metals in electrolyte create voltage. More reactive metal is negative electrode. Voltage depends on reactivity difference. Batteries are cells: chemical energy ‚Üí electrical energy.", source: "AQA GCSE Chemistry" }
  ]},
  // CHEMISTRY - Rates
  'chem-rates': { id: 'chem-rates', name: 'Rates & Equilibrium', icon: '‚è±Ô∏è', cards: [
    { category: "Rates", front: "What factors affect the rate of reaction?", back: "1) Temperature: higher = faster (more energy, more collisions). 2) Concentration: higher = faster (more particles). 3) Surface area: larger = faster (more exposed). 4) Catalyst: speeds up without being used up.", source: "AQA GCSE Chemistry" },
    { category: "Rates", front: "Explain collision theory.", back: "Particles must collide with sufficient energy (activation energy) and correct orientation. Increasing factors that increase successful collisions increases rate. Not all collisions are successful.", source: "AQA GCSE Chemistry" },
    { category: "Rates", front: "How does a catalyst work?", back: "Provides alternative reaction pathway with lower activation energy. More particles have enough energy to react. Not used up, can be reused. Different reactions need different catalysts.", source: "AQA GCSE Chemistry" },
    { category: "Equilibrium", front: "What is dynamic equilibrium?", back: "In a closed system, reversible reaction reaches equilibrium when forward and reverse rates are equal. Concentrations constant but reactions still occurring. Position can shift left or right.", source: "AQA GCSE Chemistry" },
    { category: "Equilibrium", front: "What is Le Chatelier's principle?", back: "If conditions change, equilibrium shifts to oppose the change. Increase temperature: shifts to endothermic side. Increase pressure: shifts to side with fewer gas molecules. Increase concentration: shifts away from that side.", source: "AQA GCSE Chemistry" }
  ]},
  // CHEMISTRY - Organic
  'chem-organic': { id: 'chem-organic', name: 'Organic Chemistry', icon: 'üõ¢Ô∏è', cards: [
    { category: "Hydrocarbons", front: "What is crude oil and how is it separated?", back: "Crude oil is a mixture of hydrocarbons. Separated by fractional distillation: heated, vapours rise up column, condense at different heights based on boiling point. Smaller molecules have lower boiling points, rise higher.", source: "AQA GCSE Chemistry" },
    { category: "Alkanes", front: "What are alkanes and their general formula?", back: "Alkanes: saturated hydrocarbons (only single C-C bonds). General formula: C‚ÇôH‚ÇÇ‚Çô‚Çä‚ÇÇ. Methane CH‚ÇÑ, ethane C‚ÇÇH‚ÇÜ, propane C‚ÇÉH‚Çà, butane C‚ÇÑH‚ÇÅ‚ÇÄ. Relatively unreactive, used as fuels.", source: "AQA GCSE Chemistry" },
    { category: "Combustion", front: "What are the products of complete and incomplete combustion?", back: "Complete (plenty of oxygen): hydrocarbon + O‚ÇÇ ‚Üí CO‚ÇÇ + H‚ÇÇO. Incomplete (limited oxygen): produces carbon monoxide (toxic) and/or soot (carbon). Incomplete wastes fuel and is dangerous.", source: "AQA GCSE Chemistry" },
    { category: "Cracking", front: "What is cracking and why is it useful?", back: "Breaking long-chain hydrocarbons into shorter, more useful ones. Thermal cracking: high temperature, high pressure. Catalytic cracking: catalyst, slight pressure. Produces alkenes (used for polymers) and shorter alkanes.", source: "AQA GCSE Chemistry" },
    { category: "Alkenes", front: "What are alkenes and how do you test for them?", back: "Alkenes: unsaturated hydrocarbons (C=C double bond). General formula: C‚ÇôH‚ÇÇ‚Çô. Ethene C‚ÇÇH‚ÇÑ, propene C‚ÇÉH‚ÇÜ. Test: bromine water turns from orange to colourless. More reactive than alkanes.", source: "AQA GCSE Chemistry" },
    { category: "Polymers", front: "How are addition polymers formed?", back: "Many alkene monomers join together. Double bonds open up and link. No other product (100% atom economy). Example: ethene ‚Üí poly(ethene). Properties depend on monomer and conditions.", source: "AQA GCSE Chemistry" }
  ]},
  // CHEMISTRY - Analysis
  'chem-analysis': { id: 'chem-analysis', name: 'Chemical Analysis', icon: 'üî¨', cards: [
    { category: "Purity", front: "What is a pure substance in chemistry?", back: "Single element or compound, not mixed with anything else. Has specific melting/boiling point. Mixtures melt/boil over a range. Impurities lower melting point, raise boiling point.", source: "AQA GCSE Chemistry" },
    { category: "Chromatography", front: "How does chromatography work?", back: "Separates mixtures based on how substances move through stationary phase (paper) carried by mobile phase (solvent). Different substances travel different distances. Rf = distance substance √∑ distance solvent.", source: "AQA GCSE Chemistry" },
    { category: "Gas Tests", front: "How do you test for common gases?", back: "Hydrogen: squeaky pop with lit splint. Oxygen: relights glowing splint. Carbon dioxide: turns limewater milky. Chlorine: bleaches damp litmus paper white.", source: "AQA GCSE Chemistry" },
    { category: "Ion Tests", front: "How do you test for carbonate, halide, and sulfate ions?", back: "Carbonates: add acid, test gas with limewater (fizzes, turns milky). Halides: add silver nitrate: Cl‚Åª white, Br‚Åª cream, I‚Åª yellow precipitate. Sulfates: add barium chloride, white precipitate.", source: "AQA GCSE Chemistry" }
  ]},
  // CHEMISTRY - Atmosphere
  'chem-atmosphere': { id: 'chem-atmosphere', name: 'Atmosphere', icon: 'üå´Ô∏è', cards: [
    { category: "Composition", front: "What is the composition of Earth's atmosphere today?", back: "Approximately 78% nitrogen, 21% oxygen, 0.9% argon, 0.04% carbon dioxide. Plus variable amounts of water vapour. This has been stable for about 200 million years.", source: "AQA GCSE Chemistry" },
    { category: "History", front: "How did Earth's early atmosphere form and change?", back: "Early atmosphere from volcanic activity: mostly CO‚ÇÇ and water vapour. Oceans formed as Earth cooled (water condensed). Photosynthesis added O‚ÇÇ and removed CO‚ÇÇ. CO‚ÇÇ also locked in fossil fuels and rocks.", source: "AQA GCSE Chemistry" },
    { category: "Climate", front: "How do greenhouse gases cause climate change?", back: "CO‚ÇÇ, methane, water vapour absorb infrared radiation from Earth and re-emit it, trapping heat. Human activities increase CO‚ÇÇ (burning fuels) and methane (farming, landfill). Average temperatures rising.", source: "AQA GCSE Chemistry" },
    { category: "Pollution", front: "What are the main atmospheric pollutants and their sources?", back: "Carbon monoxide: incomplete combustion, toxic. Sulfur dioxide: burning fossil fuels with sulfur impurities, causes acid rain. Nitrogen oxides: high temperature combustion, acid rain and smog. Particulates: soot, health issues.", source: "AQA GCSE Chemistry" }
  ]},
  // PHYSICS - Particles
  'phys-particles': { id: 'phys-particles', name: 'Particle Model', icon: 'üí®', cards: [
    { category: "States", front: "Describe the arrangement and movement of particles in solids, liquids and gases.", back: "Solid: regular pattern, vibrate in fixed positions, strong forces. Liquid: close but irregular, move around each other, weaker forces. Gas: far apart, random motion, very weak forces. Explains properties.", source: "AQA GCSE Physics" },
    { category: "Density", front: "How do you calculate density?", back: "Density = mass √∑ volume (œÅ = m/V). Units: kg/m¬≥ or g/cm¬≥. Measure mass with balance. Volume: regular shape use ruler, irregular use displacement. Density varies by material and state.", source: "AQA GCSE Physics" },
    { category: "Energy", front: "What is internal energy?", back: "Total kinetic and potential energy of all particles in a system. Kinetic: from movement. Potential: from bonds/forces between particles. Heating increases internal energy. Temperature related to average kinetic energy.", source: "AQA GCSE Physics" },
    { category: "Changes", front: "What happens during changes of state?", back: "Energy added/removed but temperature constant during change. Melting/boiling: energy weakens bonds, increases potential energy. Particles don't speed up (temp constant). Mass conserved, state changes are reversible.", source: "AQA GCSE Physics" },
    { category: "Heat", front: "What is specific heat capacity?", back: "Energy needed to raise 1 kg of substance by 1¬∞C. E = mcŒîT (energy = mass √ó SHC √ó temp change). Water has high SHC (4200 J/kg¬∞C), heats slowly, good for storage. Metals have low SHC.", source: "AQA GCSE Physics" },
    { category: "Heat", front: "What is specific latent heat?", back: "Energy to change state of 1 kg without temperature change. E = mL. Latent heat of fusion (solid‚Üîliquid). Latent heat of vaporisation (liquid‚Üîgas). Vaporisation higher because more bonds broken.", source: "AQA GCSE Physics" }
  ]},
  // PHYSICS - Atomic Structure
  'phys-atomic': { id: 'phys-atomic', name: 'Atomic Structure', icon: '‚ò¢Ô∏è', cards: [
    { category: "Atoms", front: "Describe the structure of an atom.", back: "Nucleus: protons (+) and neutrons (0), very small, most of mass. Electrons (-) orbit in shells. Radius of atom ~10‚Åª¬π‚Å∞m. Radius of nucleus ~10‚Åª¬π‚Å¥m. Atoms are mostly empty space.", source: "AQA GCSE Physics" },
    { category: "Isotopes", front: "What are isotopes?", back: "Atoms with same number of protons but different neutrons. Same element (same atomic number) but different mass number. Example: Carbon-12 and Carbon-14. Some isotopes are radioactive.", source: "AQA GCSE Physics" },
    { category: "Radiation", front: "What are alpha, beta and gamma radiation?", back: "Alpha (Œ±): 2 protons + 2 neutrons, +2 charge, stopped by paper. Beta (Œ≤): high-speed electron, -1 charge, stopped by aluminium. Gamma (Œ≥): electromagnetic wave, no charge, reduced by lead.", source: "AQA GCSE Physics" },
    { category: "Radiation", front: "What happens to the nucleus during alpha and beta decay?", back: "Alpha decay: loses 2 protons, 2 neutrons. Mass number -4, atomic number -2. Beta decay: neutron ‚Üí proton + electron. Mass number same, atomic number +1. Element changes in both.", source: "AQA GCSE Physics" },
    { category: "Half-life", front: "What is half-life?", back: "Time for count rate to halve, OR time for half the nuclei to decay. Random process but predictable for large numbers. After 1 half-life: 50% remain. After 2: 25%. After 3: 12.5%.", source: "AQA GCSE Physics" },
    { category: "Uses", front: "What are uses and dangers of radioactivity?", back: "Uses: medical tracers (gamma), cancer treatment, sterilisation, smoke detectors (alpha), dating rocks. Dangers: ionising, damages cells, causes cancer. Precautions: shielding, distance, limit exposure.", source: "AQA GCSE Physics" }
  ]},
  // PHYSICS - Forces
  'phys-forces': { id: 'phys-forces', name: 'Forces', icon: '‚û°Ô∏è', cards: [
    { category: "Forces", front: "What is a force and how are forces represented?", back: "A push or pull measured in newtons (N). Vector quantity (has magnitude and direction). Represented by arrows: length = magnitude, direction shows direction. Contact and non-contact forces.", source: "AQA GCSE Physics" },
    { category: "Forces", front: "What is the resultant force?", back: "Single force that has same effect as all forces combined. Add forces in same direction, subtract opposite. Free body diagrams show all forces on object. Zero resultant = balanced/equilibrium.", source: "AQA GCSE Physics" },
    { category: "Motion", front: "What is the difference between speed and velocity?", back: "Speed: how fast, scalar, distance/time. Velocity: how fast in a direction, vector, displacement/time. Can have constant speed but changing velocity (circular motion). Average speed = total distance √∑ total time.", source: "AQA GCSE Physics" },
    { category: "Motion", front: "How do you calculate acceleration?", back: "Acceleration = change in velocity √∑ time. a = (v-u)/t. Units: m/s¬≤. Positive = speeding up, negative = slowing down (deceleration). Uniform acceleration is constant rate.", source: "AQA GCSE Physics" },
    { category: "Graphs", front: "What do distance-time and velocity-time graphs show?", back: "Distance-time: gradient = speed. Horizontal = stationary. Steeper = faster. Velocity-time: gradient = acceleration. Area under = distance. Horizontal = constant velocity.", source: "AQA GCSE Physics" },
    { category: "Newton", front: "State Newton's three laws of motion.", back: "1st: Object at rest stays at rest, moving stays moving unless acted on by resultant force. 2nd: F = ma (force = mass √ó acceleration). 3rd: Every action has equal and opposite reaction.", source: "AQA GCSE Physics" },
    { category: "Momentum", front: "What is momentum and how is it conserved?", back: "Momentum = mass √ó velocity (p = mv). Units: kg m/s. Vector quantity. Conservation: total momentum before = total after (in closed system). Used in collisions and explosions.", source: "AQA GCSE Physics" },
    { category: "Forces", front: "What factors affect stopping distance?", back: "Stopping distance = thinking distance + braking distance. Thinking: speed, tiredness, drugs, distractions. Braking: speed, brakes, tyres, road conditions, mass. Higher speed = much longer distance.", source: "AQA GCSE Physics" }
  ]},
  // PHYSICS - Waves
  'phys-waves': { id: 'phys-waves', name: 'Waves', icon: 'üåä', cards: [
    { category: "Properties", front: "What are the key properties of waves?", back: "Wavelength (Œª): distance of one complete wave. Frequency (f): waves per second (Hz). Amplitude: maximum displacement from rest. Period (T): time for one wave (T = 1/f). Wave speed = frequency √ó wavelength.", source: "AQA GCSE Physics" },
    { category: "Types", front: "What is the difference between transverse and longitudinal waves?", back: "Transverse: oscillations perpendicular to direction. Examples: light, water waves. Longitudinal: oscillations parallel to direction. Example: sound. Both transfer energy, not matter.", source: "AQA GCSE Physics" },
    { category: "EM Spectrum", front: "List the electromagnetic spectrum in order.", back: "Radio, Microwave, Infrared, Visible, Ultraviolet, X-rays, Gamma. Increasing frequency/energy, decreasing wavelength. All travel at 3√ó10‚Å∏ m/s in vacuum. All transverse waves.", source: "AQA GCSE Physics" },
    { category: "EM Spectrum", front: "What are uses and dangers of EM waves?", back: "Radio: communication. Microwave: cooking, phones. Infrared: heating, remotes. Visible: seeing! UV: sunbeds (causes cancer). X-rays: medical imaging (ionising). Gamma: cancer treatment (very ionising).", source: "AQA GCSE Physics" },
    { category: "Reflection", front: "State the law of reflection.", back: "Angle of incidence = angle of reflection. Both measured from the normal (perpendicular to surface). Applies to all waves. Specular reflection from smooth surfaces, diffuse from rough.", source: "AQA GCSE Physics" },
    { category: "Refraction", front: "What causes refraction?", back: "Change in wave speed when entering different medium. Light slows in denser medium, bends towards normal. Speeds up in less dense, bends away from normal. Causes lenses to focus light.", source: "AQA GCSE Physics" },
    { category: "Sound", front: "How do humans hear sounds and what is ultrasound?", back: "Sound waves cause eardrum to vibrate, converted to signals. Human range: 20 Hz to 20,000 Hz. Ultrasound: above 20 kHz. Uses: medical imaging, cleaning, measuring distances.", source: "AQA GCSE Physics" }
  ]},
  // PHYSICS - Magnetism
  'phys-magnetism': { id: 'phys-magnetism', name: 'Magnetism', icon: 'üß≤', cards: [
    { category: "Magnets", front: "What are the poles of a magnet and how do they interact?", back: "North pole and south pole. Like poles repel, opposite poles attract. Magnetic field lines go from north to south. Field strongest at poles. Earth is a giant magnet.", source: "AQA GCSE Physics" },
    { category: "Electromagnetism", front: "What is an electromagnet?", back: "Magnet made by passing current through wire, often coiled around iron core. Strength increased by: more current, more coils, iron core. Can be switched on/off. Used in motors, bells, relays.", source: "AQA GCSE Physics" },
    { category: "Motor", front: "How does an electric motor work?", back: "Current in wire in magnetic field experiences force (motor effect). F = BIL (force = magnetic field √ó current √ó length). Direction from Fleming's left-hand rule. Coil spins continuously due to commutator.", source: "AQA GCSE Physics" },
    { category: "Generator", front: "How does a generator produce electricity?", back: "Wire moving through magnetic field induces voltage (electromagnetic induction). Faster movement = higher voltage. More turns = higher voltage. Stronger field = higher voltage. AC generator: slip rings. DC: commutator.", source: "AQA GCSE Physics" },
    { category: "Transformer", front: "How does a transformer work?", back: "Changes AC voltage using electromagnetic induction. Two coils on iron core. Vp/Vs = Np/Ns (voltage ratio = turns ratio). Step-up: more secondary turns, increases voltage. Step-down: fewer turns, decreases voltage.", source: "AQA GCSE Physics" }
  ]},
  // PHYSICS - Space
  'phys-space': { id: 'phys-space', name: 'Space', icon: 'üöÄ', cards: [
    { category: "Solar System", front: "Describe the structure of our solar system.", back: "Sun at centre. 8 planets orbit: Mercury, Venus, Earth, Mars, Jupiter, Saturn, Uranus, Neptune. Dwarf planets (Pluto). Asteroids between Mars and Jupiter. Comets in elongated orbits.", source: "AQA GCSE Physics" },
    { category: "Orbits", front: "What keeps planets and satellites in orbit?", back: "Gravity provides centripetal force. Balance between gravity pulling in and velocity wanting to go straight. Closer to central body = faster orbit. Moon orbits Earth, Earth orbits Sun.", source: "AQA GCSE Physics" },
    { category: "Stars", front: "Describe the life cycle of a star like our Sun.", back: "Nebula ‚Üí protostar ‚Üí main sequence (our Sun now) ‚Üí red giant ‚Üí planetary nebula ‚Üí white dwarf. Fusion of hydrogen to helium in main sequence. Takes billions of years.", source: "AQA GCSE Physics" },
    { category: "Stars", front: "How do massive stars end differently?", back: "Massive star ‚Üí red supergiant ‚Üí supernova explosion ‚Üí either neutron star (if smaller) or black hole (if larger). Supernova creates elements heavier than iron. Very violent end.", source: "AQA GCSE Physics" },
    { category: "Big Bang", front: "What evidence supports the Big Bang theory?", back: "Red shift: galaxies moving away, light shifted to longer wavelength. Further galaxies = faster. Cosmic microwave background radiation: leftover heat from early universe. Universe expanding from initial explosion ~13.8 billion years ago.", source: "AQA GCSE Physics" }
  ]},
  // ENGLISH LITERATURE - A Christmas Carol
  'lit-christmas': { id: 'lit-christmas', name: 'A Christmas Carol', icon: 'üëª', cards: [
    { category: "Context", front: "What social issues did Dickens address in A Christmas Carol?", back: "Victorian poverty, class divide, Poor Law and workhouses. Dickens experienced childhood poverty. Industrial Revolution created wealth but also exploitation. Story promotes charity and social responsibility.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How is Scrooge presented at the start of the novella?", back: "'Squeezing, wrenching, grasping, scraping, clutching, covetous old sinner!' Cold imagery: 'cold within him froze his features.' Isolated: 'solitary as an oyster.' Represents greed and selfishness.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How does Scrooge change and what causes this transformation?", back: "Three spirits show past (lost love, innocence), present (poverty, Tiny Tim), future (his lonely death). Represents redemption. 'I am not the man I was.' Becomes generous: raises Bob's salary, helps Tiny Tim.", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How is the theme of social responsibility presented?", back: "Scrooge initially rejects charity: 'Are there no prisons?' Spirit shows Ignorance and Want as society's children. Dickens argues wealthy have duty to poor. Scrooge becomes 'as good a friend... as the old city knew.'", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How does Dickens present family and isolation?", back: "Cratchits represent love despite poverty: 'they were happy.' Scrooge isolated by choice then circumstances. Fred offers inclusion. Transformation shows isolation as self-inflicted. Family brings redemption.", source: "AQA GCSE English Lit" },
    { category: "Quotes", front: "Analyse: 'Mankind was my business'", back: "Marley's ghost regrets ignoring social duty. 'Business' has double meaning: work vs responsibility. Warning to Scrooge. Dickens's message to Victorian readers. Philanthropy more important than profit.", source: "AQA GCSE English Lit" }
  ]},
  // ENGLISH LITERATURE - Romeo & Juliet
  'lit-romeo': { id: 'lit-romeo', name: 'Romeo & Juliet', icon: 'üíî', cards: [
    { category: "Context", front: "What Elizabethan beliefs are relevant to Romeo and Juliet?", back: "Patriarchal society: fathers controlled daughters. Arranged marriages common. Honour and family name crucial. Fate and stars believed to control destiny. Italy seen as passionate but violent.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How is Romeo presented?", back: "Initially lovesick for Rosaline (petrarchan lover). Impulsive: falls for Juliet instantly, kills Tybalt. Uses religious imagery for Juliet: 'holy shrine.' Tragic flaw is rashness. Dies for love.", source: "AQA GCSE English Lit" },
    { category: "Characters", front: "How is Juliet presented and how does she develop?", back: "Starts obedient: 'I'll look to like.' Becomes assertive: defies father, takes control. Mature despite youth (13). Makes practical plans. Ultimately brave in death: 'O happy dagger!'", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How is the conflict between love and hate presented?", back: "Prologue: 'star-crossed lovers' vs 'ancient grudge.' Love at first sight despite family feud. Oxymorons: 'loving hate,' 'brawling love.' Tybalt's death from hate destroys love. Only deaths end feud.", source: "AQA GCSE English Lit" },
    { category: "Themes", front: "How does Shakespeare present fate and free will?", back: "'Star-crossed' suggests destiny. Multiple chances to avoid tragedy but characters choose wrongly. 'Fortune's fool' - Romeo blames fate. Audience debates: fate or poor choices? Prologue reveals ending.", source: "AQA GCSE English Lit" },
    { category: "Quotes", front: "Analyse: 'But soft, what light through yonder window breaks?'", back: "Balcony scene. Light/dark imagery: Juliet as sun, dispelling darkness. Religious worship: 'bright angel.' Beauty equals goodness. But night covers their love; day brings danger. Foreshadows tragedy.", source: "AQA GCSE English Lit" }
  ]},
  // ENGLISH LITERATURE - Poetry
  'lit-poetry': { id: 'lit-poetry', name: 'Poetry Anthology', icon: 'üìù', cards: [
    { category: "Power", front: "How does 'Ozymandias' present power?", back: "Shelley shows power is temporary. Statue crumbled: 'shattered visage.' Irony: 'Look on my works... and despair' - nothing remains. Nature outlasts human power: 'lone and level sands.' Tyrant forgotten.", source: "AQA GCSE English Lit" },
    { category: "Power", front: "How does 'London' present power and its abuse?", back: "Blake criticises powerful institutions: 'charter'd streets' (controlled). Church has 'black'ning' effect. Soldiers' blood on 'palace walls.' 'Mind-forg'd manacles' - psychological control. Speaker powerless observer.", source: "AQA GCSE English Lit" },
    { category: "Conflict", front: "How does 'Exposure' present the reality of war?", back: "Owen shows true enemy is weather: 'merciless iced east winds.' Repetition of 'nothing happens' - futility. Soldiers dying for unclear purpose. Rhetorical question: 'What are we doing here?' Anti-war.", source: "AQA GCSE English Lit" },
    { category: "Conflict", front: "How does 'Remains' present psychological impact of war?", back: "Armitage explores PTSD. Conversational tone contrasts horror. 'Probably armed, possibly not' - guilt. Haunted: 'he's here in my head.' Can't wash off: 'blood-Loss' metaphor for trauma. Ongoing torment.", source: "AQA GCSE English Lit" },
    { category: "Identity", front: "How does 'Checking Out Me History' present identity?", back: "Agard challenges Eurocentric education. Phonetic spelling shows Caribbean voice reclaimed. Contrast: nursery rhymes vs real heroes (Toussaint, Nanny). 'Dem tell me' repeated - passive learner becoming active.", source: "AQA GCSE English Lit" },
    { category: "Comparison", front: "How can you compare poems about power?", back: "Ozymandias vs London: both criticise powerful. Ozymandias shows power fades; London shows ongoing oppression. Ozymandias distant (desert); London immediate (streets). Both use imagery to criticise.", source: "AQA GCSE English Lit" }
  ]},
  // ENGLISH LANGUAGE - Reading
  'lang-reading': { id: 'lang-reading', name: 'Reading Skills', icon: 'üìñ', cards: [
    { category: "Inference", front: "What is inference and how do you make inferences?", back: "Reading between the lines. Use clues + prior knowledge to understand implied meaning. Look for what's suggested, not stated. Support with quotes. 'This suggests...' 'This implies...'", source: "AQA GCSE English Lang" },
    { category: "Analysis", front: "How do you analyse language effectively?", back: "1) Identify technique or word choice. 2) Quote precisely. 3) Explain effect on reader. 4) Consider connotations. 5) Link to writer's purpose. Use 'suggests,' 'creates,' 'emphasises.'", source: "AQA GCSE English Lang" },
    { category: "Structure", front: "What structural features should you comment on?", back: "Opening and ending. Shifts in focus, time, perspective. Sentence lengths and types. Paragraphing. Build-up of tension. Foreshadowing. Flashbacks. How reader is guided through text.", source: "AQA GCSE English Lang" },
    { category: "Comparison", front: "How do you compare two texts effectively?", back: "Compare explicitly: 'Both... However...' 'Similarly... In contrast...' Focus on similarities AND differences. Use connectives. Consider purpose, audience, methods. Don't just describe each separately.", source: "AQA GCSE English Lang" },
    { category: "Evaluation", front: "How do you evaluate a writer's success?", back: "Give opinion with evidence. Assess how effectively they achieve purpose. Consider reader response. 'I agree because...' Support with quotes. Counter-argument can show sophistication.", source: "AQA GCSE English Lang" }
  ]},
  // ENGLISH LANGUAGE - Writing
  'lang-writing': { id: 'lang-writing', name: 'Writing Techniques', icon: '‚úçÔ∏è', cards: [
    { category: "Openings", front: "What makes an effective opening?", back: "Hook the reader immediately. Start with action, dialogue, mystery, or striking image. Avoid clich√©s like 'I woke up.' Establish voice and tone. Create questions in reader's mind.", source: "AQA GCSE English Lang" },
    { category: "Description", front: "How do you write effective description?", back: "Use all senses, not just sight. Show don't tell. Specific details over vague. Vary sentence structures. Use metaphors and similes purposefully. Build atmosphere. Personification brings settings alive.", source: "AQA GCSE English Lang" },
    { category: "Narrative", front: "What makes a good narrative structure?", back: "Clear beginning, middle, end. Don't try to cover too much time. Build tension. Use dialogue sparingly but effectively. Consider non-linear options. End with impact or resolution.", source: "AQA GCSE English Lang" },
    { category: "Persuasion", front: "What techniques create persuasive writing?", back: "AFOREST: Alliteration, Facts, Opinions, Rhetorical questions, Emotive language, Statistics, Triplets. Also: direct address (you), imperative verbs, counter-arguments, expert opinions.", source: "AQA GCSE English Lang" },
    { category: "Planning", front: "How should you plan your writing in an exam?", back: "5 minutes maximum. Brief outline only. Key ideas/scenes. Opening and ending planned. Check you're answering the question. Consider form, audience, purpose. Vocabulary choices.", source: "AQA GCSE English Lang" }
  ]},
  // ENGLISH LANGUAGE - Grammar
  'lang-grammar': { id: 'lang-grammar', name: 'Grammar', icon: 'üìö', cards: [
    { category: "Sentences", front: "What are the four sentence types?", back: "Simple: one main clause. Compound: two main clauses joined by FANBOYS (for, and, nor, but, or, yet, so). Complex: main + subordinate clause. Minor: incomplete but deliberate.", source: "AQA GCSE English Lang" },
    { category: "Punctuation", front: "When do you use semicolons and colons?", back: "Semicolon: links two related sentences without conjunction; shows connection. Colon: introduces list, explanation, or elaboration: like this. Both show sophistication when used correctly.", source: "AQA GCSE English Lang" },
    { category: "Punctuation", front: "How do you use apostrophes correctly?", back: "Omission: shows missing letters (don't, it's = it is). Possession: singular adds 's (dog's), plural adds ' after s (dogs'). It's = it is; its = belonging to it. Never for plurals!", source: "AQA GCSE English Lang" },
    { category: "Paragraphs", front: "How should paragraphs be organised?", back: "Topic sentence introduces main idea. Supporting details follow. Link sentences connect ideas. New paragraph for new point, time, place, or speaker. TIPTOP: Time, Place, Topic, Person.", source: "AQA GCSE English Lang" },
    { category: "Accuracy", front: "What are common SPaG errors to avoid?", back: "There/their/they're. Your/you're. Could of (wrong!) - could have. Affect (verb)/effect (noun). Where/were/we're. To/too/two. Then/than. Loose/lose. Always proofread!", source: "AQA GCSE English Lang" }
  ]},
  // ENGLISH LANGUAGE - Literary Devices
  'lang-devices': { id: 'lang-devices', name: 'Literary Devices', icon: 'üé≠', cards: [
    { category: "Imagery", front: "What is a metaphor and how does it create effect?", back: "Directly states one thing IS another. More powerful than simile. Creates vivid imagery. Multiple meanings can be explored. Extended metaphor runs throughout text. Implies transformation.", source: "AQA GCSE English Lang" },
    { category: "Imagery", front: "What is personification and why use it?", back: "Giving human qualities to non-human things. Makes abstract concrete. Creates empathy or menace. 'The wind howled' - nature becomes active character. Common in pathetic fallacy.", source: "AQA GCSE English Lang" },
    { category: "Sound", front: "What are alliteration, assonance and sibilance?", back: "Alliteration: repeated consonant sounds at word starts. Assonance: repeated vowel sounds. Sibilance: repeated 's' sounds (can seem sinister or soothing). All create rhythm and emphasis.", source: "AQA GCSE English Lang" },
    { category: "Structure", front: "What are anaphora and tricolon?", back: "Anaphora: repeated words at start of clauses/sentences. Creates emphasis, rhythm. 'We shall fight...' Tricolon: list of three. Memorable, complete feeling. Often builds to climax.", source: "AQA GCSE English Lang" },
    { category: "Contrast", front: "What are juxtaposition and oxymoron?", back: "Juxtaposition: placing contrasting ideas together for effect. Oxymoron: contradictory terms together ('living death,' 'deafening silence'). Both create tension, complexity, or irony.", source: "AQA GCSE English Lang" },
    { category: "Irony", front: "What are the different types of irony?", back: "Verbal: saying opposite of meaning (sarcasm). Situational: outcome opposite of expected. Dramatic: audience knows more than characters. All create effect through contrast between expectation and reality.", source: "AQA GCSE English Lang" }
  ]},
};

// Get all decks for a folder recursively
const getDecksForFolder = (folder) => {
  let decks = [];
  if (folder.deckIds) {
    decks = folder.deckIds.map(id => DECKS[id]).filter(d => d);
  }
  if (folder.children) {
    folder.children.forEach(child => {
      decks = [...decks, ...getDecksForFolder(child)];
    });
  }
  return decks;
};

// Calculate folder progress
const getFolderProgress = (folder) => {
  const decks = getDecksForFolder(folder);
  let totalCards = 0, knownCards = 0;
  decks.forEach(deck => {
    if (deck.cards && deck.cards.length > 0) {
      totalCards += deck.cards.length;
      const progress = loadLocal(`progress_${deck.id}`, {});
      knownCards += Object.values(progress).filter(v => v === 'known').length;
    }
  });
  return { known: knownCards, total: totalCards, percent: totalCards > 0 ? Math.round((knownCards / totalCards) * 100) : 0 };
};

// STREAK SYSTEM
const getStreakData = () => loadLocal('streakData', { current: 0, lastStudy: null, dailyGoal: 20, todayCards: 0 });
const saveStreakData = (data) => saveLocal('streakData', data);

// EXAM COUNTDOWN
const getExams = () => loadLocal('exams', []);
const saveExams = (exams) => saveLocal('exams', exams);

// REVISION PLANNER
const getRevisionSessions = () => loadLocal('revisionSessions', []);
const saveRevisionSessions = (sessions) => saveLocal('revisionSessions', sessions);
const getExamCountdownHidden = () => loadLocal('examCountdownHidden', false);
const saveExamCountdownHidden = (hidden) => saveLocal('examCountdownHidden', hidden);
const getPomodoroSettings = () => loadLocal('pomodoroSettings', { workMins: 25, shortBreak: 5, longBreak: 15, sessionsBeforeLong: 4 });
const savePomodoroSettings = (settings) => saveLocal('pomodoroSettings', settings);

// Subject colors - soft pastel palette
const SUBJECT_COLORS = {
  'gcse-maths': { bg: '#dbeafe', text: '#1e40af', dot: '#3b82f6' },
  'gcse-biology': { bg: '#dcfce7', text: '#166534', dot: '#22c55e' },
  'gcse-chemistry': { bg: '#fef3c7', text: '#92400e', dot: '#f59e0b' },
  'gcse-physics': { bg: '#e0e7ff', text: '#3730a3', dot: '#6366f1' },
  'gcse-eng-lit': { bg: '#fce7f3', text: '#9d174d', dot: '#ec4899' },
  'gcse-eng-lang': { bg: '#ffe4e6', text: '#9f1239', dot: '#f43f5e' },
  'gcse-history': { bg: '#fed7aa', text: '#9a3412', dot: '#f97316' },
  'gcse-dt': { bg: '#d1d5db', text: '#374151', dot: '#6b7280' },
  'finance': { bg: '#d1fae5', text: '#065f46', dot: '#10b981' },
  'default': { bg: '#e2e8f0', text: '#475569', dot: '#64748b' }
};

const getSubjectColor = (subjectId) => SUBJECT_COLORS[subjectId] || SUBJECT_COLORS['default'];

// Get subjects from folder structure
const getSubjectsFromFolders = () => {
  const subjects = [];
  const extractSubjects = (folder, parent = '') => {
    if (folder.deckIds && folder.deckIds.length > 0) {
      subjects.push({ id: folder.id, name: folder.name, icon: folder.icon, parent, color: getSubjectColor(folder.id) });
    }
    if (folder.children) {
      folder.children.forEach(child => extractSubjects(child, folder.name));
    }
  };
  FOLDERS.forEach(f => extractSubjects(f));
  return subjects;
};

// APP
function App() {
  const { user, loading } = useAuth();
  const [view, setView] = useState('home');
  const [path, setPath] = useState([]);
  const [activeDeck, setActiveDeck] = useState(null);
  const [openaiKey, setOpenaiKey] = useState(() => loadLocal('openai_api_key', ''));
  const [streakData, setStreakData] = useState(getStreakData);
  const [showPlanner, setShowPlanner] = useState(false);

  if (loading) {
    return <div style={{ minHeight: '100vh', background: '#0f172a', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><div style={{ color: '#60a5fa', fontSize: '18px' }}>Loading...</div></div>;
  }

  if (view === 'auth') return <AuthScreen setView={setView} />;
  if (view === 'study') return <Study deck={activeDeck} setView={setView} streakData={streakData} setStreakData={setStreakData} />;
  if (view === 'quiz') return <QuizMode deck={activeDeck} setView={setView} />;
  if (view === 'create') return <CreateDeck setView={setView} openaiKey={openaiKey} user={user} />;
  if (view === 'exams') return <ExamCountdown setView={setView} />;

  return <HomeWithPlanner path={path} setPath={setPath} setActiveDeck={setActiveDeck} setView={setView} user={user} openaiKey={openaiKey} streakData={streakData} showPlanner={showPlanner} setShowPlanner={setShowPlanner} />;
}

// HOME WITH PLANNER SIDEBAR
function HomeWithPlanner({ path, setPath, setActiveDeck, setView, user, openaiKey, streakData, showPlanner, setShowPlanner }) {
  const [isMobile, setIsMobile] = useState(window.innerWidth < 900);
  const [plannerCollapsed, setPlannerCollapsed] = useState(() => loadLocal('plannerCollapsed', false));

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 900);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const togglePlannerCollapsed = () => {
    const newVal = !plannerCollapsed;
    setPlannerCollapsed(newVal);
    saveLocal('plannerCollapsed', newVal);
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', display: 'flex' }}>
      {/* Main Content */}
      <div style={{ flex: 1, minWidth: 0, padding: '20px', fontFamily: 'system-ui' }}>
        <Home path={path} setPath={setPath} setActiveDeck={setActiveDeck} setView={setView} user={user} openaiKey={openaiKey} streakData={streakData} showPlanner={showPlanner} setShowPlanner={setShowPlanner} isMobile={isMobile} />
      </div>

      {/* Planner Sidebar - Desktop */}
      {!isMobile && (
        <div style={{ width: plannerCollapsed ? '48px' : '340px', borderLeft: '1px solid rgba(100,116,139,0.2)', background: 'rgba(15,23,42,0.9)', overflowY: plannerCollapsed ? 'hidden' : 'auto', maxHeight: '100vh', transition: 'width 0.2s ease', position: 'relative' }}>
          {/* Collapse/Expand button */}
          <button onClick={togglePlannerCollapsed} style={{ position: 'absolute', top: '16px', left: plannerCollapsed ? '8px' : '16px', background: 'rgba(139,92,246,0.2)', border: 'none', borderRadius: '6px', padding: '6px 10px', color: '#a78bfa', fontSize: '12px', cursor: 'pointer', zIndex: 10 }}>
            {plannerCollapsed ? '‚Ä∫' : '‚Äπ'}
          </button>
          {plannerCollapsed ? (
            <div style={{ padding: '60px 8px 16px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '12px' }}>
              <div style={{ writingMode: 'vertical-rl', textOrientation: 'mixed', color: '#64748b', fontSize: '11px', letterSpacing: '1px' }}>PLANNER</div>
            </div>
          ) : (
            <div style={{ paddingTop: '40px' }}>
              <RevisionPlanner />
            </div>
          )}
        </div>
      )}

      {/* Planner Modal - Mobile */}
      {isMobile && showPlanner && (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', zIndex: 1000, display: 'flex', justifyContent: 'flex-end' }}>
          <div style={{ width: '100%', maxWidth: '400px', background: '#0f172a', overflowY: 'auto', animation: 'slideIn 0.2s ease' }}>
            <div style={{ padding: '16px', borderBottom: '1px solid rgba(100,116,139,0.2)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h2 style={{ color: '#f1f5f9', fontSize: '18px' }}>Revision Planner</h2>
              <button onClick={() => setShowPlanner(false)} style={{ background: 'none', border: 'none', color: '#94a3b8', fontSize: '24px', cursor: 'pointer' }}>√ó</button>
            </div>
            <RevisionPlanner />
          </div>
        </div>
      )}

      <style>{`@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }`}</style>
    </div>
  );
}

// FAVORITES SECTION
function FavoritesSection({ setActiveDeck, setView }) {
  const [expanded, setExpanded] = useState(() => loadLocal('favoritesExpanded', false));
  const [expandedFolders, setExpandedFolders] = useState({});

  // Collect all favorites from all decks, grouped by folder
  const getFavoritesGrouped = () => {
    const grouped = {};
    let totalCount = 0;

    // Helper to find which folder a deck belongs to
    const findDeckFolder = (deckId) => {
      for (const folder of FOLDERS) {
        if (folder.deckIds?.includes(deckId)) return folder;
        if (folder.children) {
          for (const child of folder.children) {
            if (child.deckIds?.includes(deckId)) return child;
            if (child.children) {
              for (const grandchild of child.children) {
                if (grandchild.deckIds?.includes(deckId)) return grandchild;
              }
            }
          }
        }
      }
      return null;
    };

    // Go through all decks and collect favorites
    Object.keys(DECKS).forEach(deckId => {
      const deck = DECKS[deckId];
      if (!deck.cards || deck.cards.length === 0) return;

      const favorites = loadLocal(`favorites_${deckId}`, {});
      const favCards = deck.cards.filter(card => favorites[card.front]);

      if (favCards.length > 0) {
        const folder = findDeckFolder(deckId);
        const folderId = folder?.id || 'other';
        const folderName = folder?.name || 'Other';
        const folderIcon = folder?.icon || 'üìö';

        if (!grouped[folderId]) {
          grouped[folderId] = { name: folderName, icon: folderIcon, decks: {} };
        }
        grouped[folderId].decks[deckId] = { deck, cards: favCards };
        totalCount += favCards.length;
      }
    });

    return { grouped, totalCount };
  };

  const { grouped, totalCount } = getFavoritesGrouped();

  const toggleExpanded = () => {
    const newVal = !expanded;
    setExpanded(newVal);
    saveLocal('favoritesExpanded', newVal);
  };

  const toggleFolder = (folderId) => {
    setExpandedFolders(prev => ({ ...prev, [folderId]: !prev[folderId] }));
  };

  if (totalCount === 0) return null;

  return (
    <div style={{ marginBottom: '20px' }}>
      {/* Header */}
      <button onClick={toggleExpanded} style={{ width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px', background: 'rgba(251,191,36,0.1)', border: '1px solid rgba(251,191,36,0.3)', borderRadius: '12px', cursor: 'pointer', marginBottom: expanded ? '12px' : 0 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
          <span style={{ fontSize: '20px' }}>‚≠ê</span>
          <span style={{ color: '#fbbf24', fontWeight: 600, fontSize: '14px' }}>Favourites</span>
          <span style={{ color: '#d97706', fontSize: '12px', background: 'rgba(251,191,36,0.2)', padding: '2px 8px', borderRadius: '10px' }}>{totalCount} cards</span>
        </div>
        <span style={{ color: '#fbbf24', fontSize: '16px', transform: expanded ? 'rotate(180deg)' : 'rotate(0)', transition: 'transform 0.2s' }}>‚ñº</span>
      </button>

      {/* Expanded Content */}
      {expanded && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          {Object.entries(grouped).map(([folderId, folderData]) => {
            const folderCardCount = Object.values(folderData.decks).reduce((sum, d) => sum + d.cards.length, 0);
            const isFolderExpanded = expandedFolders[folderId];

            return (
              <div key={folderId} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.2)', overflow: 'hidden' }}>
                {/* Folder Header */}
                <button onClick={() => toggleFolder(folderId)} style={{ width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 14px', background: 'transparent', border: 'none', cursor: 'pointer' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <span style={{ fontSize: '18px' }}>{folderData.icon}</span>
                    <span style={{ color: '#f1f5f9', fontWeight: 500, fontSize: '14px' }}>{folderData.name}</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ color: '#fbbf24', fontSize: '12px' }}>{folderCardCount} ‚≠ê</span>
                    <span style={{ color: '#64748b', fontSize: '14px', transform: isFolderExpanded ? 'rotate(180deg)' : 'rotate(0)', transition: 'transform 0.2s' }}>‚ñº</span>
                  </div>
                </button>

                {/* Decks in folder */}
                {isFolderExpanded && (
                  <div style={{ borderTop: '1px solid rgba(100,116,139,0.15)', padding: '8px' }}>
                    {Object.entries(folderData.decks).map(([deckId, deckData]) => (
                      <div key={deckId} onClick={() => { setActiveDeck(deckData.deck); setView('study'); }} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 12px', borderRadius: '8px', cursor: 'pointer', marginBottom: '4px', background: 'rgba(255,255,255,0.03)' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <span style={{ fontSize: '16px' }}>{deckData.deck.icon}</span>
                          <span style={{ color: '#e2e8f0', fontSize: '13px' }}>{deckData.deck.name}</span>
                        </div>
                        <span style={{ color: '#fbbf24', fontSize: '11px', background: 'rgba(251,191,36,0.15)', padding: '2px 6px', borderRadius: '6px' }}>{deckData.cards.length} ‚≠ê</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// HOME WITH FOLDERS
function Home({ path, setPath, setActiveDeck, setView, user, openaiKey, streakData, showPlanner, setShowPlanner, isMobile }) {
  const { signOut } = useAuth();
  const [showApiModal, setShowApiModal] = useState(false);
  const [exams, setExamsLocal] = useState(getExams);
  const [hideExamCountdown, setHideExamCountdown] = useState(getExamCountdownHidden);

  // Get current folder based on path
  const getCurrentFolder = () => {
    if (path.length === 0) return null;
    let folder = FOLDERS.find(f => f.id === path[0]);
    for (let i = 1; i < path.length; i++) {
      if (folder && folder.children) {
        folder = folder.children.find(f => f.id === path[i]);
      }
    }
    return folder;
  };

  const currentFolder = getCurrentFolder();
  const items = currentFolder
    ? [...(currentFolder.children || []), ...(currentFolder.deckIds || []).map(id => ({ ...DECKS[id], type: 'deck' }))]
    : FOLDERS;

  const navigateToFolder = (folder) => {
    setPath([...path, folder.id]);
  };

  const navigateUp = () => {
    setPath(path.slice(0, -1));
  };

  const openDeck = (deck) => {
    setActiveDeck(deck);
    setView('study');
  };

  // Get next upcoming exam
  const getNextExam = () => {
    const now = new Date();
    const upcoming = exams
      .map(e => ({ ...e, daysUntil: Math.ceil((new Date(e.date) - now) / (1000 * 60 * 60 * 24)) }))
      .filter(e => e.daysUntil >= 0)
      .sort((a, b) => a.daysUntil - b.daysUntil);
    return upcoming[0] || null;
  };

  const nextExam = getNextExam();

  const toggleExamCountdown = () => {
    const newVal = !hideExamCountdown;
    setHideExamCountdown(newVal);
    saveExamCountdownHidden(newVal);
  };

  return (
    <div style={{ fontFamily: 'system-ui' }}>
      {showApiModal && <ApiKeyModal openaiKey={openaiKey} onClose={() => setShowApiModal(false)} />}

      <div style={{ maxWidth: '600px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
          <div>
            <h1 style={{ fontSize: '24px', fontWeight: 700, color: '#60a5fa', marginBottom: '4px' }}>FlashLearn</h1>
            <p style={{ color: '#64748b', fontSize: '13px' }}>{user ? `Welcome back` : 'GCSE Revision Made Easy'}</p>
          </div>
          <div style={{ display: 'flex', gap: '8px' }}>
            {isMobile && (
              <button onClick={() => setShowPlanner(true)} style={{ padding: '8px 12px', borderRadius: '8px', border: '1px solid rgba(139,92,246,0.5)', background: 'rgba(139,92,246,0.1)', color: '#a78bfa', fontSize: '12px', cursor: 'pointer' }}>üìÖ Planner</button>
            )}
            {user ? (
              <button onClick={signOut} style={{ padding: '8px 12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '12px', cursor: 'pointer' }}>Sign Out</button>
            ) : (
              <button onClick={() => setView('auth')} style={{ padding: '8px 12px', borderRadius: '8px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '12px', fontWeight: 600, cursor: 'pointer' }}>Sign In</button>
            )}
          </div>
        </div>

        {/* Next Exam Countdown Banner - Soft pastel colors */}
        {nextExam && path.length === 0 && (
          <div style={{ background: hideExamCountdown ? 'rgba(30,41,59,0.9)' : (nextExam.daysUntil <= 7 ? '#fecaca' : nextExam.daysUntil <= 30 ? '#fef3c7' : '#d1fae5'), borderRadius: '12px', padding: hideExamCountdown ? '12px 16px' : '16px', marginBottom: '16px', border: hideExamCountdown ? '1px solid rgba(100,116,139,0.2)' : (nextExam.daysUntil <= 7 ? '1px solid #fca5a5' : nextExam.daysUntil <= 30 ? '1px solid #fcd34d' : '1px solid #6ee7b7') }}>
            {hideExamCountdown ? (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ color: '#64748b', fontSize: '13px' }}>Exam countdown hidden</span>
                <button onClick={toggleExamCountdown} style={{ background: 'none', border: 'none', color: '#60a5fa', fontSize: '12px', cursor: 'pointer' }}>Show</button>
              </div>
            ) : (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  <div style={{ fontSize: '13px', color: nextExam.daysUntil <= 7 ? '#991b1b' : nextExam.daysUntil <= 30 ? '#92400e' : '#065f46', marginBottom: '2px', opacity: 0.8 }}>Next exam</div>
                  <div style={{ fontSize: '16px', fontWeight: 600, color: nextExam.daysUntil <= 7 ? '#991b1b' : nextExam.daysUntil <= 30 ? '#92400e' : '#065f46' }}>{nextExam.subject}</div>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{ fontSize: '28px', fontWeight: 700, color: nextExam.daysUntil <= 7 ? '#dc2626' : nextExam.daysUntil <= 30 ? '#d97706' : '#059669' }}>{nextExam.daysUntil}</div>
                    <div style={{ fontSize: '11px', color: nextExam.daysUntil <= 7 ? '#991b1b' : nextExam.daysUntil <= 30 ? '#92400e' : '#065f46', opacity: 0.8 }}>days left</div>
                  </div>
                  <button onClick={toggleExamCountdown} style={{ background: nextExam.daysUntil <= 7 ? 'rgba(153,27,27,0.1)' : nextExam.daysUntil <= 30 ? 'rgba(146,64,14,0.1)' : 'rgba(6,95,70,0.1)', border: 'none', borderRadius: '6px', padding: '6px 10px', color: nextExam.daysUntil <= 7 ? '#991b1b' : nextExam.daysUntil <= 30 ? '#92400e' : '#065f46', fontSize: '11px', cursor: 'pointer' }}>Hide</button>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Streak Banner */}
        <div style={{ background: 'linear-gradient(135deg, #f59e0b, #d97706)', borderRadius: '12px', padding: '16px', marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <div>
            <div style={{ fontSize: '24px', marginBottom: '4px' }}>üî• {streakData.current} day streak</div>
            <div style={{ color: 'rgba(255,255,255,0.8)', fontSize: '13px' }}>{streakData.todayCards}/{streakData.dailyGoal} cards today</div>
          </div>
          <button onClick={() => setView('exams')} style={{ padding: '10px 16px', borderRadius: '8px', background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white', fontSize: '13px', cursor: 'pointer' }}>üìÖ Exams</button>
        </div>

        {/* Breadcrumb */}
        {path.length > 0 && (
          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '16px', flexWrap: 'wrap' }}>
            <button onClick={() => setPath([])} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer', fontSize: '14px' }}>Home</button>
            {path.map((id, i) => {
              const folder = i === 0 ? FOLDERS.find(f => f.id === id) : null; // Simplified
              return (
                <span key={id} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                  <span style={{ color: '#64748b' }}>‚Ä∫</span>
                  <button onClick={() => setPath(path.slice(0, i + 1))} style={{ background: 'none', border: 'none', color: i === path.length - 1 ? '#f1f5f9' : '#60a5fa', cursor: 'pointer', fontSize: '14px' }}>{id.split('-').pop()}</button>
                </span>
              );
            })}
          </div>
        )}

        {/* Back button */}
        {path.length > 0 && (
          <button onClick={navigateUp} style={{ display: 'flex', alignItems: 'center', gap: '8px', background: 'rgba(255,255,255,0.05)', border: 'none', borderRadius: '10px', padding: '12px 16px', color: '#94a3b8', fontSize: '14px', cursor: 'pointer', marginBottom: '16px' }}>
            ‚Üê Back
          </button>
        )}

        {/* Quick Actions */}
        {path.length === 0 && (
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '20px' }}>
            <button onClick={() => user ? setView('create') : setShowApiModal(true)} style={{ padding: '16px', borderRadius: '12px', border: '2px dashed rgba(96,165,250,0.5)', background: 'rgba(59,130,246,0.1)', color: '#60a5fa', fontSize: '14px', fontWeight: 600, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              ‚ú® Create with AI
            </button>
            <button onClick={() => setView('exams')} style={{ padding: '16px', borderRadius: '12px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(30,41,59,0.5)', color: '#94a3b8', fontSize: '14px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              üìÖ Exam Countdown
            </button>
          </div>
        )}

        {/* Favorites Section */}
        {path.length === 0 && <FavoritesSection setActiveDeck={setActiveDeck} setView={setView} />}

        {/* Folder/Deck Grid */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {items.map(item => {
            const isDeck = item.type === 'deck' || item.cards;
            if (isDeck) {
              const deck = item;
              if (!deck.cards || deck.cards.length === 0) return null; // Hide empty decks
              const progress = loadLocal(`progress_${deck.id}`, {});
              const known = Object.values(progress).filter(v => v === 'known').length;
              const percent = Math.round((known / deck.cards.length) * 100);
              return (
                <div key={deck.id} onClick={() => openDeck(deck)} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '16px', cursor: 'pointer', border: '1px solid rgba(100,116,139,0.2)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '28px' }}>{deck.icon}</span>
                    <div style={{ flex: 1 }}>
                      <div style={{ color: '#f1f5f9', fontSize: '16px', fontWeight: 500 }}>{deck.name}</div>
                      <div style={{ color: '#64748b', fontSize: '12px' }}>{deck.cards.length} cards</div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ color: percent === 100 ? '#10b981' : '#60a5fa', fontSize: '14px', fontWeight: 600 }}>{percent}%</div>
                    </div>
                  </div>
                  <div style={{ marginTop: '8px', height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px' }}>
                    <div style={{ width: `${percent}%`, height: '100%', background: percent === 100 ? '#10b981' : '#3b82f6', borderRadius: '2px' }}></div>
                  </div>
                </div>
              );
            } else {
              const folder = item;
              const prog = getFolderProgress(folder);
              return (
                <div key={folder.id} onClick={() => navigateToFolder(folder)} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '16px', cursor: 'pointer', border: '1px solid rgba(100,116,139,0.2)' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <span style={{ fontSize: '32px' }}>{folder.icon}</span>
                    <div style={{ flex: 1 }}>
                      <div style={{ color: '#f1f5f9', fontSize: '16px', fontWeight: 500 }}>{folder.name}</div>
                      <div style={{ color: '#64748b', fontSize: '12px' }}>{folder.description || `${folder.children?.length || 0} folders, ${folder.deckIds?.length || 0} decks`}</div>
                    </div>
                    {prog.total > 0 && (
                      <div style={{ textAlign: 'right' }}>
                        <div style={{ color: prog.percent === 100 ? '#10b981' : '#60a5fa', fontSize: '14px', fontWeight: 600 }}>{prog.percent}%</div>
                        <div style={{ color: '#64748b', fontSize: '11px' }}>{prog.known}/{prog.total}</div>
                      </div>
                    )}
                    <span style={{ color: '#64748b' }}>‚Ä∫</span>
                  </div>
                </div>
              );
            }
          })}
        </div>

        <p style={{ textAlign: 'center', color: '#4b5563', fontSize: '11px', marginTop: '24px' }}>üéß All decks support hands-free learning with TTS</p>
      </div>
    </div>
  );
}

// AUTH SCREEN (compact)
function AuthScreen({ setView }) {
  const { signIn, signUp } = useAuth();
  const [isSignUp, setIsSignUp] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    const { error } = isSignUp ? await signUp(email, password) : await signIn(email, password);
    setLoading(false);
    if (error) setError(error.message);
    else setView('home');
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
      <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '16px', padding: '32px', maxWidth: '360px', width: '100%' }}>
        <h1 style={{ color: '#60a5fa', fontSize: '24px', textAlign: 'center', marginBottom: '24px' }}>FlashLearn</h1>
        <form onSubmit={handleSubmit}>
          <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} required />
          <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} required minLength={6} />
          {error && <p style={{ color: '#ef4444', fontSize: '13px', marginBottom: '12px' }}>{error}</p>}
          <button type="submit" disabled={loading} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: 600, cursor: 'pointer' }}>{loading ? '...' : (isSignUp ? 'Sign Up' : 'Sign In')}</button>
        </form>
        <p style={{ color: '#94a3b8', textAlign: 'center', marginTop: '16px', fontSize: '13px' }}>
          <button onClick={() => setIsSignUp(!isSignUp)} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer' }}>{isSignUp ? 'Have an account? Sign In' : 'Need an account? Sign Up'}</button>
        </p>
        <button onClick={() => setView('home')} style={{ width: '100%', marginTop: '12px', padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#64748b', fontSize: '13px', cursor: 'pointer' }}>Continue without account</button>
      </div>
    </div>
  );
}

// API KEY MODAL (compact)
function ApiKeyModal({ openaiKey, onClose }) {
  const [key, setKey] = useState(openaiKey);
  const handleSave = () => { saveLocal('openai_api_key', key); onClose(); window.location.reload(); };
  return (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', zIndex: 1000 }}>
      <div style={{ background: '#1e293b', borderRadius: '16px', padding: '24px', maxWidth: '400px', width: '100%' }}>
        <h2 style={{ color: '#f1f5f9', fontSize: '18px', marginBottom: '12px' }}>üîë OpenAI API Key</h2>
        <p style={{ color: '#94a3b8', fontSize: '13px', marginBottom: '16px' }}>Enter your key to generate flashcards with AI. Get one at <a href="https://platform.openai.com/api-keys" target="_blank" style={{ color: '#60a5fa' }}>platform.openai.com</a></p>
        <input type="password" placeholder="sk-..." value={key} onChange={e => setKey(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '16px', fontFamily: 'monospace' }} />
        <div style={{ display: 'flex', gap: '12px' }}>
          <button onClick={onClose} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', cursor: 'pointer' }}>Cancel</button>
          <button onClick={handleSave} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: '#3b82f6', color: 'white', fontWeight: 600, cursor: 'pointer' }}>Save</button>
        </div>
      </div>
    </div>
  );
}

// STUDY MODE (with spaced repetition)
function Study({ deck, setView, streakData, setStreakData }) {
  const [cardIndex, setCardIndex] = useState(0);
  const [showAnswer, setShowAnswer] = useState(false);
  const [isPlaying, setIsPlaying] = useState(false);
  const [progress, setProgress] = useState(() => loadLocal(`progress_${deck.id}`, {}));
  const [favorites, setFavorites] = useState(() => loadLocal(`favorites_${deck.id}`, {}));
  const [shuffled, setShuffled] = useState(false);
  const [filter, setFilter] = useState('all');
  const [order, setOrder] = useState(() => deck.cards.map((_, i) => i));
  const [voice, setVoice] = useState(null);
  const [voices, setVoices] = useState([]);
  const [speed, setSpeed] = useState(0.9);
  const [phase, setPhase] = useState('idle');
  const timerRef = useRef(null);
  const isPlayingRef = useRef(false);

  const card = deck.cards[order[cardIndex]];
  const knownCount = Object.values(progress).filter(v => v === 'known').length;

  useEffect(() => {
    const loadVoices = () => {
      const allVoices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
      setVoices(allVoices);
      if (allVoices.length && !voice) setVoice(allVoices[0]);
    };
    loadVoices();
    speechSynthesis.onvoiceschanged = loadVoices;
  }, []);

  useEffect(() => {
    let indices = deck.cards.map((_, i) => i);
    if (filter === 'favorites') indices = indices.filter(i => favorites[deck.cards[i].front]);
    if (shuffled && indices.length > 0) {
      for (let i = indices.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [indices[i], indices[j]] = [indices[j], indices[i]]; }
    }
    setOrder(indices.length > 0 ? indices : deck.cards.map((_, i) => i));
    setCardIndex(0);
    setShowAnswer(false);
  }, [shuffled, filter, favorites]);

  useEffect(() => { saveLocal(`progress_${deck.id}`, progress); }, [progress]);
  useEffect(() => { saveLocal(`favorites_${deck.id}`, favorites); }, [favorites]);
  useEffect(() => { isPlayingRef.current = isPlaying; }, [isPlaying]);
  useEffect(() => { return () => { speechSynthesis.cancel(); if (timerRef.current) clearTimeout(timerRef.current); }; }, []);

  const speak = (text) => new Promise(resolve => {
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text.replace(/\. /g, '... '));
    u.rate = speed; u.pitch = 1.05; if (voice) u.voice = voice;
    u.onend = resolve; u.onerror = resolve;
    speechSynthesis.speak(u);
  });

  const runAutoPlay = async (idx, doQ = true) => {
    while (isPlayingRef.current) {
      const c = deck.cards[order[idx]];
      if (doQ) { setCardIndex(idx); setShowAnswer(false); setPhase('speaking-q'); await speak("Question. " + c.front); if (!isPlayingRef.current) break; setPhase('pause'); await new Promise(r => timerRef.current = setTimeout(r, 1500)); if (!isPlayingRef.current) break; }
      setShowAnswer(true); setPhase('speaking-a'); await speak("Answer. " + c.back); if (!isPlayingRef.current) break; setPhase('pause'); await new Promise(r => timerRef.current = setTimeout(r, 2500)); if (!isPlayingRef.current) break;
      idx = (idx + 1) % order.length; doQ = true;
    }
    setPhase('idle');
  };

  const handlePlay = () => { setIsPlaying(true); isPlayingRef.current = true; runAutoPlay(cardIndex, !showAnswer); };
  const handleStop = () => { isPlayingRef.current = false; setIsPlaying(false); speechSynthesis.cancel(); if (timerRef.current) clearTimeout(timerRef.current); setPhase('idle'); };
  const handleNext = () => { handleStop(); setCardIndex((cardIndex + 1) % order.length); setShowAnswer(false); };
  const handlePrev = () => { handleStop(); setCardIndex((cardIndex - 1 + order.length) % order.length); setShowAnswer(false); };
  const handleFlip = () => { if (!isPlaying) setShowAnswer(!showAnswer); };

  const markCard = (status) => {
    setProgress(p => ({ ...p, [card.front]: status }));
    // Update streak
    const today = new Date().toDateString();
    const newStreak = { ...streakData, todayCards: streakData.todayCards + 1 };
    if (streakData.lastStudy !== today) {
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      newStreak.current = streakData.lastStudy === yesterday ? streakData.current + 1 : 1;
      newStreak.lastStudy = today;
      newStreak.todayCards = 1;
    }
    setStreakData(newStreak);
    saveStreakData(newStreak);
  };

  const toggleFavorite = () => { setFavorites(f => { const n = { ...f }; if (n[card.front]) delete n[card.front]; else n[card.front] = true; return n; }); };
  const favCount = Object.keys(favorites).length;

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '16px', fontFamily: 'system-ui', color: '#e2e8f0' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
          <button onClick={() => { handleStop(); setView('home'); }} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '10px', padding: '10px 16px', color: '#94a3b8', cursor: 'pointer' }}>‚Üê Back</button>
          <div style={{ textAlign: 'center' }}>
            <div style={{ color: '#f1f5f9', fontWeight: 600 }}>{deck.name}</div>
            <div style={{ color: '#64748b', fontSize: '12px' }}>Card {cardIndex + 1}/{order.length} ‚Ä¢ {knownCount} mastered</div>
          </div>
          <button onClick={() => setView('quiz')} style={{ background: 'rgba(139,92,246,0.2)', border: 'none', borderRadius: '10px', padding: '10px 16px', color: '#a78bfa', cursor: 'pointer' }}>Quiz</button>
        </div>

        {/* Filters */}
        <div style={{ display: 'flex', gap: '8px', marginBottom: '12px' }}>
          <button onClick={() => setFilter('all')} style={{ flex: 1, padding: '8px', borderRadius: '8px', border: 'none', fontSize: '12px', cursor: 'pointer', background: filter === 'all' ? 'rgba(59,130,246,0.3)' : 'rgba(255,255,255,0.05)', color: filter === 'all' ? '#60a5fa' : '#64748b' }}>All ({deck.cards.length})</button>
          <button onClick={() => setFilter('favorites')} style={{ flex: 1, padding: '8px', borderRadius: '8px', border: 'none', fontSize: '12px', cursor: 'pointer', background: filter === 'favorites' ? 'rgba(251,191,36,0.3)' : 'rgba(255,255,255,0.05)', color: filter === 'favorites' ? '#fbbf24' : '#64748b' }}>‚òÖ ({favCount})</button>
        </div>

        {/* Status bar */}
        {isPlaying && (
          <div style={{ background: 'rgba(16,185,129,0.2)', borderRadius: '10px', padding: '10px 14px', marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
            <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#10b981', animation: 'pulse 1.5s infinite' }}></div>
            <span style={{ color: '#10b981', fontSize: '13px' }}>{phase === 'speaking-q' ? 'Reading question...' : phase === 'speaking-a' ? 'Reading answer...' : 'Next card...'}</span>
          </div>
        )}

        {/* Card */}
        <div onClick={handleFlip} style={{ position: 'relative', background: showAnswer ? 'linear-gradient(135deg, #064e3b, #065f46)' : 'linear-gradient(135deg, #1e3a5f, #1e40af)', borderRadius: '16px', padding: '20px', minHeight: '220px', display: 'flex', flexDirection: 'column', cursor: 'pointer', border: showAnswer ? '2px solid #10b981' : '2px solid #3b82f6' }}>
          <button onClick={e => { e.stopPropagation(); toggleFavorite(); }} style={{ position: 'absolute', top: '12px', right: '12px', background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', opacity: favorites[card?.front] ? 1 : 0.3 }}>‚òÖ</button>
          <div style={{ fontSize: '10px', fontWeight: 700, color: showAnswer ? '#6ee7b7' : '#93c5fd', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '12px' }}>{card?.category} ‚Ä¢ {showAnswer ? 'ANSWER' : 'QUESTION'}</div>
          <div style={{ flex: 1, fontSize: showAnswer ? '14px' : '17px', lineHeight: 1.6 }}>{showAnswer ? card?.back : card?.front}</div>
          {card?.source && <div style={{ marginTop: '10px', paddingTop: '8px', borderTop: '1px solid rgba(255,255,255,0.1)', fontSize: '10px', color: '#64748b' }}>Source: {card.source}</div>}
          {!isPlaying && <div style={{ marginTop: '8px', color: showAnswer ? '#6ee7b7' : '#93c5fd', fontSize: '12px' }}>Tap to {showAnswer ? 'see question' : 'reveal answer'}</div>}
        </div>

        {/* Mark buttons */}
        {!isPlaying && (
          <div style={{ display: 'flex', gap: '10px', marginTop: '12px' }}>
            <button onClick={() => markCard('learning')} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', fontWeight: 600, fontSize: '13px', cursor: 'pointer', background: progress[card?.front] === 'learning' ? '#f59e0b' : 'rgba(255,255,255,0.1)', color: progress[card?.front] === 'learning' ? 'white' : '#94a3b8' }}>Still Learning</button>
            <button onClick={() => markCard('known')} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', fontWeight: 600, fontSize: '13px', cursor: 'pointer', background: progress[card?.front] === 'known' ? '#10b981' : 'rgba(255,255,255,0.1)', color: progress[card?.front] === 'known' ? 'white' : '#94a3b8' }}>Got It ‚úì</button>
          </div>
        )}

        {/* Controls */}
        <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '12px', marginTop: '20px' }}>
          <button onClick={handlePrev} style={{ width: '44px', height: '44px', borderRadius: '50%', background: 'rgba(255,255,255,0.1)', border: 'none', color: '#e2e8f0', fontSize: '20px', cursor: 'pointer' }}>‚Äπ</button>
          <button onClick={isPlaying ? handleStop : handlePlay} style={{ width: '64px', height: '64px', borderRadius: '50%', background: isPlaying ? '#ef4444' : '#10b981', border: 'none', color: 'white', fontSize: '24px', cursor: 'pointer' }}>{isPlaying ? '‚èπ' : '‚ñ∂'}</button>
          <button onClick={handleNext} style={{ width: '44px', height: '44px', borderRadius: '50%', background: 'rgba(255,255,255,0.1)', border: 'none', color: '#e2e8f0', fontSize: '20px', cursor: 'pointer' }}>‚Ä∫</button>
        </div>

        {/* Settings */}
        <div style={{ marginTop: '20px', background: 'rgba(30,41,59,0.8)', borderRadius: '12px', padding: '16px' }}>
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '12px', justifyContent: 'center', alignItems: 'center' }}>
            <select value={voice?.name || ''} onChange={e => setVoice(voices.find(v => v.name === e.target.value))} style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', padding: '6px 10px', color: '#e2e8f0', fontSize: '12px', maxWidth: '120px' }}>
              {voices.map(v => <option key={v.name} value={v.name}>{v.name.slice(0, 15)}</option>)}
            </select>
            <select value={speed} onChange={e => setSpeed(parseFloat(e.target.value))} style={{ background: 'rgba(0,0,0,0.3)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '6px', padding: '6px 10px', color: '#e2e8f0', fontSize: '12px' }}>
              <option value={0.8}>Slow</option>
              <option value={0.9}>Normal</option>
              <option value={1.1}>Fast</option>
            </select>
            <button onClick={() => setShuffled(!shuffled)} style={{ padding: '6px 12px', borderRadius: '6px', border: 'none', background: shuffled ? '#3b82f6' : 'rgba(255,255,255,0.1)', color: shuffled ? 'white' : '#94a3b8', fontSize: '12px', cursor: 'pointer' }}>üîÄ {shuffled ? 'On' : 'Off'}</button>
          </div>
        </div>
      </div>
      <style>{`@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }`}</style>
    </div>
  );
}

// QUIZ MODE
function QuizMode({ deck, setView }) {
  const [questions, setQuestions] = useState([]);
  const [currentQ, setCurrentQ] = useState(0);
  const [score, setScore] = useState(0);
  const [showResult, setShowResult] = useState(false);
  const [answered, setAnswered] = useState(false);
  const [timeLeft, setTimeLeft] = useState(30);
  const [quizComplete, setQuizComplete] = useState(false);
  const timerRef = useRef(null);

  useEffect(() => {
    // Shuffle and pick 10 questions
    const shuffled = [...deck.cards].sort(() => Math.random() - 0.5).slice(0, 10);
    setQuestions(shuffled);
  }, []);

  useEffect(() => {
    if (!quizComplete && questions.length > 0 && !answered) {
      timerRef.current = setInterval(() => {
        setTimeLeft(t => {
          if (t <= 1) { handleAnswer(false); return 30; }
          return t - 1;
        });
      }, 1000);
    }
    return () => clearInterval(timerRef.current);
  }, [currentQ, answered, quizComplete]);

  const handleAnswer = (correct) => {
    clearInterval(timerRef.current);
    setAnswered(true);
    setShowResult(true);
    if (correct) setScore(s => s + 1);
  };

  const nextQuestion = () => {
    if (currentQ + 1 >= questions.length) {
      setQuizComplete(true);
    } else {
      setCurrentQ(c => c + 1);
      setAnswered(false);
      setShowResult(false);
      setTimeLeft(30);
    }
  };

  if (questions.length === 0) return null;

  if (quizComplete) {
    const percent = Math.round((score / questions.length) * 100);
    return (
      <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px' }}>
        <div style={{ textAlign: 'center', color: '#f1f5f9' }}>
          <div style={{ fontSize: '64px', marginBottom: '16px' }}>{percent >= 80 ? 'üèÜ' : percent >= 50 ? 'üëç' : 'üìö'}</div>
          <h2 style={{ fontSize: '28px', marginBottom: '8px' }}>Quiz Complete!</h2>
          <p style={{ fontSize: '20px', color: '#60a5fa', marginBottom: '24px' }}>{score}/{questions.length} correct ({percent}%)</p>
          <button onClick={() => setView('home')} style={{ padding: '14px 32px', borderRadius: '10px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '16px', fontWeight: 600, cursor: 'pointer' }}>Back to Home</button>
        </div>
      </div>
    );
  }

  const q = questions[currentQ];
  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
          <button onClick={() => setView('study')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '8px 14px', color: '#94a3b8', cursor: 'pointer' }}>‚Üê Exit</button>
          <div style={{ color: '#f1f5f9', fontWeight: 600 }}>Question {currentQ + 1}/{questions.length}</div>
          <div style={{ color: timeLeft <= 10 ? '#ef4444' : '#10b981', fontWeight: 600 }}>{timeLeft}s</div>
        </div>

        {/* Timer bar */}
        <div style={{ height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px', marginBottom: '20px' }}>
          <div style={{ width: `${(timeLeft / 30) * 100}%`, height: '100%', background: timeLeft <= 10 ? '#ef4444' : '#10b981', borderRadius: '2px', transition: 'width 1s linear' }}></div>
        </div>

        {/* Question */}
        <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '16px', padding: '24px', marginBottom: '20px' }}>
          <div style={{ color: '#60a5fa', fontSize: '11px', fontWeight: 600, textTransform: 'uppercase', marginBottom: '12px' }}>{q.category}</div>
          <div style={{ color: '#f1f5f9', fontSize: '18px', lineHeight: 1.6 }}>{q.front}</div>
        </div>

        {showResult ? (
          <div>
            <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '20px', marginBottom: '16px' }}>
              <div style={{ color: '#10b981', fontSize: '12px', fontWeight: 600, marginBottom: '8px' }}>ANSWER</div>
              <div style={{ color: '#f1f5f9', fontSize: '14px', lineHeight: 1.5 }}>{q.back}</div>
            </div>
            <button onClick={nextQuestion} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: 'none', background: '#3b82f6', color: 'white', fontSize: '15px', fontWeight: 600, cursor: 'pointer' }}>
              {currentQ + 1 >= questions.length ? 'See Results' : 'Next Question ‚Üí'}
            </button>
          </div>
        ) : (
          <div style={{ display: 'flex', gap: '12px' }}>
            <button onClick={() => handleAnswer(false)} style={{ flex: 1, padding: '16px', borderRadius: '10px', border: 'none', background: 'rgba(239,68,68,0.2)', color: '#f87171', fontSize: '15px', fontWeight: 600, cursor: 'pointer' }}>Don't Know</button>
            <button onClick={() => { setShowResult(true); clearInterval(timerRef.current); }} style={{ flex: 1, padding: '16px', borderRadius: '10px', border: 'none', background: 'rgba(16,185,129,0.2)', color: '#34d399', fontSize: '15px', fontWeight: 600, cursor: 'pointer' }}>Show Answer</button>
          </div>
        )}

        {showResult && !answered && (
          <div style={{ display: 'flex', gap: '12px', marginTop: '12px' }}>
            <button onClick={() => handleAnswer(false)} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', background: '#ef4444', color: 'white', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}>Got it Wrong</button>
            <button onClick={() => handleAnswer(true)} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', background: '#10b981', color: 'white', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}>Got it Right ‚úì</button>
          </div>
        )}
      </div>
    </div>
  );
}

// REVISION PLANNER SIDEBAR
function RevisionPlanner() {
  const [sessions, setSessions] = useState(getRevisionSessions);
  const [showAddSession, setShowAddSession] = useState(false);
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [newSession, setNewSession] = useState({ subject: '', date: '', startTime: '09:00', duration: 60, notes: '' });
  const [viewMode, setViewMode] = useState('calendar'); // 'calendar', 'day', 'metrics', 'pomodoro'
  const [pomodoroState, setPomodoroState] = useState({ isRunning: false, mode: 'work', timeLeft: 25 * 60, sessionsCompleted: 0 });
  const [pomodoroSettings, setPomodoroSettingsState] = useState(getPomodoroSettings);
  const pomodoroRef = useRef(null);
  const subjects = getSubjectsFromFolders();

  // Calendar helpers
  const getMonthDays = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const days = [];
    for (let i = 0; i < firstDay; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(i);
    return days;
  };

  const [currentMonth, setCurrentMonth] = useState(new Date());
  const monthDays = getMonthDays(currentMonth);
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

  const getSessionsForDate = (dateStr) => sessions.filter(s => s.date === dateStr);

  const formatDateStr = (day) => {
    const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
    return d.toISOString().split('T')[0];
  };

  // Get unique subject colors for a date (for calendar dots)
  const getSubjectDotsForDate = (dateStr) => {
    const daySessions = getSessionsForDate(dateStr);
    const uniqueSubjects = [...new Set(daySessions.map(s => s.subject))];
    return uniqueSubjects.slice(0, 4).map(subjectId => getSubjectColor(subjectId).dot);
  };

  const addSession = () => {
    if (!newSession.subject || !newSession.date) return;
    const updated = [...sessions, { ...newSession, id: Date.now() }];
    setSessions(updated);
    saveRevisionSessions(updated);
    setNewSession({ subject: '', date: selectedDate, startTime: '09:00', duration: 60, notes: '' });
    setShowAddSession(false);
  };

  const deleteSession = (id) => {
    const updated = sessions.filter(s => s.id !== id);
    setSessions(updated);
    saveRevisionSessions(updated);
  };

  // Metrics calculation
  const getMetrics = () => {
    const subjectHours = {};
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    const weekSessions = sessions.filter(s => new Date(s.date) >= weekStart);

    sessions.forEach(s => {
      subjectHours[s.subject] = (subjectHours[s.subject] || 0) + (s.duration / 60);
    });

    const totalHours = Object.values(subjectHours).reduce((a, b) => a + b, 0);
    const weekHours = weekSessions.reduce((a, s) => a + s.duration / 60, 0);
    const todaySessions = sessions.filter(s => s.date === new Date().toISOString().split('T')[0]);

    return { subjectHours, totalHours, weekHours, todaySessions };
  };

  const metrics = getMetrics();

  // Pomodoro Timer Logic
  useEffect(() => {
    if (pomodoroState.isRunning) {
      pomodoroRef.current = setInterval(() => {
        setPomodoroState(prev => {
          if (prev.timeLeft <= 1) {
            // Play notification sound
            try {
              const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQQFA0+W7Pa2bBIAC0Ka8f7JfigEADN+9f/dgzwEACRz9v/fhj8HACR18//adDsHACVy7PTYdjoLACVy6uvQcTgOACZy4+PLbzYQACdy3N3IbTQSAChy1dfGbDITAClzzNHDbDEUACpzy8zBazAVACp0xcfAajAWACt1wMO/aTAXACx2u7+9aTAYAC13t7u8aTAYAC54s7e6aDEYAC94r7S5aDEYADB5q7G4ZzEYADF6qK+3ZzIYADF6pa22ZzIYADJ7oqu1ZjMYADJ7oKm0ZjMYADN8naezZjQXADN8m6WyZjQXADR9mKOxZTUWADR9lqGwZTUWADV9lKCvZDYWADV+kp6uZDYWADZ+kJytZDcVADZ+jputZDcVADd/jJmsYzgUADd/ipesYzgUADiAiJarYjkUADiAhpSqYjkUADmAhJOpYToTADmAg5GoYToTADqBgZCnYDsTADqBf46mYDsTADuBfo2lXzwSADuBfIukXzwSADyCe4qjXj0RADyCeYmiXj0RAD2CeIihXT4RAD2Cd4egXT4RAD6DdoafXD8QAD6DdYWeXD8QAD+DdISdWz8QAD+Dc4OcWz8QAECEcoGbWkAPAECEcYCaWkAPAEGEcH+ZWUEPAEGEb36YWUEPAEKEbn2XWEEOAEKEbXyWWEEOAA==');
              audio.play();
            } catch(e) {}

            // Switch mode
            if (prev.mode === 'work') {
              const newSessions = prev.sessionsCompleted + 1;
              const isLongBreak = newSessions % pomodoroSettings.sessionsBeforeLong === 0;
              return {
                isRunning: false,
                mode: isLongBreak ? 'longBreak' : 'shortBreak',
                timeLeft: (isLongBreak ? pomodoroSettings.longBreak : pomodoroSettings.shortBreak) * 60,
                sessionsCompleted: newSessions
              };
            } else {
              return {
                isRunning: false,
                mode: 'work',
                timeLeft: pomodoroSettings.workMins * 60,
                sessionsCompleted: prev.sessionsCompleted
              };
            }
          }
          return { ...prev, timeLeft: prev.timeLeft - 1 };
        });
      }, 1000);
    }
    return () => clearInterval(pomodoroRef.current);
  }, [pomodoroState.isRunning, pomodoroSettings]);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const togglePomodoro = () => setPomodoroState(prev => ({ ...prev, isRunning: !prev.isRunning }));
  const resetPomodoro = () => setPomodoroState({ isRunning: false, mode: 'work', timeLeft: pomodoroSettings.workMins * 60, sessionsCompleted: 0 });
  const skipPhase = () => {
    setPomodoroState(prev => {
      if (prev.mode === 'work') {
        const newSessions = prev.sessionsCompleted + 1;
        const isLongBreak = newSessions % pomodoroSettings.sessionsBeforeLong === 0;
        return { isRunning: false, mode: isLongBreak ? 'longBreak' : 'shortBreak', timeLeft: (isLongBreak ? pomodoroSettings.longBreak : pomodoroSettings.shortBreak) * 60, sessionsCompleted: newSessions };
      }
      return { isRunning: false, mode: 'work', timeLeft: pomodoroSettings.workMins * 60, sessionsCompleted: prev.sessionsCompleted };
    });
  };

  // Time slots for day view (6am to 10pm in 30-min intervals)
  const timeSlots = Array.from({ length: 33 }, (_, i) => {
    const hour = Math.floor(i / 2) + 6;
    const mins = (i % 2) * 30;
    return { hour, mins, label: `${hour.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}` };
  });

  // Convert time string to minutes from midnight
  const timeToMins = (timeStr) => {
    const [h, m] = timeStr.split(':').map(Number);
    return h * 60 + m;
  };

  // Convert minutes from midnight to time string
  const minsToTime = (mins) => {
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
  };

  // Get session position and height for timeline
  const getSessionStyle = (session) => {
    const startTime = session.startTime || '09:00'; // Default to 9am for old sessions
    const startMins = timeToMins(startTime);
    const dayStartMins = 6 * 60; // 6am
    const top = ((startMins - dayStartMins) / 30) * 28; // 28px per 30-min slot
    const height = ((session.duration || 60) / 30) * 28;
    return { top: `${top}px`, height: `${Math.max(height, 20)}px` };
  };

  // Migrate old sessions without startTime
  useEffect(() => {
    const needsMigration = sessions.some(s => !s.startTime);
    if (needsMigration) {
      const migrated = sessions.map(s => s.startTime ? s : { ...s, startTime: '09:00' });
      setSessions(migrated);
      saveRevisionSessions(migrated);
    }
  }, []);

  // Dragging state
  const [dragSession, setDragSession] = useState(null);
  const [dragType, setDragType] = useState(null); // 'move', 'resize-top', 'resize-bottom'
  const [dragStartY, setDragStartY] = useState(0);
  const [dragStartTime, setDragStartTime] = useState(0);
  const [dragStartDuration, setDragStartDuration] = useState(0);
  const timelineRef = useRef(null);

  const handleDragStart = (e, session, type) => {
    e.preventDefault();
    setDragSession(session);
    setDragType(type);
    setDragStartY(e.clientY || e.touches?.[0]?.clientY);
    setDragStartTime(timeToMins(session.startTime));
    setDragStartDuration(session.duration);
  };

  useEffect(() => {
    if (dragSession) {
      const moveHandler = (e) => {
        e.preventDefault();
        if (!timelineRef.current) return;
        const clientY = e.clientY || e.touches?.[0]?.clientY;
        const deltaY = clientY - dragStartY;
        const deltaMins = Math.round(deltaY / 28) * 30; // Snap to 30-min intervals

        setSessions(prevSessions => prevSessions.map(s => {
          if (s.id !== dragSession.id) return s;

          if (dragType === 'move') {
            let newStartMins = dragStartTime + deltaMins;
            newStartMins = Math.max(6 * 60, Math.min(22 * 60 - s.duration, newStartMins));
            return { ...s, startTime: minsToTime(newStartMins) };
          } else if (dragType === 'resize-bottom') {
            let newDuration = dragStartDuration + deltaMins;
            newDuration = Math.max(30, Math.min(240, newDuration)); // 30min to 4h
            return { ...s, duration: newDuration };
          } else if (dragType === 'resize-top') {
            let newStartMins = dragStartTime + deltaMins;
            let newDuration = dragStartDuration - deltaMins;
            if (newDuration < 30) { newDuration = 30; newStartMins = dragStartTime + dragStartDuration - 30; }
            if (newDuration > 240) { newDuration = 240; newStartMins = dragStartTime + dragStartDuration - 240; }
            newStartMins = Math.max(6 * 60, newStartMins);
            return { ...s, startTime: minsToTime(newStartMins), duration: newDuration };
          }
          return s;
        }));
      };

      const endHandler = () => {
        saveRevisionSessions(sessions);
        setDragSession(null);
        setDragType(null);
      };

      window.addEventListener('mousemove', moveHandler);
      window.addEventListener('mouseup', endHandler);
      window.addEventListener('touchmove', moveHandler, { passive: false });
      window.addEventListener('touchend', endHandler);
      return () => {
        window.removeEventListener('mousemove', moveHandler);
        window.removeEventListener('mouseup', endHandler);
        window.removeEventListener('touchmove', moveHandler);
        window.removeEventListener('touchend', endHandler);
      };
    }
  }, [dragSession, dragStartY, dragStartTime, dragStartDuration, dragType, sessions]);

  return (
    <div style={{ padding: '16px', color: '#e2e8f0', fontFamily: 'system-ui' }}>
      <h2 style={{ fontSize: '18px', fontWeight: 600, marginBottom: '16px', color: '#f1f5f9' }}>üìÖ Revision Planner</h2>

      {/* View Toggle */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '4px', marginBottom: '16px' }}>
        {[{ id: 'calendar', label: 'Month' }, { id: 'day', label: 'Day' }, { id: 'metrics', label: 'Stats' }, { id: 'pomodoro', label: 'Timer' }].map(({ id, label }) => (
          <button key={id} onClick={() => setViewMode(id)} style={{ padding: '8px 4px', borderRadius: '6px', border: 'none', fontSize: '11px', fontWeight: 500, cursor: 'pointer', background: viewMode === id ? 'rgba(139,92,246,0.3)' : 'rgba(255,255,255,0.05)', color: viewMode === id ? '#a78bfa' : '#64748b' }}>
            {label}
          </button>
        ))}
      </div>

      {viewMode === 'calendar' && (
        <>
          {/* Month Navigation */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer', fontSize: '16px' }}>‚Äπ</button>
            <span style={{ fontWeight: 500, fontSize: '13px' }}>{monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}</span>
            <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer', fontSize: '16px' }}>‚Ä∫</button>
          </div>

          {/* Calendar Grid with Colored Dots */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '2px', marginBottom: '12px' }}>
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
              <div key={i} style={{ textAlign: 'center', fontSize: '9px', color: '#64748b', padding: '2px' }}>{d}</div>
            ))}
            {monthDays.map((day, i) => {
              if (!day) return <div key={i} />;
              const dateStr = formatDateStr(day);
              const isToday = dateStr === new Date().toISOString().split('T')[0];
              const isSelected = dateStr === selectedDate;
              const subjectDots = getSubjectDotsForDate(dateStr);
              return (
                <div key={i} onClick={() => { setSelectedDate(dateStr); setViewMode('day'); }} style={{ textAlign: 'center', padding: '4px 2px', borderRadius: '6px', cursor: 'pointer', background: isSelected ? 'rgba(139,92,246,0.3)' : isToday ? 'rgba(59,130,246,0.2)' : 'transparent', border: isToday ? '1px solid #3b82f6' : '1px solid transparent', minHeight: '36px' }}>
                  <div style={{ fontSize: '11px', fontWeight: isToday ? 600 : 400 }}>{day}</div>
                  {subjectDots.length > 0 && (
                    <div style={{ display: 'flex', justifyContent: 'center', gap: '2px', marginTop: '2px', flexWrap: 'wrap' }}>
                      {subjectDots.map((color, j) => (
                        <div key={j} style={{ width: '5px', height: '5px', borderRadius: '50%', background: color }} />
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Subject Legend */}
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '12px' }}>
            {subjects.slice(0, 6).map(s => (
              <div key={s.id} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '9px', color: '#94a3b8' }}>
                <div style={{ width: '8px', height: '8px', borderRadius: '50%', background: s.color.dot }} />
                {s.name.slice(0, 8)}
              </div>
            ))}
          </div>

          <button onClick={() => { setNewSession({ ...newSession, date: selectedDate }); setShowAddSession(true); }} style={{ width: '100%', background: '#8b5cf6', border: 'none', borderRadius: '8px', padding: '10px', color: 'white', fontSize: '12px', fontWeight: 500, cursor: 'pointer' }}>+ Add Session</button>
        </>
      )}

      {viewMode === 'day' && (
        <>
          {/* Date Navigation */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
            <button onClick={() => setSelectedDate(new Date(new Date(selectedDate).getTime() - 86400000).toISOString().split('T')[0])} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer', fontSize: '16px' }}>‚Äπ</button>
            <span style={{ fontWeight: 500, fontSize: '13px' }}>{new Date(selectedDate + 'T12:00:00').toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}</span>
            <button onClick={() => setSelectedDate(new Date(new Date(selectedDate).getTime() + 86400000).toISOString().split('T')[0])} style={{ background: 'none', border: 'none', color: '#60a5fa', cursor: 'pointer', fontSize: '16px' }}>‚Ä∫</button>
          </div>

          <div style={{ fontSize: '10px', color: '#64748b', marginBottom: '8px', textAlign: 'center' }}>Drag sessions to move ‚Ä¢ Drag edges to resize</div>

          {/* Timeline with 30-min slots */}
          <div ref={timelineRef} style={{ maxHeight: '340px', overflowY: 'auto', marginBottom: '12px', position: 'relative' }}>
            {/* Time grid */}
            <div style={{ display: 'flex' }}>
              {/* Time labels */}
              <div style={{ width: '36px', flexShrink: 0 }}>
                {timeSlots.filter((_, i) => i % 2 === 0).map((slot, i) => (
                  <div key={i} style={{ height: '56px', fontSize: '9px', color: '#64748b', textAlign: 'right', paddingRight: '6px', paddingTop: '2px' }}>
                    {slot.label}
                  </div>
                ))}
              </div>

              {/* Grid and sessions */}
              <div style={{ flex: 1, position: 'relative', borderLeft: '1px solid rgba(100,116,139,0.2)' }}>
                {/* Grid lines */}
                {timeSlots.map((slot, i) => (
                  <div key={i} style={{ height: '28px', borderBottom: slot.mins === 0 ? '1px solid rgba(100,116,139,0.2)' : '1px solid rgba(100,116,139,0.08)' }} />
                ))}

                {/* Sessions overlay */}
                <div style={{ position: 'absolute', top: 0, left: '4px', right: '4px', bottom: 0 }}>
                  {getSessionsForDate(selectedDate).map(session => {
                    const subj = subjects.find(s => s.id === session.subject);
                    const color = getSubjectColor(session.subject);
                    const style = getSessionStyle(session);
                    const isDragging = dragSession?.id === session.id;
                    const isCompact = (session.duration || 60) <= 30;
                    return (
                      <div key={session.id} style={{ position: 'absolute', left: 0, right: 0, ...style, background: color.bg, borderLeft: `3px solid ${color.dot}`, borderRadius: '4px', cursor: isDragging ? 'grabbing' : 'grab', opacity: isDragging ? 0.9 : 1, boxShadow: isDragging ? '0 4px 12px rgba(0,0,0,0.3)' : 'none', zIndex: isDragging ? 10 : 1, transition: isDragging ? 'none' : 'box-shadow 0.2s', overflow: 'visible' }}>
                        {/* Resize handle top with circle indicator */}
                        <div onMouseDown={(e) => handleDragStart(e, session, 'resize-top')} onTouchStart={(e) => handleDragStart(e, session, 'resize-top')} style={{ position: 'absolute', top: '-4px', left: 0, right: 0, height: '12px', cursor: 'ns-resize', display: 'flex', justifyContent: 'center', alignItems: 'flex-start' }}>
                          <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: color.dot, border: `2px solid ${color.bg}`, boxShadow: '0 1px 3px rgba(0,0,0,0.3)' }} />
                        </div>

                        {/* Main drag area - horizontal layout for compact (30min), vertical for longer */}
                        <div onMouseDown={(e) => handleDragStart(e, session, 'move')} onTouchStart={(e) => handleDragStart(e, session, 'move')} style={{ padding: isCompact ? '3px 8px 3px 8px' : '4px 8px', paddingRight: '22px', height: '100%', display: 'flex', flexDirection: isCompact ? 'row' : 'column', justifyContent: 'flex-start', alignItems: isCompact ? 'center' : 'flex-start', gap: isCompact ? '6px' : '0' }}>
                          <div style={{ color: color.text, fontWeight: 500, fontSize: '10px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: isCompact ? '60%' : 'none' }}>{subj?.icon} {subj?.name}</div>
                          <div style={{ color: color.text, opacity: 0.7, fontSize: '9px', whiteSpace: 'nowrap' }}>{session.startTime || '09:00'}{isCompact ? '' : ` ‚Ä¢ ${session.duration || 60}m`}</div>
                        </div>

                        {/* Resize handle bottom with circle indicator */}
                        <div onMouseDown={(e) => handleDragStart(e, session, 'resize-bottom')} onTouchStart={(e) => handleDragStart(e, session, 'resize-bottom')} style={{ position: 'absolute', bottom: '-4px', left: 0, right: 0, height: '12px', cursor: 'ns-resize', display: 'flex', justifyContent: 'center', alignItems: 'flex-end' }}>
                          <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: color.dot, border: `2px solid ${color.bg}`, boxShadow: '0 1px 3px rgba(0,0,0,0.3)' }} />
                        </div>

                        {/* Delete button - positioned to not overlap with compact layout */}
                        <button onClick={(e) => { e.stopPropagation(); deleteSession(session.id); }} style={{ position: 'absolute', top: isCompact ? '50%' : '2px', right: '2px', transform: isCompact ? 'translateY(-50%)' : 'none', background: 'rgba(0,0,0,0.1)', border: 'none', borderRadius: '50%', width: '16px', height: '16px', color: color.text, opacity: 0.6, cursor: 'pointer', fontSize: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>√ó</button>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          <button onClick={() => { setNewSession({ ...newSession, date: selectedDate }); setShowAddSession(true); }} style={{ width: '100%', background: '#8b5cf6', border: 'none', borderRadius: '8px', padding: '10px', color: 'white', fontSize: '12px', fontWeight: 500, cursor: 'pointer' }}>+ Add Session</button>
        </>
      )}

      {viewMode === 'metrics' && (
        <div>
          {/* Summary Cards */}
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '12px' }}>
            <div style={{ background: 'rgba(139,92,246,0.15)', borderRadius: '8px', padding: '12px', border: '1px solid rgba(139,92,246,0.3)' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#a78bfa' }}>{metrics.totalHours.toFixed(1)}h</div>
              <div style={{ fontSize: '10px', color: '#94a3b8' }}>Total planned</div>
            </div>
            <div style={{ background: 'rgba(59,130,246,0.15)', borderRadius: '8px', padding: '12px', border: '1px solid rgba(59,130,246,0.3)' }}>
              <div style={{ fontSize: '20px', fontWeight: 700, color: '#60a5fa' }}>{metrics.weekHours.toFixed(1)}h</div>
              <div style={{ fontSize: '10px', color: '#94a3b8' }}>This week</div>
            </div>
          </div>

          {/* Hours by Subject with colored bars */}
          <h3 style={{ fontSize: '12px', color: '#94a3b8', marginBottom: '8px' }}>Hours by Subject</h3>
          {Object.keys(metrics.subjectHours).length === 0 ? (
            <div style={{ background: 'rgba(30,41,59,0.5)', borderRadius: '8px', padding: '12px', textAlign: 'center', color: '#64748b', fontSize: '11px' }}>No sessions planned yet</div>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
              {Object.entries(metrics.subjectHours).sort((a, b) => b[1] - a[1]).map(([subjectId, hours]) => {
                const subj = subjects.find(s => s.id === subjectId);
                const color = getSubjectColor(subjectId);
                const percent = metrics.totalHours > 0 ? (hours / metrics.totalHours) * 100 : 0;
                return (
                  <div key={subjectId} style={{ background: 'rgba(30,41,59,0.8)', borderRadius: '6px', padding: '8px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                      <span style={{ fontSize: '11px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <span style={{ width: '8px', height: '8px', borderRadius: '50%', background: color.dot }} />
                        {subj?.name || subjectId}
                      </span>
                      <span style={{ fontSize: '11px', color: color.dot, fontWeight: 600 }}>{hours.toFixed(1)}h</span>
                    </div>
                    <div style={{ height: '4px', background: 'rgba(255,255,255,0.1)', borderRadius: '2px' }}>
                      <div style={{ width: `${percent}%`, height: '100%', background: color.dot, borderRadius: '2px' }} />
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {viewMode === 'pomodoro' && (
        <div style={{ textAlign: 'center' }}>
          {/* Timer Display */}
          <div style={{ background: pomodoroState.mode === 'work' ? 'rgba(239,68,68,0.15)' : 'rgba(34,197,94,0.15)', borderRadius: '16px', padding: '24px', marginBottom: '16px', border: `2px solid ${pomodoroState.mode === 'work' ? 'rgba(239,68,68,0.3)' : 'rgba(34,197,94,0.3)'}` }}>
            <div style={{ fontSize: '11px', color: pomodoroState.mode === 'work' ? '#fca5a5' : '#86efac', textTransform: 'uppercase', marginBottom: '8px', fontWeight: 600 }}>
              {pomodoroState.mode === 'work' ? 'üçÖ Focus Time' : pomodoroState.mode === 'shortBreak' ? '‚òï Short Break' : 'üå¥ Long Break'}
            </div>
            <div style={{ fontSize: '48px', fontWeight: 700, color: pomodoroState.mode === 'work' ? '#f87171' : '#4ade80', fontFamily: 'monospace' }}>
              {formatTime(pomodoroState.timeLeft)}
            </div>
            <div style={{ fontSize: '11px', color: '#94a3b8', marginTop: '8px' }}>
              Sessions completed: {pomodoroState.sessionsCompleted}
            </div>
          </div>

          {/* Controls */}
          <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
            <button onClick={togglePomodoro} style={{ flex: 1, padding: '12px', borderRadius: '10px', border: 'none', background: pomodoroState.isRunning ? '#ef4444' : '#22c55e', color: 'white', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}>
              {pomodoroState.isRunning ? '‚è∏ Pause' : '‚ñ∂ Start'}
            </button>
            <button onClick={skipPhase} style={{ padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '14px', cursor: 'pointer' }}>‚è≠</button>
            <button onClick={resetPomodoro} style={{ padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '14px', cursor: 'pointer' }}>‚Ü∫</button>
          </div>

          {/* Settings */}
          <div style={{ background: 'rgba(30,41,59,0.8)', borderRadius: '10px', padding: '12px', textAlign: 'left' }}>
            <div style={{ fontSize: '11px', color: '#94a3b8', marginBottom: '8px' }}>Timer Settings</div>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
              <div>
                <label style={{ fontSize: '10px', color: '#64748b' }}>Work (mins)</label>
                <input type="text" inputMode="numeric" value={pomodoroSettings.workMins} onChange={e => { const val = e.target.value; const num = parseInt(val); const v = { ...pomodoroSettings, workMins: val === '' ? '' : (isNaN(num) ? pomodoroSettings.workMins : num) }; setPomodoroSettingsState(v); }} onBlur={e => { const num = parseInt(e.target.value) || 25; const v = { ...pomodoroSettings, workMins: Math.max(1, Math.min(120, num)) }; setPomodoroSettingsState(v); savePomodoroSettings(v); if (!pomodoroState.isRunning && pomodoroState.mode === 'work') setPomodoroState(p => ({ ...p, timeLeft: v.workMins * 60 })); }} style={{ width: '100%', padding: '6px', borderRadius: '6px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '12px' }} />
              </div>
              <div>
                <label style={{ fontSize: '10px', color: '#64748b' }}>Short break</label>
                <input type="text" inputMode="numeric" value={pomodoroSettings.shortBreak} onChange={e => { const val = e.target.value; const num = parseInt(val); const v = { ...pomodoroSettings, shortBreak: val === '' ? '' : (isNaN(num) ? pomodoroSettings.shortBreak : num) }; setPomodoroSettingsState(v); }} onBlur={e => { const num = parseInt(e.target.value) || 5; const v = { ...pomodoroSettings, shortBreak: Math.max(1, Math.min(60, num)) }; setPomodoroSettingsState(v); savePomodoroSettings(v); if (!pomodoroState.isRunning && pomodoroState.mode === 'shortBreak') setPomodoroState(p => ({ ...p, timeLeft: v.shortBreak * 60 })); }} style={{ width: '100%', padding: '6px', borderRadius: '6px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '12px' }} />
              </div>
              <div>
                <label style={{ fontSize: '10px', color: '#64748b' }}>Long break</label>
                <input type="text" inputMode="numeric" value={pomodoroSettings.longBreak} onChange={e => { const val = e.target.value; const num = parseInt(val); const v = { ...pomodoroSettings, longBreak: val === '' ? '' : (isNaN(num) ? pomodoroSettings.longBreak : num) }; setPomodoroSettingsState(v); }} onBlur={e => { const num = parseInt(e.target.value) || 15; const v = { ...pomodoroSettings, longBreak: Math.max(1, Math.min(60, num)) }; setPomodoroSettingsState(v); savePomodoroSettings(v); if (!pomodoroState.isRunning && pomodoroState.mode === 'longBreak') setPomodoroState(p => ({ ...p, timeLeft: v.longBreak * 60 })); }} style={{ width: '100%', padding: '6px', borderRadius: '6px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '12px' }} />
              </div>
              <div>
                <label style={{ fontSize: '10px', color: '#64748b' }}>Sessions</label>
                <input type="text" inputMode="numeric" value={pomodoroSettings.sessionsBeforeLong} onChange={e => { const val = e.target.value; const num = parseInt(val); const v = { ...pomodoroSettings, sessionsBeforeLong: val === '' ? '' : (isNaN(num) ? pomodoroSettings.sessionsBeforeLong : num) }; setPomodoroSettingsState(v); }} onBlur={e => { const num = parseInt(e.target.value) || 4; const v = { ...pomodoroSettings, sessionsBeforeLong: Math.max(1, Math.min(10, num)) }; setPomodoroSettingsState(v); savePomodoroSettings(v); }} style={{ width: '100%', padding: '6px', borderRadius: '6px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '12px' }} />
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Add Session Modal */}
      {showAddSession && (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.7)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1100, padding: '20px' }}>
          <div style={{ background: '#1e293b', borderRadius: '12px', padding: '20px', maxWidth: '320px', width: '100%', border: '1px solid rgba(139,92,246,0.3)' }}>
            <h3 style={{ fontSize: '16px', marginBottom: '16px', color: '#f1f5f9' }}>Add Study Session</h3>
            <select value={newSession.subject} onChange={e => setNewSession({ ...newSession, subject: e.target.value })} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '10px', fontSize: '13px' }}>
              <option value="">Select subject...</option>
              {subjects.map(s => (
                <option key={s.id} value={s.id}>{s.icon} {s.name}</option>
              ))}
            </select>
            <input type="date" value={newSession.date} onChange={e => setNewSession({ ...newSession, date: e.target.value })} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '10px', fontSize: '13px' }} />
            <div style={{ display: 'flex', gap: '8px', marginBottom: '10px' }}>
              <div style={{ flex: 1 }}>
                <label style={{ fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px' }}>Start time</label>
                <input type="time" value={newSession.startTime} onChange={e => setNewSession({ ...newSession, startTime: e.target.value })} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '13px' }} />
              </div>
              <div style={{ flex: 1 }}>
                <label style={{ fontSize: '11px', color: '#64748b', display: 'block', marginBottom: '4px' }}>Duration</label>
                <select value={newSession.duration} onChange={e => setNewSession({ ...newSession, duration: parseInt(e.target.value) })} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', fontSize: '13px' }}>
                  <option value={15}>15m</option>
                  <option value={30}>30m</option>
                  <option value={45}>45m</option>
                  <option value={60}>1h</option>
                  <option value={90}>1.5h</option>
                  <option value={120}>2h</option>
                  <option value={180}>3h</option>
                </select>
              </div>
            </div>
            <input placeholder="Notes (optional)" value={newSession.notes} onChange={e => setNewSession({ ...newSession, notes: e.target.value })} style={{ width: '100%', padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '16px', fontSize: '13px' }} />
            <div style={{ display: 'flex', gap: '8px' }}>
              <button onClick={() => setShowAddSession(false)} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', fontSize: '13px', cursor: 'pointer' }}>Cancel</button>
              <button onClick={addSession} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: '#8b5cf6', color: 'white', fontSize: '13px', fontWeight: 600, cursor: 'pointer' }}>Add</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// EXAM COUNTDOWN
function ExamCountdown({ setView }) {
  const [exams, setExamsState] = useState(getExams);
  const [showAdd, setShowAdd] = useState(false);
  const [newExam, setNewExam] = useState({ subject: '', date: '', icon: 'üìù' });

  const addExam = () => {
    if (!newExam.subject || !newExam.date) return;
    const updated = [...exams, { ...newExam, id: Date.now() }];
    setExamsState(updated);
    saveExams(updated);
    setNewExam({ subject: '', date: '', icon: 'üìù' });
    setShowAdd(false);
  };

  const deleteExam = (id) => {
    const updated = exams.filter(e => e.id !== id);
    setExamsState(updated);
    saveExams(updated);
  };

  const getDaysUntil = (date) => {
    const diff = new Date(date) - new Date();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
          <button onClick={() => setView('home')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 16px', color: '#94a3b8', cursor: 'pointer' }}>‚Üê Back</button>
          <h1 style={{ color: '#f1f5f9', fontSize: '20px' }}>üìÖ Exam Countdown</h1>
          <button onClick={() => setShowAdd(true)} style={{ background: '#3b82f6', border: 'none', borderRadius: '8px', padding: '10px 16px', color: 'white', cursor: 'pointer' }}>+ Add</button>
        </div>

        {showAdd && (
          <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '20px', marginBottom: '16px' }}>
            <input placeholder="Subject (e.g., GCSE Biology Paper 1)" value={newExam.subject} onChange={e => setNewExam({ ...newExam, subject: e.target.value })} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <input type="date" value={newExam.date} onChange={e => setNewExam({ ...newExam, date: e.target.value })} style={{ width: '100%', padding: '12px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <div style={{ display: 'flex', gap: '8px' }}>
              <button onClick={() => setShowAdd(false)} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid rgba(100,116,139,0.3)', background: 'transparent', color: '#94a3b8', cursor: 'pointer' }}>Cancel</button>
              <button onClick={addExam} style={{ flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: '#10b981', color: 'white', fontWeight: 600, cursor: 'pointer' }}>Add Exam</button>
            </div>
          </div>
        )}

        {exams.length === 0 ? (
          <div style={{ textAlign: 'center', color: '#64748b', marginTop: '60px' }}>
            <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìÖ</div>
            <p>No exams added yet. Click "+ Add" to add your first exam.</p>
          </div>
        ) : (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
            {exams.sort((a, b) => new Date(a.date) - new Date(b.date)).map(exam => {
              const days = getDaysUntil(exam.date);
              const color = days <= 7 ? '#ef4444' : days <= 30 ? '#f59e0b' : '#10b981';
              return (
                <div key={exam.id} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '12px', padding: '16px', border: `2px solid ${color}30` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <div style={{ color: '#f1f5f9', fontSize: '16px', fontWeight: 500 }}>{exam.subject}</div>
                      <div style={{ color: '#64748b', fontSize: '13px' }}>{new Date(exam.date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' })}</div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ color, fontSize: '24px', fontWeight: 700 }}>{days}</div>
                      <div style={{ color: '#64748b', fontSize: '11px' }}>days</div>
                    </div>
                  </div>
                  <button onClick={() => deleteExam(exam.id)} style={{ marginTop: '12px', padding: '6px 12px', borderRadius: '6px', border: '1px solid rgba(239,68,68,0.3)', background: 'transparent', color: '#f87171', fontSize: '12px', cursor: 'pointer' }}>Remove</button>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

// CREATE DECK (simplified)
function CreateDeck({ setView, openaiKey, user }) {
  const [topic, setTopic] = useState('');
  const [loading, setLoading] = useState(false);
  const [cards, setCards] = useState([]);
  const [deckName, setDeckName] = useState('');

  const generate = async () => {
    if (!topic.trim() || !openaiKey) return;
    setLoading(true);
    try {
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${openaiKey}` },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            { role: 'system', content: 'Generate flashcards. Return ONLY JSON array: [{"category":"...", "front":"question", "back":"answer", "source":"reference"}]' },
            { role: 'user', content: `Create 10 flashcards about: ${topic}` }
          ]
        })
      });
      const data = await res.json();
      let content = data.choices[0].message.content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      setCards(JSON.parse(content));
      setDeckName(topic);
    } catch (e) { alert('Error: ' + e.message); }
    setLoading(false);
  };

  const save = async () => {
    if (!user || !cards.length) return;
    const { data: deck } = await supabase.from('decks').insert({ user_id: user.id, name: deckName, icon: 'üìö', description: `AI deck: ${topic}` }).select().single();
    if (deck) {
      await supabase.from('cards').insert(cards.map(c => ({ deck_id: deck.id, ...c })));
      setView('home');
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: 'linear-gradient(to bottom, #0f172a, #1e293b)', padding: '20px' }}>
      <div style={{ maxWidth: '500px', margin: '0 auto' }}>
        <button onClick={() => setView('home')} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '8px', padding: '10px 16px', color: '#94a3b8', cursor: 'pointer', marginBottom: '20px' }}>‚Üê Back</button>

        {cards.length === 0 ? (
          <div style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '16px', padding: '24px' }}>
            <h2 style={{ color: '#f1f5f9', marginBottom: '16px' }}>‚ú® Create with AI</h2>
            <input placeholder="Enter a topic..." value={topic} onChange={e => setTopic(e.target.value)} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <button onClick={generate} disabled={loading} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: 'none', background: loading ? '#64748b' : '#3b82f6', color: 'white', fontWeight: 600, cursor: 'pointer' }}>{loading ? 'Generating...' : 'Generate Cards'}</button>
          </div>
        ) : (
          <div>
            <input value={deckName} onChange={e => setDeckName(e.target.value)} style={{ width: '100%', padding: '12px', borderRadius: '10px', border: '1px solid rgba(100,116,139,0.3)', background: 'rgba(0,0,0,0.3)', color: '#f1f5f9', marginBottom: '12px' }} />
            <button onClick={save} style={{ width: '100%', padding: '14px', borderRadius: '10px', border: 'none', background: '#10b981', color: 'white', fontWeight: 600, cursor: 'pointer', marginBottom: '16px' }}>Save Deck ({cards.length} cards)</button>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '400px', overflowY: 'auto' }}>
              {cards.map((c, i) => (
                <div key={i} style={{ background: 'rgba(30,41,59,0.9)', borderRadius: '10px', padding: '12px' }}>
                  <div style={{ color: '#60a5fa', fontSize: '11px', marginBottom: '6px' }}>{c.category}</div>
                  <div style={{ color: '#f1f5f9', fontSize: '14px', marginBottom: '6px' }}>{c.front}</div>
                  <div style={{ color: '#94a3b8', fontSize: '12px' }}>{c.back}</div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// RENDER
ReactDOM.createRoot(document.getElementById('root')).render(<AuthProvider><App /></AuthProvider>);
  </script>
</body>
</html>
